<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Cropper.js CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet" />
  <!-- Cropper.js JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - Student Management</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Prevent browser caching of this page
      // Local activity helper - write to same key used by dashboard logger
      (function(){
        function now(){ return new Date().toISOString(); }
        const KEY = 'admin_recent_activity';
        const MAX = 20;
        window.pushLocalActivity = function(text, icon){
          try{
            if (!text) return;
            let arr = [];
            try { arr = JSON.parse(localStorage.getItem(KEY) || '[]') || []; } catch(e){ arr = []; }
            arr.unshift({ text: String(text), ts: now(), icon: icon || 'ðŸ””' });
            try { localStorage.setItem(KEY, JSON.stringify(arr.slice(0,MAX))); } catch(e){}
          } catch(e) { console.debug('pushLocalActivity error', e); }
        };
      })();

      if (window.history && window.history.replaceState) {
        window.history.replaceState(null, '', window.location.href);
      }
      window.addEventListener('pageshow', function(event) {
        if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
          window.location.reload();
        }
      });
    </script>
    <script>
      (function(){ emailjs.init("En395SjR7Jg57-J8u"); /* EmailJS Public Key */ })();
    </script>
    <script type="module">
      import { loadAdminProfileInto, startGreetingClock } from './admin_profile_loader.js';
      loadAdminProfileInto({ greetingSelector: '#topGreetingName', avatarSelector: '.main-top-bar .user-avatar', timeSelector: '#topGreetingTime' });
      startGreetingClock('#topGreetingName', '#topGreetingTime');
    </script>
    <style>
    /* BASE STYLES */
    /* predictable box-sizing and prevent horizontal scrollbar */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { overflow-x: hidden; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f4f7fa;
      color: #333;
    }

    /* Skeleton loader styles (shimmer placeholders for table rows) */
    .skeleton-row .skeleton-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: inline-block;
      background: linear-gradient(90deg, #e9eef0 25%, #f6fbfc 50%, #e9eef0 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.2s linear infinite;
      margin: 0 auto;
    }
    .skeleton-row .skeleton-line {
      height: 12px;
      border-radius: 6px;
      background: linear-gradient(90deg, #e9eef0 25%, #f6fbfc 50%, #e9eef0 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.2s linear infinite;
      display: block;
    }
    .skeleton-row td { padding: 12px 8px; }
    @keyframes skeleton-shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* HEADER & TOP BAR STYLES (Copied from appointment.html) */
        .header-and-sidebar-top {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            background-color: #1e8e3e;
            color: white;
            height: 60px;
            transition: left 0.3s ease;
        }
        
        .sidebar-top {
            width: 250px;
            display: flex;
            align-items: center;
            padding: 10px 20px;
            box-sizing: border-box;
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            height: 60px;
            transition: width 0.3s ease;
        }
        
        .sidebar-top.collapsed {
            width: 80px;
            justify-content: center;
        }
        
        .sidebar-top.collapsed .sidebar-logo {
            opacity: 0;
            pointer-events: none;
            width: 0;
        }
        
        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            transition: opacity 0.3s ease, width 0.3s ease;
        }

        .sidebar-logo img {
            height: 40px;
        }

        .sidebar-logo span {
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
            white-space: nowrap;
        }
        
        .menu-icon {
            cursor: pointer;
            font-size: 24px;
            margin-left: auto;
            transition: all 0.3s ease;
            padding: 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            min-height: 40px;
        }
        
        .menu-icon:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .menu-icon:active {
            transform: scale(0.95);
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .main-top-bar {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 30px; 
        }

        .main-top-bar .portal-title {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }

        .main-top-bar .user-info {
            display: flex;
            align-items: center;
            color: white;
        }

        .main-top-bar .user-info .material-icons {
            margin-right: 10px;
            font-size: 24px;
        }

        .main-top-bar .user-avatar {
            width: 40px;
            height: 40px;
            background-color: white;
            color: #1e8e3e; 
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-left: 10px;
            font-size: 18px;
        }
        
        /* SIDEBAR STYLES (Copied from appointment.html) */
        .sidebar {
            width: 250px;
            background: #f0f3f6;
            border-right: 1px solid rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 60px;
            left: 0;
            height: calc(100vh - 60px);
            z-index: 999;
            overflow: auto;
            transition: width 0.3s ease, transform 0.3s ease;
        }
        
        .nav-menu ul {
            list-style: none;
            padding: 12px;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .nav-item {
            color: #1f2937;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 10px;
            border-radius: 8px;
            border: 0;
            background: transparent;
            cursor: pointer;
            font-weight: 400;
            font-size: 15px;
            transition: background 0.2s, color 0.2s;
            text-align: left;
            width: 100%; /* Ensure button takes full width */
        }
        
        .nav-item:hover {
            background: rgba(15,122,52,0.08) !important;
            color: #0f7a34 !important;
            font-weight: 400 !important;
            border-radius: 8px !important;
        }
        
        .nav-item.active {
            background: rgba(15,122,52,0.12) !important;
            color: #0f7a34 !important;
            font-weight: 600 !important;
        }
        
        .nav-item:hover .icon,
        .nav-item.active .icon {
            color: #1f2937 !important;
        }

        .nav-item .icon {
            width: 28px;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            line-height: 1;
            color: #1f2937;
            transition: color 0.2s;
        }
        
        .nav-item .label {
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            opacity: 1;
            transition: opacity 0.2s, transform 0.2s;
        }

        .sidebar.collapsed {
            width: 80px;
        }
        
        .sidebar.collapsed .nav-item .label {
            display: none;
        }
        
        .sidebar.collapsed .nav-item .icon {
            width: 56px;
            font-size: 26px;
            justify-content: center;
        }
        
        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 12px 6px;
            gap: 0;
        }
        
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 998;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        width: 280px;
        box-shadow: 4px 0 15px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
      }
      .sidebar.mobile-open {
        transform: translateX(0);
      }
      .sidebar.collapsed {
        width: 280px;
        transform: translateX(-100%);
      }
      /* On small screens keep main content full-width and positioned from left:0 */
      .main-content {
        left: 0 !important;
        padding: 20px 15px;
      }
      .card-container {
        padding: 20px 15px !important;
      }
    }
    .main-content {
      position: fixed;
      top: 60px; /* height of header */
      left: 250px; /* space for sidebar */
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: left 0.3s ease;
      min-height: auto;
      background: transparent;
    }

    .main-content.shifted {
      left: 80px; /* when sidebar collapses */
    }
        
        /* Page-specific styles */
        .top-actions { display:flex; align-items:center; gap:12px; }
        /* Filter bar styles: horizontal selects with clear button */
        .filter-row {
          display: flex;
          gap: 10px;
          align-items: center;
          background: #fff;
          padding: 10px;
          border-radius: 10px;
          box-shadow: 0 6px 18px rgba(16,24,40,0.06);
          margin-bottom: 14px;
          flex-wrap: wrap;
        }

        .filter-row select {
          min-width: 160px;
          padding: 8px 10px;
          border-radius: 8px;
          border: 1px solid #e6eef0;
          background: #fff;
          font-size: 14px;
          color: #111;
          box-shadow: none;
          appearance: none;
        }

        /* Protect `#filterCollege` size so edits only change options, not dimensions.
           This sets a conservative fixed width â€” update only if you want a different fixed size. */
        #filterCollege {
          box-sizing: border-box;
          width: 220px !important;
          min-width: 220px !important;
          max-width: 220px !important;
        }

        .filter-row .clear-filters {
          margin-left: auto;
          background: #fff;
          border: 1px solid #e6eef0;
          padding: 8px 12px;
          border-radius: 8px;
          cursor: pointer;
          font-weight: 700;
        }
    .icon-btn {
      background: transparent !important;
      border: 0 !important;
      outline: none !important;
      box-shadow: none !important;
      color: white;
      cursor: pointer;
      padding: 1px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
    }
    .icon-btn:focus, .icon-btn:active {
      outline: none !important;
      border: 0 !important;
      box-shadow: none !important;
    }
        .icon-btn .material-icons { font-size: 36px; }
        
        .search-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
            flex-wrap: wrap;
        }
        #searchInput {
            flex: 1 1 360px;
            max-width: 640px;
            padding: 10px 14px 10px 40px;
            border-radius: 10px;
            border: 1px solid #e6eef0;
            font-size: 15px;
            background: #fff url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%23999"><path d="M11.742 10.344l3.387 3.387-1.398 1.398-3.387-3.387a6.5 6.5 0 1 1 1.398-1.398zM6.5 11a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9z"/></svg>') no-repeat 12px center;
            background-size: 16px;
            box-shadow: inset 0 1px 2px rgba(16,24,40,0.03);
            transition: box-shadow .15s ease, border-color .12s ease, transform .06s;
        }
        #searchInput:focus {
            border-color: #10b981;
            box-shadow: 0 6px 24px rgba(16,185,129,0.12);
            outline: none;
            transform: translateY(-1px);
        }

        .search-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 0 0 auto;
        }
        .add-user-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(16,24,40,0.06);
            transition: transform .08s ease, box-shadow .12s ease, opacity .12s;
        }
        .add-user-btn i { font-size: 14px; }
        .add-user-btn:hover { transform: translateY(-2px); opacity: 0.98; }
        .add-user-btn.upload {
            background: linear-gradient(180deg,#10b981,#059669);
            color: #fff;
        }
        .add-user-btn.upload:hover { box-shadow: 0 10px 32px rgba(6,95,70,0.12); }
        .add-user-btn.email {
            background: linear-gradient(180deg,#2563eb,#1746a2);
            color: #fff;
        }
        .add-user-btn.email:hover { box-shadow: 0 10px 32px rgba(22,64,150,0.12); }

        @media (max-width: 740px) {
            #searchInput { flex-basis: 100%; max-width: 100%; padding-left: 40px; }
            .search-actions { width: 100%; justify-content: flex-end; }
            .add-user-btn { flex: 0 0 auto; }
        }
        
        .switch {
          position: relative;
          display: inline-block;
          width: 46px;
          height: 26px;
          vertical-align: middle;
        }
        .switch input { display: none; }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0; left: 0; right: 0; bottom: 0;
          background-color: #ccc;
          transition: .2s;
          border-radius: 26px;
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 20px;
          width: 20px;
          left: 3px;
          top: 3px;
          background-color: white;
          transition: .2s;
          border-radius: 50%;
          box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .switch input:checked + .slider { background: #10b981; }
        .switch input:checked + .slider:before { transform: translateX(20px); }
        .login-label { font-size:12px; margin-left:8px; vertical-align:middle; color:#333; }
        
        .popover {
            position: absolute;
            right: 20px;
            top: 62px;
            min-width: 280px;
            background: #fff;
            color: #111;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            z-index: 2500;
            display: none;
        }
        .popover[data-open="true"]{ display:block; }
        .popover .popover-header { padding: 10px 12px; border-bottom: 1px solid #eee; font-weight:700; }
        .popover .popover-body { max-height: 240px; overflow:auto; padding: 10px 12px; font-size:14px; }
        .popover .popover-empty { color:#666; padding: 18px 12px; text-align:center; }

        .dropdown {
            position: absolute;
            right: 20px;
            top: 62px;
            background:#fff;
            border-radius:8px;
            box-shadow:0 8px 30px rgba(0,0,0,0.15);
            min-width:180px;
            z-index:2500;
            display:none;
        }
        .dropdown[aria-hidden="false"] { display:block; }
        .dropdown .dropdown-item {
            padding:10px 14px;
            cursor:pointer;
            font-size:14px;
            color:#111;
        }
        .dropdown .dropdown-item:hover { background:#f3f4f6; }
        .profile-label { color:white; margin-left:8px; font-weight:600; }
        @media (max-width:700px) {
          .popover, .dropdown { right: 8px; left: auto; top: 60px; min-width:220px; }
        }
       
        .card-container {
         padding: 30px;
            flex-grow: 1;
        }
        .card {
            background: #fff;
            min-height: 700px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            width: 100%;
            padding: 20px;
            margin: 0 auto;
        }
        .card-title {
             font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }
      
    .table-container {
      /* let the table area take available vertical space and scroll internally
         so the page doesn't scroll; adjust if you need a different height */
      max-height: calc(100vh - 200px);
      overflow-y: auto;
      /* prevent container causing page horizontal scroll */
      overflow-x: hidden;
    }
    .user-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 16px;
      background: #fff;
      table-layout: auto;
      min-width: 0;
    }
        .user-table thead {
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 2;
        }
    .user-table th,
    .user-table td {
      padding: 13px 8px;
      text-align: left;
      /* allow wrapping so table doesn't force horizontal scroll */
      white-space: normal;
      word-break: break-word;
      overflow-wrap: anywhere;
      /* remove per-cell bottom border so we can draw a continuous row border */
      border-bottom: none;
    }
    /* draw the divider on the row to ensure a single continuous line across
       all columns (prevents misalignment in the Actions column) */
    .user-table tbody tr {
      border-bottom: 1px solid #eee;
    }
        .user-table tbody tr:hover {
          background: #d9f5e8;
          cursor: pointer;
          transition: background-color 160ms linear;
        }
        .user-table tbody tr.selected {
          background: #bbf7d0;
          transition: background-color 160ms linear;
        }
        .user-table td { overflow: hidden; text-overflow: ellipsis; }
        .status-enable {
            background: #d6f5e6;
            color: #11824b;
            border-radius: 8px;
            padding: 5px 16px;
            font-size: 15px;
            font-weight: bold;
            display: inline-block;
        }
        .status-disable {
            background: #fff7c2;
            color: #b59d00;
            border-radius: 8px;
            padding: 5px 16px;
            font-size: 15px;
            font-weight: bold;
            display: inline-block;
        }
        .action-icons {
            display: flex;
            gap: 10px;
        }
        .action-icons i {
            font-size: 18px;
            cursor: pointer;
            transition: color 0.2s;
      /* make focus visible for keyboard users */
      outline: none;
        }
    .action-icons i:focus {
      outline: 3px solid rgba(37,99,235,0.18);
      outline-offset: 2px;
    }
        .action-icons .view { color: #2563eb; }
        .action-icons .edit { color: #4caf50; }
        .action-icons .delete { color: #f44336; }
        
        /* Modal CSS */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
    .modal-content.wide {
      max-width: 700px;
      width: 96%;
    }
        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        #csvFile {
            width: 100%;
            margin-bottom: 20px;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-cancel {
            background-color: #cbd5e0;
            color: #4a5568;
        }
        .btn-primary {
            background-color: #1e8e3e;
            color: white;
        }
        
        #processingModal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 2200;
            background: rgba(0,0,0,0.48);
            align-items: center;
            justify-content: center;
            padding: 20px;
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
        }
        #processingModal[aria-hidden="false"] { display: flex; }
        .processing-card {
            width: 420px;
            background: #fff;
            padding: 18px;
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.25);
        }
        #processingTitle {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .processing-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 3px solid #e6e6e6;
            border-top-color: #11824b;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #processingBody {
            max-height: 280px;
            overflow: auto;
            margin-bottom: 12px;
            font-size: 14px;
            color: #222;
        }
        .processing-progress-wrap {
            height: 10px;
            border-radius: 8px;
            background: #f1f5f4;
            overflow: hidden;
            margin-bottom: 12px;
        }
        .processing-actions { text-align: right; margin-top: 12px; }
        #processingCloseBtn {
          display: inline-block;
          padding: 8px 12px;
          border-radius: 8px;
          border: 0;
          cursor: pointer;
          background: #1976d2;
          color: #fff;
          font-weight:700;
        }
        @media (max-width: 520px) {
          #processingModal .processing-card { width: 100%; padding: 14px; border-radius: 10px; }
          #processingTitle { font-size: 16px; }
          #processingBody { max-height: 60vh; }
        }
        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-10px); }
          to { opacity: 1; transform: translateY(0); }
        }
        
        .sidebar-footer {
            margin-top: auto;
            padding: 12px;
        }
        /* Footer button styling: keep icon visible, hide label when collapsed */
        .sidebar-footer .nav-item { display:flex; align-items:center; gap:12px; padding:10px; border-radius:8px; }
        .sidebar-footer .nav-item .label { transition: opacity 0.15s ease; }
        .sidebar.collapsed .sidebar-footer .nav-item .label { display:none; }
        /* Ensure footer stays above overlay and doesn't block menu icon */
        .sidebar-footer { z-index: 1000; }
        
    /* Profile dropdown styles (shared across pages) */
    .profile-dropdown .profile-card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 12px 34px rgba(2,6,23,0.12), 0 4px 10px rgba(2,6,23,0.06);
      overflow: hidden;
      animation: fadeIn .12s ease;
      transition: transform .14s ease, box-shadow .14s ease, opacity .12s ease;
      transform-origin: top right;
    }
    .profile-card-top { display:flex; justify-content:center; padding:14px 12px 6px; }
    .avatar-large {
      width: 120px; height:120px; border-radius:50%; background:#f3faf5; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:32px; position:relative; overflow:hidden; border:4px solid rgba(16,185,129,0.06);
    }
    .avatar-large img { width:100%; height:100%; object-fit:cover; display:block; transition: transform .18s ease; box-shadow: 0 6px 18px rgba(2,6,23,0.08); }
    .avatar-large:hover img { transform: scale(1.02); }
    .avatar-camera { position:absolute; right:6px; bottom:6px; border-radius:50%; background:#fff; border:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 12px rgba(2,6,23,0.06); cursor:pointer; font-size:13px; }
    .profile-card-body { padding: 10px 18px 16px; text-align:center; display:flex; flex-direction:column; gap:8px; }
    .profile-email { font-size:13px; color:#6b7280; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .profile-greeting { font-weight:700; font-size:18px; margin-top:4px; color:#111827; }
    .manage-btn { display:inline-block; width:100%; padding:10px 12px; border-radius:999px; border:1px solid rgba(16,185,129,0.12); background:#10b981; color:#fff; font-weight:700; box-shadow:none; cursor:pointer; }
    .manage-btn:hover { transform:none; filter:brightness(.98); }
    .profile-divider { height:1px; background:#f1f5f9; margin:8px 0; }
    .profile-actions { display:flex; justify-content:space-between; gap:12px; align-items:center; }
    .profile-link { flex:1; text-align:left; border:0; background:transparent; padding:8px; color:#374151; font-weight:600; cursor:pointer; }
    .signout-link { flex:1; text-align:right; border:0; background:transparent; padding:8px; color:#ef4444; font-weight:700; cursor:pointer; }
    @media (max-width:420px) { .profile-dropdown { right:8px !important; left:8px !important; min-width:auto; } }
    .profile-dropdown[aria-hidden="false"] .profile-card { transform: translateY(-6px); box-shadow: 0 20px 54px rgba(2,6,23,0.16), 0 6px 18px rgba(2,6,23,0.06); }

    /* Pagination styles (inserted) */
    .pagination-container { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:12px; padding:10px 6px; background:transparent; }
    .pagination-info { color:#111827; font-size:13px; }
    .pagination-controls { display:flex; gap:8px; align-items:center; }
    .pagination-controls button { padding:6px 10px; border-radius:8px; border:1px solid #e6eef0; background:#fff; cursor:pointer; min-width:36px; height:32px; display:inline-flex; align-items:center; justify-content:center; }
    .pagination-controls button.active { background:#10b981; color:#fff; border-color:#10b981; box-shadow:0 6px 18px rgba(16,185,129,0.12); }
    .pagination-controls button[disabled] { opacity:0.46; cursor:not-allowed; }
    .icon-btn { background: transparent; border: 0; padding: 6px; display: inline-flex; align-items: center; justify-content: center; color: white; cursor: pointer; }
    .icon-btn:focus { outline: 2px solid rgba(255,255,255,0.18); }

    /* popover / dropdown visibility controlled by attributes */
    .popover { display: none; }
    .popover[data-open="true"] { display: block; }
    .dropdown { display: none; }
    .dropdown[aria-hidden="false"] { display: block; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    /* Make sidebar logout text/icon red on hover/focus and keyboard focus
       - add smooth transition, use :focus-visible for keyboard focus, and show pointer */
    #sidebarLogoutBtn { cursor: pointer; }
    #sidebarLogoutBtn .label, #sidebarLogoutBtn .icon {
        color: inherit;
        transition: color 160ms ease-in-out, transform 120ms ease;
    }
    /* Hover and focus (mouse) */
    #sidebarLogoutBtn:hover .label,
    #sidebarLogoutBtn:hover .icon {
        color: #ef4444 !important; /* red text/icon on hover */
    }
    /* Keyboard focus visible for accessibility */
    #sidebarLogoutBtn:focus-visible .label,
    #sidebarLogoutBtn:focus-visible .icon {
        color: #ef4444 !important; /* red text/icon on keyboard focus */
    }
    </style>
</head>
<body>
    <div class="header-and-sidebar-top">
      <aside class="sidebar-top" id="sidebarTop">
        <div class="sidebar-logo">
          <img src="safespace.png" alt="SafeSpace Logo">
          <span>SafeSpace</span>
        </div>
        <i class="material-icons menu-icon" id="menuIcon">menu</i>
      </aside>
      <header class="main-top-bar">
        <h1 class="portal-title">Admin Portal</h1>
        <div class="user-info">
          <div class="top-greeting" aria-live="polite" style="margin-right:12px; text-align:right; color:#fff; margin-left:8px;">
            <div id="topGreetingName" style="font-weight:700; font-size:14px;">Good Morning, Admin</div>
            <div id="topGreetingTime" style="font-size:12px; opacity:0.95; margin-top:2px;">Tuesday, Oct 14, 2025 â€” 02:51 AM</div>
          </div>
          <div style="position:relative;display:inline-block;">
            <button id="notifBtn" class="icon-btn" aria-expanded="false" title="Notifications" style="color:white;padding:8px;border:none;border:0;display:inline-flex;align-items:center;justify-content:center;box-shadow:none;">
              <i class="material-icons" style="color:white;font-size:20px;border:none;outline:none;background:transparent;">notifications</i>
            </button>
            <div id="notifPanel" class="popover" data-open="false" style="position:fixed;right:20px;top:62px;min-width:280px;z-index:4500;display:none;">
                  <div class="notif-card" role="dialog" aria-label="Notifications" aria-hidden="true" style="border-radius:10px;overflow:hidden;box-shadow:0 12px 30px rgba(2,6,23,0.08);background:#fff;font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-width:280px;">
                    <div class="notif-header popover-header" style="background:#10b981;color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;">
                      <div class="notif-title" style="font-weight:700;font-size:15px;">Notifications</div>
                      <div class="notif-controls" style="display:inline-flex;gap:8px;align-items:center;">
                        <button id="usersMarkAll" type="button" style="background:transparent;border:0;color:#2563eb;cursor:pointer;font-size:13px;padding:4px 6px;border-radius:6px">Mark all read</button>
                        <button id="usersClearAll" type="button" style="background:transparent;border:0;color:#ef4444;cursor:pointer;font-size:13px;padding:4px 6px;border-radius:6px">Clear</button>
                      </div>
                    </div>
                    <div class="notif-body" style="padding:14px 16px;color:#111827;">
                    </div>
                      <div id="notifList" class="popover-body" style="color:#111827;padding:8px 12px;">
                        <div class="popover-empty">No new notifications.</div>
                      </div>
                  </div>
                </div>
          </div>
          <div style="position:relative;display:inline-block;margin-left:-8px;">
            <button id="profileBtn" class="user-avatar" aria-haspopup="true" aria-expanded="false" title="Profile" style="border:0;cursor:pointer;padding:0;position:relative;overflow:hidden;">
              <div id="profileBtnSpinner" style="position:absolute;inset:0;display:none;align-items:center;justify-content:center;pointer-events:none">
                <svg width="28" height="28" viewBox="0 0 50 50" aria-hidden="true">
                  <circle cx="25" cy="25" r="18" fill="#ffffff" opacity="0.2"></circle>
                  <path fill="#10B981" d="M25 5a20 20 0 0 1 0 6a14 14 0 1 0 0 28 14 14 0 0 1 0-34">
                    <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite" />
                  </path>
                </svg>
              </div>
              <div id="profileBtnDefaultIcon" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none">
                <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5z" fill="#9CA3AF"></path>
                  <path d="M3 20c0-2.761 4.477-5 9-5s9 2.239 9 5v1H3v-1z" fill="#9CA3AF"></path>
                </svg>
              </div>
            </button>

            <div id="profileDropdown" class="dropdown profile-dropdown" aria-hidden="true" style="position:fixed;right:20px;top:62px;min-width:320px;z-index:3000;">
              <div style="background:#fff;border-radius:12px;padding:10px;min-width:320px;box-shadow:0 12px 30px rgba(2,6,23,0.12);font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111;">
                <div style="display:flex;gap:12px;align-items:center;padding:10px;border-bottom:1px solid rgba(0,0,0,0.06)">
                  <div class="avatar-large" id="profileAvatar" style="width: 80px;height:80px;border-radius:60px;overflow:hidden;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-weight:700;color:#111;font-size:18px"></div>
                  <div style="flex:1;min-width:0">
                    <div id="profileGreeting" style="font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Hi, Admin</div>
                    <div id="profileEmail" style="font-size:13px;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">you@example.com</div>
                  </div>
                </div>
                <div style="padding:8px 6px;display:flex;flex-direction:column;gap:6px">
                  <button id="accountEdit" class="profile-item" style="text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;cursor:pointer;display:flex;align-items:center;gap:10px">
                    <i class="material-icons icon" style="font-size:18px;line-height:1;">person</i>
                    <span style="flex:1;text-align:left">Manage your profile</span>
                  </button>
                  <button id="accountSettings" class="profile-item" style="text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;cursor:pointer;display:flex;align-items:center;gap:10px">
                    <i class="material-icons icon" style="font-size:18px;line-height:1;">settings</i>
                    <span style="flex:1;text-align:left">Settings & privacy</span>
                    <i class="material-icons icon" style="font-size:16px;opacity:0.7;">chevron_right</i>
                  </button>
                  <button id="accountLogout" class="profile-item" style="text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;cursor:pointer;display:flex;align-items:center;gap:10px;color:#111;font-weight:600">
                    <i class="material-icons icon" style="font-size:18px;line-height:1;color:#ef4444">logout</i>
                    <span style="flex:1;text-align:left">Log Out</span>
                  </button>
                </div>
              </div>
              <script>
                // Wire the notification header controls to global helpers
                (function(){
                  function onReady(fn){ if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn); else fn(); }
                  onReady(function(){
                    const markBtn = document.getElementById('usersMarkAll');
                    const clearBtn = document.getElementById('usersClearAll');
                    if (markBtn) markBtn.addEventListener('click', async function(e){ e.preventDefault(); try { if (typeof window.markAllNotificationsRead === 'function') { await window.markAllNotificationsRead(); if (typeof window.showToast === 'function') window.showToast('All notifications marked read'); } } catch(err){ console.debug('mark all read failed', err); if (typeof window.showToast === 'function') window.showToast('Unable to mark read'); } });
                    if (clearBtn) clearBtn.addEventListener('click', async function(e){ e.preventDefault(); if (!confirm('Clear all notifications?')) return; try { if (typeof window.clearAllNotifications === 'function') { await window.clearAllNotifications(); if (typeof window.showToast === 'function') window.showToast('Notifications cleared'); } } catch(err){ console.debug('clear all failed', err); if (typeof window.showToast === 'function') window.showToast('Unable to clear'); } });
                  });
                })();
              </script>
            </div>
          <div id="settingsPanel" style="display:none; position:fixed; top:80px; right:40px; width:360px; max-width:calc(100% - 48px); background:#fff; box-shadow:0 8px 30px rgba(0,0,0,0.12); border-radius:8px; z-index:3200; padding:12px;">
            <div id="settingsBackRow" style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
              <button id="settingsBackBtn" style="border:0;background:transparent;cursor:pointer;font-weight:700;color:#374151">â—€ Back</button>
              <h3 id="settingsTitle" style="margin:0; font-size:16px; color:#111827">Settings</h3>
            </div>
            <div id="settingsList">
              <!-- Accordion UI -->
              <div style="margin-bottom:12px;">
                <button class="w-full flex justify-between items-center p-2 bg-gray-100 rounded info-toggle" style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#f3f4f6;border-radius:6px;border:0;width:100%;">
                  <span style="font-weight:700;color:#111827">Info / Legal</span>
                  <span class="info-chevron" style="transform:rotate(0);transition:transform .2s">â–¼</span>
                </button>
                <div class="mt-1 info-content" style="margin-top:8px;display:none;">
                  <button class="settings-item" data-key="faq" style="display:block;width:100%;text-align:left;padding:10px;border:1px solid #e6eef0;border-radius:6px;margin-bottom:6px;background:#fff;">FAQ</button>
                  <button class="settings-item" data-key="privacy" style="display:block;width:100%;text-align:left;padding:10px;border:1px solid #e6eef0;border-radius:6px;margin-bottom:6px;background:#fff;">Privacy Policy</button>
                  <button class="settings-item" data-key="terms" style="display:block;width:100%;text-align:left;padding:10px;border:1px solid #e6eef0;border-radius:6px;background:#fff;">Terms & Conditions</button>
                </div>
              </div>
              <div>
                <button class="w-full flex justify-between items-center p-2 bg-gray-100 rounded account-toggle" style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#f3f4f6;border-radius:6px;border:0;width:100%;">
                  <span style="font-weight:700;color:#111827">Account</span>
                  <span class="account-chevron" style="transform:rotate(0);transition:transform .2s">â–¼</span>
                </button>
                <div class="mt-1 account-content" style="margin-top:8px;display:none;">
                  <button class="settings-item" data-key="profile" style="display:block;width:100%;text-align:left;padding:10px;border:1px solid #e6eef0;border-radius:6px;margin-bottom:6px;background:#fff;">Profile Information</button>
                  <button class="settings-item" data-key="notifications" style="display:block;width:100%;text-align:left;padding:10px;border:1px solid #e6eef0;border-radius:6px;margin-bottom:6px;background:#fff;">Notification Settings</button>
                  <button class="settings-item" data-key="privacy-security" style="display:block;width:100%;text-align:left;padding:10px;border:1px solid #e6eef0;border-radius:6px;margin-bottom:6px;background:#fff;">Privacy & Security</button>
                  <button id="settingsLogout" style="display:block;width:100%;text-align:left;padding:10px;border:1px solid #fde2e2;border-radius:6px;background:#fff;color:#dc2626;">Log Out</button>
                </div>
              </div>
            </div>
            <div id="settingsContent" style="display:none;margin-top:8px;">
              <!-- Dynamic content will be injected here -->
            </div>
          </div>
              </div>
            </div>
            <script>
              // Defensive fallback: ensure profile button toggles dropdown even if other scripts fail
              (function(){
                try {
                  const p = document.getElementById('profileBtn');
                  const d = document.getElementById('profileDropdown');
                  if (!p || !d) return;
                  if (p._safeProfileAdded) return; p._safeProfileAdded = true;
                  p.addEventListener('click', function(ev){
                    try {
                      ev.stopPropagation();
                      const open = d.getAttribute('aria-hidden') === 'false';
                      d.setAttribute('aria-hidden', open ? 'true' : 'false');
                      p.setAttribute('aria-expanded', (!open).toString());
                    } catch(e){ console.debug('safe profile toggle error', e); }
                  });
                } catch(e) { console.debug('safe profile attach error', e); }
              })();
            </script>
          </div>
        </div>
      </header>
    </div>

    <div class="container">
        <aside class="sidebar" id="sidebar">
            <nav class="nav-menu">
                <div class="nav" id="nav" style="display:flex;flex-direction:column;gap:8px;padding:12px;">
                    <button class="nav-item" onclick="location.href='admin_dashboard.html'" data-name="Dashboard">
                        <span class="material-icons icon" style="font-size:26px;">dashboard</span>
                        <span class="label" style="font-size:15px;">Home</span>
                    </button>
                    <button class="nav-item active" onclick="location.href='admin_user_management.html'" data-name="User Management">
                        <span class="material-icons icon" style="font-size:26px;">groups</span>
                        <span class="label" style="font-size:15px;">Student Management</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_counselor_management.html'" data-name="Counselor Management">
                        <span class="material-icons icon" style="font-size:26px;">psychology</span>
                        <span class="label" style="font-size:15px;">Counselor Management</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_content_management.html'" data-name="Content Management">
                        <span class="material-icons icon" style="font-size:26px;">description</span>
                        <span class="label" style="font-size:15px;">Content Management</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_report_management.html'" data-name="Reports Management">
                        <span class="material-icons icon" style="font-size:26px;">warning</span>
                        <span class="label">Reports Management</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_session_report.html'" data-name="Session Reports">
                        <span class="material-icons icon" style="font-size:26px;">fact_check</span>
                        <span class="label">Session Reports</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_psych_test.html'" data-name="Session Reports">
                        <span class="material-icons icon" style="font-size:26px;">assessment</span>
                        <span class="label">Psychological Test</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_settings.html'" data-name="System Settings">
                        <span class="material-icons icon" style="font-size:26px;">settings</span>
                        <span class="label" style="font-size:15px;">System Settings</span>
                    </button>
                </div>
            </nav>
      <div class="sidebar-footer">
        <button class="nav-item" id="sidebarLogoutBtn" type="button" title="Sign out">
          <i class="material-icons icon" style="font-size:26px;">logout</i>
          <span class="label" style="font-size:15px;">Logout</span>
        </button>
      </div>
        </aside>
        <main class="main-content" id="mainContent">
            <div class="card-container">
                <div class="card">
                    <div class="card-title">Student Management</div>
                    <div class="search-row">
                        <input id="searchInput" type="text" placeholder="Search users..." aria-label="Search users" />
                        <div class="search-actions">
                            <button type="button" class="add-user-btn upload" id="openUploadModal"><i class="fa fa-upload"></i> Upload CSV</button>
                            <button type="button" class="add-user-btn email" id="massEmail"><i class="fa fa-envelope"></i> Send Verification</button>
                        </div>
                    </div>
                    <!-- Filter row: campuses / colleges / courses / years / genders / PWD -->
                    <div class="filter-row" role="region" aria-label="Filters">
                      <select id="filterCampus" aria-label="Campus filter">
                        <option value="">All campuses</option>
                        <option value="Main Campus">Main Campus</option>
                        <option value="Cajidiocan Campus">Cajidiocan Campus</option>
                        <option value="San Fernando Campus">San Fernando Campus</option>
                        <option value="Romblon Campus">Romblon Campus</option>
                        <option value="San Agustin Campus">San Agustin Campus</option>
                        <option value="Sta. Maria Campus">Sta. Maria Campus</option>
                        <option value="Sta. Fe Campus">Sta. Fe Campus</option>
                        <option value="Calatrava Campus">Calatrava Campus</option>
                      </select>
                      <select id="filterCollege" aria-label="College filter">
                        <option value="">All colleges</option>
                      </select>
                      <select id="filterCourse" aria-label="Course filter">
                        <option value="">All courses</option>
                      </select>
                      <select id="filterYear" aria-label="Year filter">
                        <option value="">All Years</option>
                        <option value="1st Year">1st Year</option>
                        <option value="2nd Year">2nd Year</option>
                        <option value="3rd Year">3rd Year</option>
                        <option value="4th Year">4th Year</option>
                      </select>
                      <select id="filterGender" aria-label="Gender filter">
                        <option value="">All genders</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                      </select>
                      <select id="filterPWD" aria-label="PWD filter">
                        <option value="">All (PWD/Non-PWD)</option>
                        <option value="pwd">PWD</option>
                        <option value="nonpwd">Non-PWD</option>
                      </select>
                      <button class="clear-filters" id="clearFilters">Clear</button>
                    </div>
                    <div class="table-container">
                        <table class="user-table">
                            <thead>
                <tr>
                  <th>Photo</th>
                  <th>Student ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Course</th>
                  <th>Role</th>
                  <th>Login</th>
                  <th>Action</th>
                </tr>
                            </thead>
                            <tbody id="userTableBody">
                                </tbody>
                        </table>
                    </div>
                    <!-- Pagination: showing X to Y of Z and page controls -->
                    <div class="pagination-container" aria-label="Table pagination">
                      <div id="paginationInfo" class="pagination-info">Showing 0 to 0 of 0 entries</div>
                      <div id="paginationControls" class="pagination-controls" role="navigation" aria-label="Pagination controls"></div>
                    </div>
                </div>
            </div>

            <div class="modal" id="uploadModal" aria-hidden="true">
                <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="uploadModalLabel">
                    <div class="modal-header" id="uploadModalLabel">Upload CSV File</div>
                    <input type="file" id="csvFile" accept=".csv" />
                    <div id="uploadMessage" style="margin-top:8px;font-size:14px;color:#b91c1c;min-height:18px;"></div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-cancel" id="cancelUpload">Cancel</button>
                        <button type="button" class="btn btn-primary" id="confirmUpload">Upload</button>
                    </div>
                </div>
            </div>
        <!-- Confirmation Modal for Send Verification -->
        <div class="modal" id="confirmSendModal" aria-hidden="true">
          <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="confirmSendLabel">
            <div class="modal-header" id="confirmSendLabel">Confirm</div>
            <div style="margin-bottom:18px;font-size:16px;">Are you sure you want to send verification emails to all pending students?</div>
            <div class="modal-actions">
              <button type="button" class="btn btn-cancel" id="cancelSendVerification">Cancel</button>
              <button type="button" class="btn btn-primary" id="confirmSendVerification">Send</button>
            </div>
          </div>
        </div>

    <script>
      // Wire up Clear Filters button to reset selects and notify listeners
      (function(){
        function resetFilters(){
          const ids = ['filterCampus','filterCollege','filterCourse','filterYear','filterGender','filterPWD'];
          ids.forEach(id=>{
            const el = document.getElementById(id);
            if(el) el.value = '';
          });
          // Dispatch a custom event so other scripts can re-filter/load data
          window.dispatchEvent(new CustomEvent('filtersCleared'));
        }

        document.addEventListener('DOMContentLoaded', function(){
          const btn = document.getElementById('clearFilters');
          if(btn) btn.addEventListener('click', resetFilters);
        });
      })();
    </script>

    <script>
      // Global table filtering utility used by multiple scripts
      (function(){
        function norm(v){ return (v===undefined||v===null)?'':String(v).trim().toLowerCase(); }

        window.applyTableFilters = function(){
          try{
            const campus = norm(document.getElementById('filterCampus')?.value);
            const college = norm(document.getElementById('filterCollege')?.value);
            const course = norm(document.getElementById('filterCourse')?.value);
            const year = norm(document.getElementById('filterYear')?.value);
            const gender = norm(document.getElementById('filterGender')?.value);
            const pwd = norm(document.getElementById('filterPWD')?.value);
            const q = norm(document.getElementById('searchInput')?.value);
            const tbody = document.getElementById('userTableBody');
            if(!tbody) return;
            let visible = 0;
            for(const row of Array.from(tbody.rows)){
              const rcamp = norm(row.dataset.campus);
              const rcollege = norm(row.dataset.college);
              const rcourse = norm(row.cells[4]?.textContent || row.dataset.course || '');
              const ryear = norm(row.dataset.year || row.dataset.yearlevel || '');
              const rgender = norm(row.dataset.gender || '');
              const rpwd = norm(row.dataset.pwd || '');

              // Filter checks: empty filter => pass
              const passCampus = !campus || rcamp === campus;
              const passCollege = !college || rcollege === college;
              const passCourse = !course || rcourse.indexOf(course) !== -1 || rcourse === course;
              const passYear = !year || ryear === year;
              const passGender = !gender || rgender === gender;
              const passPwd = !pwd || rpwd === pwd;

              // Search query: check first 6 columns and dataset attributes
              let passSearch = true;
              if(q){
                const texts = Array.from(row.cells).slice(0,6).map(c => (c.textContent||'').toLowerCase());
                // include dataset searchable fields
                texts.push(rcamp, rcollege, rcourse, ryear, rgender, rpwd);
                passSearch = texts.some(t => t.indexOf(q) !== -1);
              }

              const show = passCampus && passCollege && passCourse && passYear && passGender && passPwd && passSearch;
              row.style.display = show ? '' : 'none';
              if(show) visible++;
            }
            // update pagination info if present
            const info = document.getElementById('paginationInfo');
            if(info) info.textContent = `Showing ${visible} entries`;
          }catch(e){ console.debug && console.debug('applyTableFilters error', e); }
        };

        // Wire selects to filtering
        document.addEventListener('DOMContentLoaded', function(){
          const ids = ['filterCampus','filterCollege','filterCourse','filterYear','filterGender','filterPWD'];
          ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('change', window.applyTableFilters);
          });
          // react to the Clear Filters dispatch
          window.addEventListener('filtersCleared', window.applyTableFilters);
        });
      })();
    </script>


      <div class="modal" id="viewEditModal" aria-hidden="true">
  <div class="modal-content wide" role="dialog" aria-modal="true" aria-labelledby="viewEditLabel">
    <div class="modal-header" id="viewEditLabel">View / Edit User</div>
    <form id="ve_userForm" style="margin:0;">
      <div class="photo-section" style="margin-bottom:18px;">
        <label class="photo-label" style="font-weight:600;margin-bottom:6px;">Photo</label>
        <div class="photo-upload-area" style="display:flex;align-items:center;gap:16px;">
          <img id="ve_photoPreview" alt="Preview" class="photo-preview-img" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:1px solid #e5e7eb;" src="">
          <div class="file-input-wrapper" style="display:flex;flex-direction:column;gap:4px;">
            <label for="photo_url" class="file-input-label" style="cursor:pointer;color:#1976d2;font-weight:600;">Change Photo</label>
            <span class="file-status" id="ve_fileStatus">No file chosen</span>
            <input id="photo_url" type="file" accept="image/*" style="display:none;">
            <!-- Cropper Modal -->
            <div id="cropperModal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;">
              <div style="background:#fff;padding:24px;border-radius:10px;max-width:90vw;max-height:90vh;display:flex;flex-direction:column;align-items:center;">
                <div style="max-width:400px;max-height:400px;overflow:auto;">
                  <img id="cropperImage" style="max-width:100%;max-height:400px;" />
                </div>
                <div style="margin-top:16px;display:flex;gap:12px;">
                  <button id="cropperCancelBtn" type="button">Cancel</button>
                  <button id="cropperCropBtn" type="button" style="background:#1976d2;color:#fff;padding:6px 18px;border:none;border-radius:5px;">Crop & Save</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="photo-hint" style="font-size:12px;color:#666;margin-top:4px;">Change photo (optional).</div>
      </div>
      <div class="ve-fields-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <input type="hidden" id="ve_studentId" />
        <div><label for="ve_firstName">First name <span style="color:#e53935;">*</span></label><input id="ve_firstName" type="text" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;" /></div>
        <div><label for="ve_lastName">Last name <span style="color:#e53935;">*</span></label><input id="ve_lastName" type="text" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;" /></div>
        <div><label for="ve_middle">Middle initial</label><input id="ve_middle" type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;" /></div>
       <div><label for="ve_middle">Middle initial</label><input id="ve_middle" type="text" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;" /></div>
        <div><label for="ve_email">Email <span style="color:#e53935;">*</span></label><input id="ve_email" type="email" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;" /></div>
        <div><label for="ve_course">Course <span style="color:#e53935;">*</span></label><input id="ve_course" type="text" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;" /></div>
        <div><label for="ve_role">Role <span style="color:#e53935;">*</span></label><input id="ve_role" type="text" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;" /></div>
        <div style="grid-column:span 2;">
          <label for="ve_login">Login <span style="color:#e53935;">*</span></label>
          <select id="ve_login" required style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;">
            <option value="Enable">Enable</option>
            <option value="Disable">Disable</option>
          </select>
        </div>
      </div>
      <div class="modal-actions" style="margin-top:24px;display:flex;justify-content:flex-end;gap:12px;">
        <button type="button" class="btn btn-cancel" id="ve_closeBtn">Close</button>
        <button type="submit" class="btn btn-primary" id="ve_saveBtn" style="display:none;">Save</button>
      </div>
    </form>
  </div>
      </div>

            <div class="processing-modal" id="processingModal" aria-hidden="true">
                <div class="processing-card" role="dialog" aria-modal="true" aria-labelledby="processingTitle">
                    <div id="processingTitle">
                        <span class="processing-spinner"></span>
                        Sending emails...
                    </div>
                    <div id="processingBody">
                        <div class="processing-progress-wrap">
                          <div id="processingProgress" style="width:0%;height:100%;background:linear-gradient(90deg,#10b981,#11824b);"></div>
                        </div>
                        <div id="processingSummary">Preparing...</div>
                        <div id="processingLines"></div>
                    </div>
                    <div class="processing-actions">
                        <button id="processingCloseBtn" type="button">Close</button>
                    </div>
                </div>
            </div>

            <div class="modal" id="messageModal" aria-hidden="true">
                <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="messageModalLabel">
                    <div class="modal-header" id="messageModalLabel">Notice</div>
                    <div id="messageModalBody" style="min-height:18px;margin-top:6px;margin-bottom:12px;"></div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-primary" id="messageModalOk">OK</button>
                    </div>
                </div>
            </div>

            <div class="modal" id="confirmModal" aria-hidden="true">
                <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="confirmModalLabel">
                    <div class="modal-header" id="confirmModalLabel">Confirm</div>
                    <div id="confirmModalBody" style="min-height:18px;margin-top:6px;margin-bottom:12px;"></div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-cancel" id="confirmModalNo">No</button>
                        <button type="button" class="btn btn-primary" id="confirmModalYes">Yes</button>
                    </div>
                </div>
            </div>

            <!-- Image viewer modal -->
            <div id="imgViewerModal" style="display:none;position:fixed;z-index:4000;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;">
              <div style="position:relative;max-width:90vw;max-height:90vh;">
                <img id="imgViewerImg" src="" alt="Photo" style="max-width:90vw;max-height:90vh;border-radius:10px;box-shadow:0 8px 32px #0008;display:block;" />
                <button id="imgViewerClose" style="position:absolute;top:8px;right:8px;background:#fff;border-radius:50%;border:0;width:36px;height:36px;font-size:22px;cursor:pointer;box-shadow:0 2px 8px #0004;">&times;</button>
              </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Use the already-initialized Firebase app from main.js and import DB helpers
  // Reuse the initialized Firebase instances and helpers from admin_main.js
  import { db, ref, get, set, remove, update, getStorage, storageRef, getDownloadURL, requireAdminAuth, createNotification, broadcastNotification } from './admin_main.js';

  // Protect this page â€” only admins may access
  requireAdminAuth();
        
        function cleanKeys(row) {
          const cleaned = {};
          for (let key in row) {
            if (!Object.prototype.hasOwnProperty.call(row, key)) continue;
            const normalizedKey = key.trim().replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_]/g, "").toLowerCase();
            const val = row[key];
            cleaned[normalizedKey] = (typeof val === "string") ? val.trim() : val;
          }
          return cleaned;
        }
        
        // Helper: show skeleton rows while data is loading
        function showTableSkeleton(count = 8) {
          const tableBody = document.getElementById("userTableBody");
          if (!tableBody) return;
          const rows = [];
          for (let i = 0; i < count; i++) {
            rows.push(`
              <tr class="skeleton-row" aria-hidden="true">
                <td style="width:64px;padding:8px;text-align:center;"><span class="skeleton-avatar"></span></td>
                <td class="student-id"><span class="skeleton-line" style="width:80px"></span></td>
                <td><span class="skeleton-line" style="width:180px"></span></td>
                <td><span class="skeleton-line" style="width:160px"></span></td>
                <td><span class="skeleton-line" style="width:140px"></span></td>
                <td><span class="skeleton-line" style="width:80px"></span></td>
                <td><span class="skeleton-line" style="width:90px"></span></td>
                <td></td>
              </tr>
            `);
          }
          tableBody.innerHTML = rows.join('');
        }

        function hideTableSkeleton() {
          // No-op here; main fetch function will clear and populate rows when available
        }

        async function fetchAndDisplayUsers() {
          const tableBody = document.getElementById("userTableBody");
          if (!tableBody) return;
          const previousHtml = tableBody.innerHTML;
          // show placeholders while fetching
          showTableSkeleton(8);
          try {
            const snapshot = await get(ref(db, "students"));
            if (!snapshot.exists()) {
              tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:20px;color:#666">No students found.</td></tr>`;
              return;
            }
            const users = snapshot.val();
            tableBody.innerHTML = "";
            for (const studentId in users) {
              const user = users[studentId] || {};
              const firstName = user.first_name ?? user.First_Name ?? user.firstname ?? user.FirstName ?? "";
              const lastName  = user.last_name ?? user.Last_Name  ?? user.lastname  ?? user.LastName  ?? "";
              const middle    = user.middle_initial ?? user.Middle_Initial ?? user.middle_initials ?? user.mi ?? "";
              const fullName = `${lastName}, ${firstName} ${middle}`.replace(/\s+/g, " ").trim();
              const email = user.email_address ?? user.Email_Address ?? user.email ?? user.Email ?? "";
              const course = user.course ?? user.Course ?? user.course_of_study ?? user["Course"] ?? "";
              const role = user.role ?? user.Role ?? "";
              const login = (user.login ?? user.Login ?? "").toString();
              function findPhotoField(obj) {
                if (!obj) return "";
                const keys = Object.keys(obj);
                for (const k of ['photo_url','photoURL','photoUrl','photo_path','photo']) if (k in obj) return obj[k];
                for (const k of keys) { if (/photo_url/i.test(k)) return obj[k]; }
                return "";
              }
              const photoUrl = findPhotoField(user) || "";
              const initials = ((firstName || "").charAt(0) + (lastName || "").charAt(0)).toUpperCase();
              let resolvedPhotoUrl = photoUrl || "";
              if (resolvedPhotoUrl) {
                try {
                  if (/^data:/i.test(resolvedPhotoUrl)) {
                    console.debug('Using data URL photo for', studentId);
                  } else if (/^https?:\/\//i.test(resolvedPhotoUrl)) {
                    console.debug('Using http(s) photo URL for', studentId);
                  } else {
                    const storage = getStorage();
                    try {
                      const sref = storageRef(storage, resolvedPhotoUrl);
                      resolvedPhotoUrl = await getDownloadURL(sref);
                      console.debug('Resolved storage photo for', studentId, '->', resolvedPhotoUrl);
                    } catch (storageErr) {
                      console.debug('Failed to resolve storage photo for', studentId, resolvedPhotoUrl, storageErr);
                      resolvedPhotoUrl = "";
                    }
                  }
                } catch (err) {
                  console.debug('Error while resolving photo URL for', studentId, resolvedPhotoUrl, err);
                  resolvedPhotoUrl = "";
                }
              }

              const tr = document.createElement("tr");
              tr.dataset.id = studentId;
              try {
                const campusVal = user.campus || user.Campus || user.campuses || user.campus_name || '';
                const collegeVal = user.college || user.College || user.college_name || '';
                const genderVal = user.gender || user.Gender || user.sex || '';
                const yearVal = user.year_level || user.yearlevel || user.year ||  '';
                const pwdCandidates = [user.pwd, user.is_pwd, user.pwd_status, user.has_pwd, user.field_pwd];
                let pwdVal = '';
                for (const p of pwdCandidates) {
                  if (p === undefined || p === null) continue;
                  const s = String(p).trim().toLowerCase();
                  if (!s) continue;
                  if (['yes','y','true','1','pwd','has','have'].indexOf(s) !== -1) { pwdVal = 'pwd'; break; }
                  if (['no','n','false','0','none','na','n/a','nonpwd','non-pwd'].indexOf(s) !== -1) { pwdVal = 'nonpwd'; break; }
                }
                tr.dataset.campus = String(campusVal || '').trim();
                tr.dataset.college = String(collegeVal || '').trim();
                tr.dataset.gender = String(genderVal || '').trim();
                tr.dataset.year = String(yearVal || '').trim();
                tr.dataset.pwd = pwdVal;
              } catch(e) { }

              const photoDataAttr = encodeURIComponent(String(photoUrl || ""));
              const resolvedDataAttr = encodeURIComponent(String(resolvedPhotoUrl || ""));

              tr.innerHTML = `
              <td style="width:64px;padding:8px;" data-photo="${photoDataAttr}" data-resolved="${resolvedDataAttr}">
                ${resolvedPhotoUrl ? `<img class="user-photo" src="${resolvedPhotoUrl}" alt="${firstName}" data-resolved-url="${resolvedPhotoUrl}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;display:block;margin:auto;" />` : `<div class="avatar-fallback" style="width:48px;height:48px;border-radius:50%;background:#e6eef0;color:#0f7a34;display:flex;align-items:center;justify-content:center;margin:auto;font-weight:700;">${initials}</div>`}
              </td>
              <td class="student-id">${studentId}</td>
              <td>${fullName}</td>
              <td>${email}</td>
              <td>${course}</td>
              <td>${role}</td>
              <td>
                <label class="switch">
                  <input type="checkbox" class="login-switch" data-id="${studentId}" ${login.toLowerCase()==="enable" ? "checked" : ""} />
                  <span class="slider"></span>
                </label>
                <span class="login-label">${login.toLowerCase()==="enable" ? "On" : "Off"}</span>
              </td>
              <td class="action-icons">
                <i class="fa fa-eye view" title="View" role="button" tabindex="0" aria-label="View student" data-action="view"></i>
                <i class="fa fa-edit edit" title="Edit" role="button" tabindex="0" aria-label="Edit student" data-action="edit"></i>
                <i class="fa fa-trash delete" title="Delete" role="button" tabindex="0" aria-label="Delete student" data-action="delete"></i>
              </td>
            `;
              tableBody.appendChild(tr);
            }
            try { if (typeof attachImageFallbacks === 'function') attachImageFallbacks(); } catch(e) { console.debug('attachImageFallbacks error', e); }
            try { if (typeof window.applyTableFilters === 'function') window.applyTableFilters(); } catch(e) { console.debug && console.debug('applyTableFilters call error', e); }
          } catch (err) {
            console.error('Failed to fetch students', err);
            if (previousHtml && previousHtml.trim()) {
              tableBody.innerHTML = previousHtml;
            } else {
              tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:20px;color:#a00">Failed to load students. <button onclick="fetchAndDisplayUsers()" style="margin-left:8px">Retry</button></td></tr>`;
            }
          } finally {
            // skeletons are replaced by actual content above; hideTableSkeleton is noop here
            hideTableSkeleton();
          }
        }
        fetchAndDisplayUsers();
        
        function showMessage(message, title = "Notice") {
          return new Promise((resolve) => {
            const modal = document.getElementById("messageModal");
            const label = document.getElementById("messageModalLabel");
            const body = document.getElementById("messageModalBody");
            const ok = document.getElementById("messageModalOk");
            if (!modal || !body || !ok) {
              alert(message);
              return resolve();
            }
            label.textContent = title;
            body.textContent = message;
            modal.style.display = "flex";
            modal.setAttribute("aria-hidden", "false");
            function cleanup() {
              ok.removeEventListener("click", onOk);
              modal.style.display = "none";
              modal.setAttribute("aria-hidden", "true");
              resolve();
            }
            function onOk() { cleanup(); }
            ok.addEventListener("click", onOk);
            modal.addEventListener("click", function onBackdrop(ev) {
              if (ev.target === modal) {
                modal.removeEventListener("click", onBackdrop);
                cleanup();
              }
            });
            function onKey(ev) {
              if (ev.key === "Escape") {
                cleanup();
                document.removeEventListener("keydown", onKey);
              }
            }
            document.addEventListener("keydown", onKey);
          });
        }

        function showConfirm(message, title = "Confirm") {
          return new Promise((resolve) => {
            const modal = document.getElementById("confirmModal");
            const label = document.getElementById("confirmModalLabel");
            const body = document.getElementById("confirmModalBody");
            const yes = document.getElementById("confirmModalYes");
            const no = document.getElementById("confirmModalNo");
            if (!modal || !body || !yes || !no) {
              return resolve(confirm(message));
            }
            label.textContent = title;
            body.textContent = message;
            modal.style.display = "flex";
            modal.setAttribute("aria-hidden", "false");

            function cleanup(result) {
              yes.removeEventListener("click", onYes);
              no.removeEventListener("click", onNo);
              modal.style.display = "none";
              modal.setAttribute("aria-hidden", "true");
              resolve(result);
            }
            function onYes() { cleanup(true); }
            function onNo() { cleanup(false); }

            yes.addEventListener("click", onYes);
            no.addEventListener("click", onNo);

            modal.addEventListener("click", function onBackdrop(ev) {
              if (ev.target === modal) {
                modal.removeEventListener("click", onBackdrop);
                cleanup(false);
              }
            });

            function onKey(ev) {
              if (ev.key === "Escape") {
                cleanup(false);
                document.removeEventListener("keydown", onKey);
              }
            }
            document.addEventListener("keydown", onKey);
          });
        }
        
        // Small global helper used by populators (safe to call from anywhere)
        function setValById(id, value) {
          try {
            const el = document.getElementById(id);
            if (!el) return;
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT') el.value = value ?? '';
            else el.textContent = value ?? '';
          } catch (e) { /* ignore */ }
        }

        // Populate radio inputs based on common student object keys.
        function populateRadioButtons(student) {
          try {
            function setRadio(name, val) {
              if (!name) return;
              const radios = document.querySelectorAll('input[type="radio"][name="' + name + '"]');
              if (!radios || radios.length === 0) return;
              const norm = (val === undefined || val === null) ? '' : String(val).toLowerCase();
              radios.forEach(r => {
                try {
                  const rv = (r.value === undefined || r.value === null) ? '' : String(r.value).toLowerCase();
                  if (rv === norm) { r.checked = true; return; }
                  // fallback: try to match by nearby label text if value isn't present
                  try {
                    const lbl = (r.closest && r.closest('label')) ? (r.closest('label').textContent || '').trim().toLowerCase() : '';
                    if (lbl) {
                      if (lbl === norm || lbl.indexOf(norm) !== -1) { r.checked = true; return; }
                    }
                  } catch(_){}
                  r.checked = false;
                } catch (e) { /* ignore per-radio */ }
              });
            }

            // Academic admit semester: prefer explicit field flags (field_admit_sem_1 / field_admit_sem_2)
            try {
              if (student.field_admit_sem_1 || student.field_admit_sem_1 === '1' || String(student.field_admit_sem_1).toLowerCase() === 'yes') setRadio('academic_admit_sem', '1st');
              else if (student.field_admit_sem_2 || student.field_admit_sem_2 === '1' || String(student.field_admit_sem_2).toLowerCase() === 'yes') setRadio('academic_admit_sem', '2nd');
              else setRadio('academic_admit_sem', student.field_admit_sem || student.field_admit_semester || '');
            } catch(e) { /* ignore */ }

            // Enrollment status
            setRadio('status_of_enrollment', (student.status_of_enrollment || student.field_status_enrolment || student.statusEnrolment || student.enrolment_status || '') );

            // Account status/login (keep previous login-based fallback)
            if (student.login && String(student.login).toLowerCase() === 'enable') setRadio('accountStatus', 'enabled');
            else if (student.login && String(student.login).toLowerCase() === 'disable') setRadio('accountStatus', 'disabled');
            else if (student.field_account_status) setRadio('accountStatus', student.field_account_status);
            else setRadio('accountStatus', student.accountStatus || student.account_status || '');

            // Civil status: prefer canonical fields; map 'Separated' to 'Others' so it matches the radio choices
            try {
              const civRaw = student.field_civil_status || student.field_civil_status_other || student.civil_status || student.civilStatus || '';
              const civNorm = (civRaw || '').toString().trim().toLowerCase();
              if (civNorm && civNorm.indexOf('separ') !== -1) {
                // Map 'Separated' -> 'Others' radio option
                setRadio('civilStatus', 'others');
              } else {
                setRadio('civilStatus', civRaw);
              }
            } catch(e) { /* ignore */ }

            // IP member flag
            try {
              if (student.indigenous_member !== undefined) {
                const v = String(student.indigenous_member).toLowerCase();
                setRadio('ipMember', (v === '1' || v === 'true' || v === 'yes') ? 'yes' : 'no');
              } else if (student.is_ip || student.ip_member || student.ipMember) {
                const v = String(student.is_ip || student.ip_member || student.ipMember).toLowerCase();
                setRadio('ipMember', (v === '1' || v === 'true' || v === 'yes') ? 'yes' : 'no');
              }
            } catch(e){}

            // Living arrangement
            setRadio('livingArrangement', student.living_arrangement || student.field_living_arrangement || student.livingArrangement || '');

            // Relationships (use rel_* fields)
            setRadio('relationship_parent_mother', student.rel_parent_mother || student.relationship_parent_mother || '');
            setRadio('relationship_parent_father', student.rel_parent_father || student.relationship_parent_father || '');
            setRadio('relationship_siblings', student.rel_siblings || student.relationship_siblings || '');
            setRadio('relationship_spouse', student.rel_spouse || student.relationship_spouse || '');
            setRadio('relationship_children', student.rel_children || student.relationship_children || '');

            // Family income
            setRadio('familyIncome', student.familyIncome || student.field_family_income || student.family_income || '');

            // Therapy flag (use med_therapy if present)
            const therapy = (student.med_therapy || student.field_med_therapy || student.therapy_received || student.therapy || '').toString().toLowerCase();
            if (therapy === 'yes' || therapy === 'true' || therapy === '1') setRadio('therapyReceived', 'yes');
            else if (therapy === 'no' || therapy === 'false' || therapy === '0') setRadio('therapyReceived', 'no');

            // PWD (Person With Disability) mapping: support multiple key names and boolean/text tokens
            try {
              const pwdCandidates = [student.pwd, student.is_pwd, student.pwd_status, student.has_pwd, student.field_pwd, student.field_pwd_status];
              const pwdRaw = pwdCandidates.find(x => x !== undefined && x !== null && String(x).trim() !== '');
              if (pwdRaw !== undefined && pwdRaw !== null) {
                const p = String(pwdRaw).trim().toLowerCase();
                if (['yes','y','true','1','pwd','has','have'].indexOf(p) !== -1) setRadio('pwdStatus', 'yes');
                else if (['no','n','false','0','none','na','n/a'].indexOf(p) !== -1) setRadio('pwdStatus', 'no');
                else {
                  // if value is textual and contains 'yes' or id-like token, try yes
                  if (p.indexOf('yes') !== -1 || p.indexOf('pwd') !== -1) setRadio('pwdStatus', 'yes');
                }
              }
            } catch(e){}
          } catch (e) { console.debug && console.debug('populateRadioButtons error', e); }
        }

        // Populate checkboxes and common dropdown/text fields that are not handled by the bulk setVal inside openProfileModal
        function populateDropdowns(student) {
            try {
            // Present and contact fields use field_* names
            setValById('present_address', student.present_address || student.field_present || student.field_presentaddress || student.presentAddress || student.present_address || '');
            setValById('fbMessengerInput', student.field_fb_messenger || student.field_fb_messenger || student.fb_messenger || student.fbMessenger || student.messenger || '');
            setValById('landlordNameInput', student.field_landlord_name || student.field_landlord || student.landlord_name || student.landlordName || '');
            setValById('landlordContactInput', student.field_landlord_contact || student.landlord_contact || student.landlordContact || '');
            setValById('guardianNameInput', student.field_legal_guardian || student.field_legal_guardian_name || student.legal_guardian || student.guardian_name || '');
            setValById('guardianRelationshipInput', student.field_legal_guardian_relationship || student.legal_guardian_relationship || student.guardian_relationship || '');
            setValById('guardianContactInput', student.field_legal_guardian_contact || student.legal_guardian_contact || student.guardian_contact || '');
            setValById('guardianAddressInput', student.field_legal_guardian_address || student.legal_guardian_address || student.guardian_address || '');
            setValById('householdCountInput', student.field_household_count || student.household_count || student.householdCount || '');

            // Checkboxes: sameAddress (form id is sameAddress) â€” CSV mapping may supply sameAddress or field_same_address
            const same = !!(student.sameAddress || student.field_same_address || student.same_address || false);
            const sensitive = !!(student.field_sensitive_opt_in || student.field_sensitive_optin || student.field_sensitive || student.sensitive_opt_in || student.sensitiveOptIn || false);
            const sa = document.getElementById('sameAddress'); if (sa) sa.checked = same;
            const so = document.getElementById('sensitiveOptIn'); if (so) so.checked = sensitive;

            // Privacy agreement detector: CSV often stores the statement in `column_1` â€” handle separately
            if (typeof populatePrivacyAgreement === 'function') populatePrivacyAgreement(student);
          } catch (e) { console.debug && console.debug('populateDropdowns error', e); }
        }

        // Populate privacy agreement checkbox by inspecting `column_1` (robust + extensible)
        function populatePrivacyAgreement(student) {
          try {
            if (!student) return;
            const privacyCheckbox = document.getElementById('privacyAgreement');
            if (!privacyCheckbox) return;

            const raw = String(student.column_1 || student.column1 || student['column 1'] || student.col1 || '').toLowerCase().trim();

            const agreementIndicators = [
              'i agree that my personal data shall be used',
              'i agree to the data privacy',
              'data privacy notice',
              'privacy agreement',
              'agree to privacy',
              'consent to data',
              'data protection',
              'i agree',
              'consent'
            ];

            const hasAgreed = agreementIndicators.some(ind => ind && raw.indexOf(ind) !== -1);

            privacyCheckbox.checked = !!hasAgreed;

            const parent = privacyCheckbox.parentElement || privacyCheckbox.closest('label') || null;
            if (hasAgreed) {
              if (parent) { parent.style.color = '#10b981'; parent.style.fontWeight = '600'; }
              // add check icon if not present
              if (parent && !parent.querySelector('.agreement-icon')) {
                const icon = document.createElement('span');
                icon.className = 'agreement-icon';
                icon.innerHTML = ' âœ“';
                icon.style.color = '#10b981';
                icon.style.fontWeight = '700';
                icon.style.marginLeft = '6px';
                parent.appendChild(icon);
              }
            } else {
              if (parent) { parent.style.color = ''; parent.style.fontWeight = ''; }
              const existing = parent ? parent.querySelector('.agreement-icon') : null;
              if (existing) existing.remove();
            }
          } catch (err) { console.debug && console.debug('populatePrivacyAgreement error', err); }
        }

        // Debug helper to inspect column_1 contents for a student object
        function debugColumn1(student) {
          try {
            const column1Value = student ? (student.column_1 || student.column1 || student['column 1'] || null) : null;
            if (column1Value) {
              console.log('column_1 value:', column1Value);
              console.log('Type:', typeof column1Value);
              console.log('Length:', (column1Value && column1Value.length) || 0);
              console.log('Includes privacy text (simple):', String(column1Value).toLowerCase().includes('i agree that my personal data shall be used'));
            } else {
              console.log('column_1 is empty or undefined');
            }
          } catch (err) { console.debug && console.debug('debugColumn1 error', err); }
        }

        // Helper: open the inline profile panel `#profileModal` and populate fields
        async function openProfileModal(studentId, mode = 'view') {
          const modal = document.getElementById('profileModal');
          if (!modal) { await showMessage('Profile panel not found.', 'Error'); return; }
          try {
            // debug trace
            console.debug && console.debug('openProfileModal called for', studentId);
            // Ensure the modal is shown above header/sidebar and is centered.
            // Use a flex overlay so the internal panel can scroll if tall.
            try {
              // Position the modal overlay so it doesn't overlap the left sidebar or top header.
              const sidebarEl = document.getElementById('sidebar');
              const headerEl = document.querySelector('.header-and-sidebar-top') || document.querySelector('header');
              const leftPx = (sidebarEl && sidebarEl.getBoundingClientRect) ? Math.max(0, Math.round(sidebarEl.getBoundingClientRect().width)) : 250;
              const topPx = (headerEl && headerEl.getBoundingClientRect) ? Math.max(0, Math.round(headerEl.getBoundingClientRect().height)) : 60;

              modal.style.display = 'flex';
              modal.style.position = 'fixed';
              modal.style.left = leftPx + 'px';
              modal.style.top = topPx + 'px';
              modal.style.right = '0';
              modal.style.bottom = '0';
              modal.style.justifyContent = 'center';
              modal.style.alignItems = 'flex-start';
              modal.style.overflow = 'auto';
              modal.style.padding = '20px';
              modal.style.background = 'rgba(0,0,0,0.06)';
              modal.style.pointerEvents = 'auto';
              modal.style.zIndex = '5000';

              // Constrain inner panel height so it scrolls internally instead of overlapping page content
              const inner = modal.querySelector('.profile-panel');
              if (inner) {
                try { inner.style.maxHeight = `calc(100vh - ${topPx + 40}px)`; inner.style.overflow = 'auto'; } catch(e){}
              }
            } catch (sErr) { console.debug && console.debug('failed to apply modal overlay styles', sErr); }
            const snap = await get(ref(db, `students/${studentId}`));
            const student = snap.exists() ? snap.val() : {};

            function setVal(id, value) {
              try {
                const el = document.getElementById(id);
                if (!el) return;
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.tagName === 'SELECT') el.value = value ?? '';
                else el.textContent = value ?? '';
              } catch (e) { /* ignore */ }
            }

            // Basic mapping (try multiple common keys)
            setVal('studentIdInput', studentId || '');
            setVal('firstNameInput', student.first_name ?? student.First_Name ?? student.firstname ?? student.firstName ?? '');
            setVal('lastNameInput', student.last_name ?? student.Last_Name ?? student.lastname ?? student.lastName ?? '');
            setVal('middleInitialInput', student.middle_initial ?? student.Middle_Initial ?? student.mi ?? '');
            setVal('suffix', student.suffix ?? '');
            setVal('programInput', student.course ?? student.Course ?? student.program ?? '');
            setVal('year_level', student.year_level ?? student.yearlevel ?? student.year ?? '');
            setVal('campusInput', student.campus ?? '');
            setVal('collegeInput', student.college ?? '');
            setVal('admit_year_from', student.admit_year_from ?? student.academicYear ?? '');
            setVal('present_address', student.present_address ?? student.presentAddress ?? student.address ?? '');
            setVal('permanent_address', student.permanent_address ?? student.permanentAddress ?? '');
            setVal('emailInput', student.email_address ?? student.Email_Address ?? student.email ?? '');
            setVal('dobInput', student.date_of_birth ?? student.dob ?? '');
            setVal('contact_no', student.contact_no ?? student.contact ?? student.phone ?? '');
            setVal('place_of_birth', student.place_of_birth ?? student.placeOfBirth ?? '');
            setVal('sexInput', student.sex ?? student.gender ?? '');
            setVal('ageInput', student.age ?? '');
            setVal('religionInput', student.religion ?? '');
            setVal('numChildrenInput', student.num_children ?? student.no_of_children ?? '');
            setVal('landlordContactInput', student.landlord_contact ?? '');
            setVal('landlordNameInput', student.landlord_name ?? '');
            setVal('father', student.father ?? '');
            setVal('fatherAgeInput', student.father_age ?? '');
            setVal('fatherMobile', student.fatherMobile ?? '');
            setVal('father_address', student.father_address ?? '');
            setVal('fatherOccupationInput', student.father_occupation ?? '');
            setVal('mother', student.mother ?? student.mother_name ?? student.motherName ?? '');
            setVal('motherMobile', student.motherMobile ?? student.mother_mobile ?? student.mother_contact ?? student.motherContact ?? '');
            setVal('mother_address', student.mother_address ?? student.motherAddress ?? student.mother_addr ?? '');
            setVal('mother_age', student.mother_age ?? '');
            setVal('mother_occupation', student.mother_occupation ?? '');
            setVal('name_of_spouse', student.name_of_spouse ?? student.spouse_name ?? student.spouseName ?? student.spouse ?? '');
            setVal('spouse_occupation', student.spouse_occupation ?? student.spouseOccupation ?? '');
            setVal('spouse_address', student.spouse_address ?? student.spouseAddress ?? '');
            setVal('num_brothers', student.num_brothers ?? '');
            setVal('num_sisters', student.num_sisters ?? '');
            setVal('guardianNameInput', student.legal_guardian ?? '');
            setVal('guardianRelationshipInput', student.legal_guardian_relationship ?? '');
            setVal('guardianContactInput', student.legal_guardian_contact ?? '');
            setVal('guardianAddressInput', student.legal_guardian_address ?? '');
            setVal('householdCountInput', student.household_count ?? '');
            setVal('physical_disability', student.physical_disability ?? student.physicalDisability ?? '');
            setVal('physical_pwd_id', student.physical_pwd_id ?? student.physical_pwdid ?? student.physicalPwdId ?? student.pwd_id ?? '');
            setVal('psychosocial_disability', student.psychosocial_disability ?? student.psychosocialDisability ?? '');
            setVal('psychosocial_pwd_id', student.psych_pwd_id ?? student.psychosocial_pwd_id ?? student.psychosocialPwdId ?? '');

            // Populate privacy agreement first (column_1 may contain the raw text)
            if (typeof populatePrivacyAgreement === 'function') populatePrivacyAgreement(student);
            // Populate radios and dropdowns (helpers)
            if (typeof populateRadioButtons === 'function') populateRadioButtons(student);
            if (typeof populateDropdowns === 'function') populateDropdowns(student);

            // Run specialized populators if present
            if (typeof populateMedicalTherapy === 'function') populateMedicalTherapy(student);
            if (typeof populateWorkExperience === 'function') populateWorkExperience(student);

            // Photo handling: prefer data URL or http(s)
            const photoPreview = document.getElementById('photoPreview');
            const photoPlaceholder = document.getElementById('photoPlaceholder');
            let photo = '';
            if (student) {
              for (const k of ['photo_url,photoURL','photoUrl','photo','photo_url','photo_path']) { if (student[k]) { photo = student[k]; break; } }
            }
            if (photo && (/^data:/i.test(photo) || /^https?:\/\//i.test(photo))) {
              if (photoPreview) { photoPreview.src = photo; photoPreview.classList.remove('hidden'); }
              if (photoPlaceholder) photoPlaceholder.classList.add('hidden');
            } else {
              if (photoPreview) { photoPreview.src = ''; photoPreview.classList.add('hidden'); }
              if (photoPlaceholder) photoPlaceholder.classList.remove('hidden');
            }

            // Show modal (use flex overlay applied above)
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden', 'false');

            const closeBtn = document.getElementById('closeProfileBtn');
            if (closeBtn) closeBtn.onclick = () => { modal.style.display = 'none'; modal.setAttribute('aria-hidden', 'true'); };

            // Expose the loaded student for any inline scripts
            window._currentProfileStudent = student || {};

            // Mode handling: 'view' (readonly) or 'edit' (make inputs editable and add Save)
            try {
              const allFields = Array.from(modal.querySelectorAll('input, textarea, select'));
              const isEdit = String(mode || '').toLowerCase() === 'edit';
              allFields.forEach(f => {
                try {
                  // skip hidden inputs entirely
                  if (f.type === 'hidden') return;

                  // file inputs: enable only in edit mode
                  if (f.type === 'file') { f.disabled = !isEdit; return; }

                  // for selects / checkboxes / radios use disabled attribute
                  if (f.tagName === 'SELECT' || f.type === 'checkbox' || f.type === 'radio') {
                    f.disabled = !isEdit;
                    return;
                  }

                  // For textual inputs and textareas: toggle readonly and disabled so they become editable
                  if (isEdit) {
                    try { f.removeAttribute('readonly'); } catch(_){}
                    try { f.readOnly = false; } catch(_){}
                    try { f.disabled = false; } catch(_){}
                  } else {
                    try { f.setAttribute('readonly',''); } catch(_){}
                    try { f.readOnly = true; } catch(_){}
                    // keep them enabled (not disabled) but read-only for view mode
                  }
                } catch (inner) { /* ignore per-field errors */ }
              });

              // Photo input: enable in edit mode
              const photoInput = modal.querySelector('#photoInput');
              if (photoInput) photoInput.disabled = !isEdit;

              // Manage Save button
              let saveBtn = document.getElementById('profileSaveBtn');
              const closeBtn = document.getElementById('closeProfileBtn');
              if (isEdit) {
                if (!saveBtn) {
                  saveBtn = document.createElement('button');
                  saveBtn.id = 'profileSaveBtn';
                  saveBtn.type = 'button';
                  saveBtn.textContent = 'Save Changes';
                  Object.assign(saveBtn.style, { position: 'absolute', right: '100px', top: '12px', background: '#10b981', color: '#fff', padding: '6px 10px', borderRadius: '6px', border: 'none', cursor: 'pointer' });
                  closeBtn && closeBtn.parentNode && closeBtn.parentNode.appendChild(saveBtn);
                }
                saveBtn.onclick = async function onSave() {
                  try {
                    saveBtn.disabled = true;
                    const payload = fetchProfileData();
                    if (!payload) { await showMessage('No profile data found to save.', 'Error'); saveBtn.disabled = false; return; }
                    // Remove UI-only fields that shouldn't be saved (like tables if empty)
                    // Attempt to write back to students/<studentId>
                    await update(ref(db, `students/${studentId}`), payload);
                    // Notifications for profile updates intentionally disabled on this page
                    // refresh list first
                    try { await fetchAndDisplayUsers(); } catch(_){ }
                    // close the inline profile modal
                    try { modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); } catch(e){}
                    // If an injected individual-inventory wrapper/overlay was added by
                    // `loadAndOpenIndividualInventory`, remove them so the full panel is dismissed.
                    try {
                      const injectedWrapper = document.getElementById('injectedIndividualInventoryWrapper');
                      if (injectedWrapper) injectedWrapper.remove();
                      const injectedOverlay = document.getElementById('injectedIndividualInventoryOverlay');
                      if (injectedOverlay) {
                        if (injectedOverlay._adjustHandler && typeof injectedOverlay._adjustHandler === 'function') {
                          window.removeEventListener('resize', injectedOverlay._adjustHandler);
                        }
                        injectedOverlay.remove();
                      }
                      try { document.body.style.overflow = ''; } catch(e){}
                    } catch (cleanupErr) { console.debug && console.debug('cleanup injected wrapper error', cleanupErr); }

                    // show confirmation after closing everything
                    await showMessage('Profile saved.', 'Saved');
                  } catch (err) {
                    console.error('Failed to save profile', err);
                    await showMessage('Failed to save profile: ' + (err.message || err), 'Error');
                  } finally { try { saveBtn.disabled = false; } catch(_){} }
                };
              } else {
                if (saveBtn && saveBtn.parentNode) saveBtn.parentNode.removeChild(saveBtn);
              }
            } catch (modeErr) { console.debug && console.debug('mode handling error', modeErr); }
          } catch (err) {
            console.error('openProfileModal error', err);
            await showMessage('Failed to load profile: ' + (err.message || err), 'Error');
          }
        }

        // Unified delegated handler: view / edit / delete + keyboard activation
        (function attachRowActionHandler(){
          const tbody = document.getElementById('userTableBody');
          if (!tbody) return;

          tbody.addEventListener('click', async (e) => {
            const actionEl = (e.target && e.target.closest) ? e.target.closest('i[data-action]') : null;
            if (!actionEl) return;
            const action = actionEl.dataset.action;
            const row = actionEl.closest('tr');
            if (!row) return;
            const studentId = row.dataset.id || row.querySelector('td.student-id')?.textContent?.trim();
            if (!studentId) { await showMessage('Unable to determine Student ID.', 'Error'); return; }

            if (action === 'delete') {
              const ok = await showConfirm(`Delete student ${studentId}? Are you sure?`, 'Confirm Delete');
              if (!ok) return;
              try {
                await remove(ref(db, `students/${studentId}`));
                row.remove();
                // Notifications for deletions intentionally disabled on this page
                await showMessage('Record deleted.', 'Deleted');
                try { if (typeof window.pushLocalActivity === 'function') window.pushLocalActivity(`Deleted student ${studentId}`, 'ðŸ—‘ï¸'); } catch(e){ console.debug('pushLocalActivity error', e); }
              } catch (err) {
                console.error(err);
                await showMessage('Failed to delete record: ' + (err.message || err), 'Error');
              }
              return;
            }

            if (action === 'view') {
              try {
                await openProfileModal(studentId);
              } catch (err) {
                console.error(err);
                await showMessage('Failed to open user profile.', 'Error');
              }
              return;
            }

            if (action === 'edit') {
              try {
                // Open the inline profile panel in edit mode so the admin can modify the full inventory
                await openProfileModal(studentId, 'edit');
              } catch (err) {
                console.error(err);
                await showMessage('Failed to open edit profile panel.', 'Error');
              }
              return;
            }
          });

          // Keyboard activation for icons (Enter / Space)
          tbody.addEventListener('keydown', (e) => {
            if (e.key !== 'Enter' && e.key !== ' ') return;
            const target = e.target;
            const actionEl = (target && target.closest) ? target.closest('i[data-action]') : null;
            if (actionEl && actionEl.dataset && actionEl.dataset.action) {
              actionEl.click();
              e.preventDefault();
            }
          });
        })();
        
        const uploadModal = document.getElementById("uploadModal");
        const openBtn = document.getElementById("openUploadModal");
        const cancelBtn = document.getElementById("cancelUpload");
        const confirmBtn = document.getElementById("confirmUpload");
        const csvFileInput = document.getElementById("csvFile");

        csvFileInput?.addEventListener('change', () => {
          const um = document.getElementById('uploadMessage');
          if (!um) return;
          um.textContent = "";
          um.style.color = "#b91c1c";
        });

        openBtn.addEventListener("click", () => {
          uploadModal.style.display = "flex";
          uploadModal.setAttribute("aria-hidden", "false");
          csvFileInput.value = "";
          const um = document.getElementById('uploadMessage'); if (um) { um.textContent = ""; um.style.color = "#b91c1c"; }
        });
        
        function closeModal() {
          uploadModal.style.display = "none";
          uploadModal.setAttribute("aria-hidden", "true");
        }
        cancelBtn.addEventListener("click", closeModal);
        uploadModal.addEventListener("click", (e) => { if (e.target === uploadModal) closeModal(); });
        
        confirmBtn.addEventListener("click", async (e) => {
          e.preventDefault();
          e.stopPropagation();
          const um = document.getElementById('uploadMessage');
          if (!csvFileInput) {
            if (um) { um.textContent = "Upload input not found."; um.style.color = "#b91c1c"; }
            return;
          }
          const file = csvFileInput.files[0];
          if (!file) {
            if (um) { um.textContent = "Please select a CSV file first."; um.style.color = "#b91c1c"; }
            csvFileInput.focus();
            return;
          }
          confirmBtn.disabled = true;
          const prevText = confirmBtn.textContent;
          confirmBtn.textContent = "Uploading...";
          try {
            const result = await new Promise((resolve, reject) => {
              Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: ({ data }) => resolve(data),
                error: (err) => reject(err)
              });
            });
            let importedCount = 0, skippedCount = 0;
            for (const rawRow of result) {
              const studentId = (rawRow["Student ID"] || rawRow["student id"] || rawRow["student_id"] || "").toString().trim();
              if (!studentId) continue;
              const studentRef = ref(db, `students/${studentId}`);
              const exists = (await get(studentRef)).exists();
              if (exists) { skippedCount++; continue; }
              const cleanedRow = cleanKeys(rawRow);
              cleanedRow.course = cleanedRow.course ?? cleanedRow.course_of_study ?? cleanedRow["course"] ?? cleanedRow["Course"] ?? "";
              cleanedRow.Course = cleanedRow.Course ?? cleanedRow.course;
              Object.assign(cleanedRow, {
                gender: cleanedRow.gender || "",
                username: cleanedRow.username || "",
                activation_code: cleanedRow.activation_code || "",
                expiry_date: cleanedRow.expiry_date || "",
                status: cleanedRow.status || 0,
                // default admin-imported values
                login: "Enable",
                role: "Student"
              });
              await set(studentRef, cleanedRow);
              importedCount++;
              // For bulk imports, avoid spamming notifications per-record; we will summarize after import
            }
            if (um) { um.textContent = `${importedCount} new records imported. ${skippedCount} skipped (already existing).`; um.style.color = "#0b7a44"; }
            // Post-import notification summary
            try {
              // Post-import notifications intentionally disabled on this page
            } catch (e) { console.debug && console.debug('post-import notifications skipped', e); }
            fetchAndDisplayUsers();
            try { if (typeof window.pushLocalActivity === 'function') window.pushLocalActivity(`${importedCount} new students imported via CSV`, 'ðŸ“¥'); } catch(e){ console.debug('pushLocalActivity error', e); }
            setTimeout(closeModal, 900);
          } catch (err) {
            console.error("Upload error:", err);
            if (um) { um.textContent = "Upload failed: " + (err.message || err); um.style.color = "#b91c1c"; }
          } finally {
            confirmBtn.disabled = false;
            confirmBtn.textContent = prevText;
          }
        });
        
        const massEmailBtn = document.getElementById("massEmail");
        const processingModal = document.getElementById("processingModal");
        const processingBody = document.getElementById("processingBody");
        
        async function sendMassEmailsFromAdminUI() {
            if (!processingModal || !processingBody || !massEmailBtn) {
                await showMessage("Processing modal or button not found.", "Error");
                return;
            }
            massEmailBtn.disabled = true;
        
            processingBody.innerHTML = "";
            const progWrap = document.createElement("div");
            progWrap.className = "processing-progress-wrap";
            progWrap.innerHTML = '<div id="processingProgress" style="width:0%;height:100%;background:linear-gradient(90deg,#10b981,#11824b);"></div>';
            processingBody.appendChild(progWrap);
            const lines = document.createElement("div");
            processingBody.appendChild(lines);
        
            processingModal.style.display = "flex";
            processingModal.setAttribute("aria-hidden", "false");
        
            let snapshot;
            try {
                snapshot = await get(ref(db, "students"));
            } catch (err) {
                lines.appendChild(Object.assign(document.createElement("div"), { textContent: "Failed to read students: " + (err.message || err) }));
                massEmailBtn.disabled = false;
                return;
            }
            if (!snapshot.exists()) {
                lines.appendChild(Object.assign(document.createElement("div"), { textContent: "No students found." }));
                massEmailBtn.disabled = false;
                return;
            }
        
              const users = snapshot.val();
              let validRecipients = [];
              Object.keys(users || {}).forEach(id => {
                const u = users[id];
                const email = (u.Email_Address || u.email_address || u.email || "").toString().trim();
                const status = (typeof u.status === 'string' ? parseInt(u.status) : u.status);
                if (!u || !email || status === 1 || status === 2) return;
                validRecipients.push(id);
              });

              console.log('Valid recipients:', validRecipients);
              if (validRecipients.length === 0) {
                lines.appendChild(Object.assign(document.createElement("div"), { textContent: "No pending recipients to send. Check console for details." }));
                massEmailBtn.disabled = false;
                return;
              }

              let sent = 0, failed = 0, done = 0, total = validRecipients.length;
              for (const id of validRecipients) {
                const u = users[id];
                const email = (u.Email_Address || u.email_address || u.email || "").toString().trim();
                const firstname = u.First_Name || u.first_name || u.firstname || "";
                const code = Math.random().toString(36).substring(2, 10).toUpperCase();
                const expiry = (function(){ const d = new Date(); d.setDate(d.getDate()+5); return d.getTime(); })();

                try {
                  await update(ref(db, `students/${id}`), { activation_code: code, expiry_date: expiry, status: 1, statuse: 2 });
                  // Provide common recipient/template fields to avoid provider 422 errors
                  const templateParams = { passcode: code, firstname: firstname, email: email, to_email: email, to_name: firstname, reply_to: email };
                  await emailjs.send("service_jlchmap", "template_1qcpgyr", templateParams);
                  const okLine = Object.assign(document.createElement("div"), { style: "color:#0b7a44;font-weight:600;", textContent: `Sent to ${email} (code ${code})`});
                  lines.appendChild(okLine);
                  sent++;
                } catch (err) {
                  const errText = err?.text || err?.message || JSON.stringify(err);
                  const statusInfo = err?.status ? ` (status ${err.status})` : '';
                  const failLine = Object.assign(document.createElement("div"), { style: "color:#b91c1c;font-weight:600;", textContent: `Failed for ${email}:${statusInfo} ${errText}`});
                  lines.appendChild(failLine);
                  console.error("EmailJS error for", email, err?.status, err?.text, err);
                  failed++;
                } finally {
                  done++;
                  const pct = Math.round((done / total) * 100);
                  const progEl = document.getElementById("processingProgress");
                  if (progEl) progEl.style.width = pct + "%";
                  await new Promise(r => setTimeout(r, 180));
                }
              }

              const summary = Object.assign(document.createElement("div"), { style: "font-weight:700;margin-bottom:8px;", textContent: `Send emails finished â€” Sent: ${sent}, Failed: ${failed}`});
              processingBody.insertBefore(summary, processingBody.firstChild);
              // Mass-email notifications intentionally disabled on this page
              massEmailBtn.disabled = false;
                try { if (typeof window.pushLocalActivity === 'function') window.pushLocalActivity(`Sent mass emails â€” Sent: ${sent}, Failed: ${failed}`, 'âœ‰ï¸'); } catch(e){ console.debug('pushLocalActivity error', e); }
        }
        
        massEmailBtn.addEventListener("click", function(e) {
          const confirmModal = document.getElementById("confirmSendModal");
          if (confirmModal) {
            confirmModal.style.display = "flex";
            confirmModal.setAttribute("aria-hidden", "false");
          }
        });

        document.getElementById("confirmSendVerification").addEventListener("click", function() {
          const confirmSendModal = document.getElementById("confirmSendModal");
          if (confirmSendModal) {
            confirmSendModal.style.display = "none";
            confirmSendModal.setAttribute("aria-hidden", "true");
          }
          sendMassEmailsFromAdminUI();
        });
        document.getElementById("cancelSendVerification").addEventListener("click", function() {
          const confirmSendModal = document.getElementById("confirmSendModal");
          if (confirmSendModal) {
            confirmSendModal.style.display = "none";
            confirmSendModal.setAttribute("aria-hidden", "true");
          }
        });

        const processingCloseBtn = document.getElementById("processingCloseBtn");
        if (processingCloseBtn) {
          processingCloseBtn.addEventListener("click", () => {
            processingModal.style.display = "none";
            processingModal.setAttribute("aria-hidden", "true");
            if (massEmailBtn) massEmailBtn.disabled = false;
          });
        }
        
        (function topRightInteractions(){
          const notifBtn = document.getElementById('notifBtn');
          const notifPanel = document.getElementById('notifPanel');
          const notifList = document.getElementById('notifList');
          const profileBtn = document.getElementById('profileBtn');
          const profileDropdown = document.getElementById('profileDropdown');
          const accountEdit = document.getElementById('accountEdit');
          const accountSettings = document.getElementById('accountSettings');
          const accountLogout = document.getElementById('accountLogout');
        
          function closeAll() {
            if (notifPanel) { notifPanel.setAttribute('data-open','false'); notifBtn && notifBtn.setAttribute('aria-expanded','false'); }
            if (profileDropdown) { profileDropdown.setAttribute('aria-hidden','true'); profileBtn && profileBtn.setAttribute('aria-expanded','false'); }
          }
        
          notifBtn?.addEventListener('click', (ev) => {
            ev.stopPropagation();
            const open = notifPanel?.getAttribute('data-open') === 'true';
            closeAll();
            if (!open && notifPanel) { notifPanel.setAttribute('data-open','true'); notifBtn.setAttribute('aria-expanded','true'); }
          });
        
          profileBtn?.addEventListener('click', (ev) => {
            try {
              console.debug('profileBtn clicked', { target: ev.target });
              ev.stopPropagation();
              const open = profileDropdown?.getAttribute('aria-hidden') === 'false';
              closeAll();
              if (!open && profileDropdown) { profileDropdown.setAttribute('aria-hidden','false'); profileBtn.setAttribute('aria-expanded','true'); }
            } catch (e) { console.debug('profileBtn click handler error', e); }
          });
        
          document.addEventListener('click', (ev) => {
              try {
                const t = ev.target;
                if (t && typeof t.closest === 'function') {
                  if (!t.closest('#notifPanel') && !t.closest('#notifBtn') && !t.closest('#profileDropdown') && !t.closest('#profileBtn')) {
                    closeAll();
                  }
                } else {
                  // Fallback for text nodes or environments without Element.closest on the target
                  const path = (typeof ev.composedPath === 'function') ? ev.composedPath() : (function(){ let p=[]; let n=ev.target; while(n){ p.push(n); n = n.parentNode; } return p; })();
                  const ids = path.map(el => el && el.id).filter(Boolean);
                  if (!ids.includes('notifPanel') && !ids.includes('notifBtn') && !ids.includes('profileDropdown') && !ids.includes('profileBtn')) {
                    closeAll();
                  }
                }
              } catch(e) {
                // If anything goes wrong, fail-safe: close all dropdowns
                try { closeAll(); } catch(_){}
              }
            }, { capture: true });
        
          document.addEventListener('keydown', (ev) => {
            if (ev.key === 'Escape') closeAll();
          });
        
          accountEdit?.addEventListener('click', () => {
            closeAll();
            location.href = 'admin_profile.html';
          });
          accountSettings?.addEventListener('click', () => {
            closeAll();
            // open in-page settings panel
            const panel = document.getElementById('settingsPanel');
            if (panel) panel.style.display = 'block';
            const list = document.getElementById('settingsList'); if (list) list.style.display = '';
            const content = document.getElementById('settingsContent'); if (content) content.style.display = 'none';
          });
          
          // Settings accordion and rendering
          (function setupSettingsPanel(){
            const panel = document.getElementById('settingsPanel');
            if (!panel) return;
            const infoToggle = panel.querySelector('.info-toggle');
            const infoContent = panel.querySelector('.info-content');
            const infoChevron = panel.querySelector('.info-chevron');
            const accountToggle = panel.querySelector('.account-toggle');
            const accountContent = panel.querySelector('.account-content');
            const accountChevron = panel.querySelector('.account-chevron');
            const items = panel.querySelectorAll('.settings-item');
            const settingsBackBtn = document.getElementById('settingsBackBtn');
            const settingsList = document.getElementById('settingsList');
            const settingsContent = document.getElementById('settingsContent');
            const settingsTitle = document.getElementById('settingsTitle');

            function toggleSection(toggleBtn, contentEl, chevronEl){
              if (!contentEl) return;
              const open = contentEl.style.display !== 'none' && contentEl.style.display !== '' && contentEl.style.display !== 'block' ? false : (contentEl.style.display === 'block');
              const willOpen = !open;
              contentEl.style.display = willOpen ? 'block' : 'none';
              if (chevronEl) chevronEl.style.transform = willOpen ? 'rotate(180deg)' : 'rotate(0deg)';
            }

            infoToggle?.addEventListener('click', () => toggleSection(infoToggle, infoContent, infoChevron));
            accountToggle?.addEventListener('click', () => toggleSection(accountToggle, accountContent, accountChevron));

            items.forEach(btn => {
              btn.addEventListener('click', () => {
                const key = btn.dataset.key;
                // hide list, show content
                if (settingsList) settingsList.style.display = 'none';
                if (settingsContent) settingsContent.style.display = 'block';
                // render simple placeholder content
                settingsTitle.textContent = btn.textContent.trim();
                if (settingsContent) settingsContent.innerHTML = `<div style="padding:12px;color:#374151;">Loading ${btn.textContent.trim()}...</div>`;
                // Simple content switcher
                if (key === 'faq') settingsContent.innerHTML = '<h4>FAQ</h4><p style="color:#374151">Common questions and answers here.</p>';
                if (key === 'privacy') settingsContent.innerHTML = '<h4>Privacy Policy</h4><p style="color:#374151">Privacy details go here.</p>';
                if (key === 'terms') settingsContent.innerHTML = '<h4>Terms & Conditions</h4><p style="color:#374151">Terms content goes here.</p>';
                if (key === 'profile') settingsContent.innerHTML = '<h4>Profile Information</h4><p style="color:#374151">Profile editing UI could be shown here.</p>';
                if (key === 'notifications') settingsContent.innerHTML = '<h4>Notification Settings</h4><p style="color:#374151">Manage notificaton preferences.</p>';
                if (key === 'privacy-security') settingsContent.innerHTML = '<h4>Privacy & Security</h4><p style="color:#374151">Security settings and options.</p>';
              });
            });

            settingsBackBtn?.addEventListener('click', () => {
              if (settingsContent) settingsContent.style.display = 'none';
              if (settingsList) settingsList.style.display = '';
              document.getElementById('settingsTitle').textContent = 'Settings';
            });

            const logoutBtn = document.getElementById('settingsLogout');
            logoutBtn?.addEventListener('click', () => {
              try { localStorage.removeItem('authToken'); } catch(e){}
              window.location.href = 'login.html';
            });

            // Hide panel when clicking outside
            document.addEventListener('click', (ev) => {
              try {
                const t = ev.target;
                if (!panel) return;
                if (t && (t === panel || panel.contains(t) || (t.closest && t.closest('#profileDropdown')) || (t.closest && t.closest('#profileBtn')) || (t.closest && t.closest('#accountSettings')))) return;
                panel.style.display = 'none';
                if (settingsContent) settingsContent.style.display = 'none';
                if (settingsList) settingsList.style.display = '';
              } catch (e) { /* ignore */ }
            }, { capture: true });

            // Close on Escape
            document.addEventListener('keydown', (ev) => {
              if (ev.key === 'Escape') {
                if (panel) panel.style.display = 'none';
                if (settingsContent) settingsContent.style.display = 'none';
                if (settingsList) settingsList.style.display = '';
              }
            });
          })();
          accountLogout?.addEventListener('click', () => {
            closeAll();
            try { localStorage.removeItem('authToken'); } catch(e){}
            window.location.href = 'login.html';
          });
        
          if (notifList) {
            notifList.innerHTML = '<div class="popover-empty">No notifications</div>';
          }
        })();
        
        if (processingModal) {
          processingModal.addEventListener("click", (ev) => {
            if (ev.target === processingModal) {
              processingModal.style.display = "none";
              processingModal.setAttribute("aria-hidden", "false");
              if (massEmailBtn) massEmailBtn.disabled = false;
            }
          });
        }
        document.addEventListener("keydown", (ev) => {
          if (ev.key === "Escape" && processingModal && processingModal.getAttribute("aria-hidden") === "false") {
            processingModal.style.display = "none";
            processingModal.setAttribute("aria-hidden", "true");
            if (massEmailBtn) massEmailBtn.disabled = false;
          }
        });
        
        const searchInput = document.getElementById("searchInput");
        if (searchInput) {
          searchInput.addEventListener("input", () => {
            if (typeof window.applyTableFilters === 'function') window.applyTableFilters();
          });
        }

        // Ensure images that fail to load are replaced with initials fallback
        function attachImageFallbacks() {
          const tbody = document.getElementById('userTableBody');
          if (!tbody) return;
          for (const img of tbody.querySelectorAll('img.user-photo')) {
            if (img._fallbackAttached) continue;
            img._fallbackAttached = true;
            img.addEventListener('error', (ev) => {
              try {
                const td = img.closest('td');
                const tr = img.closest('tr');
                const nameCell = tr ? tr.cells[2] : null;
                const initials = nameCell ? ( (nameCell.textContent || '').trim().split(' ').map(s=>s[0]||'').slice(0,2).join('') ).toUpperCase() : '';
                const fallback = document.createElement('div');
                fallback.className = 'avatar-fallback';
                fallback.style.width = '48px';
                fallback.style.height = '48px';
                fallback.style.borderRadius = '50%';
                fallback.style.background = '#e6eef0';
                fallback.style.color = '#0f7a34';
                fallback.style.display = 'flex';
                fallback.style.alignItems = 'center';
                fallback.style.justifyContent = 'center';
                fallback.style.margin = 'auto';
                fallback.style.fontWeight = '700';
                fallback.textContent = initials;
                if (td) td.replaceChild(fallback, img);
              } catch (e) { console.debug('Fallback error', e); }
            });
          }
        }

        // Re-attach fallbacks after rendering rows
        const originalFetchAndDisplayUsers = fetchAndDisplayUsers;
        fetchAndDisplayUsers = async function() {
          await originalFetchAndDisplayUsers();
          attachImageFallbacks();
        };

        // Auto-open a student profile when `?studentId=...` is present in the URL
        (function autoOpenFromQuery() {
          try {
            const params = new URLSearchParams(window.location.search || '');
            const sid = params.get('studentId') || params.get('studentid') || params.get('student_id');
            if (sid) {
              // Wait for the table to render then open the profile modal
              window.addEventListener('load', async () => {
                try { await fetchAndDisplayUsers(); } catch(_){}
                try { await openProfileModal(decodeURIComponent(sid), 'view'); } catch(e) { console.debug && console.debug('autoOpenFromQuery failed', e); }
              });
            }
          } catch(e) { console.debug && console.debug('autoOpenFromQuery error', e); }
        })();
        
        const viewEditModal = document.getElementById("viewEditModal");
        const ve_closeBtn = document.getElementById("ve_closeBtn");
        const ve_saveBtn = document.getElementById("ve_saveBtn");
        const ve_studentId = document.getElementById("ve_studentId");
        const ve_firstName = document.getElementById("ve_firstName");
        const ve_lastName = document.getElementById("ve_lastName");
        const ve_middle = document.getElementById("ve_middle");
        const ve_email = document.getElementById("ve_email");
        const ve_course = document.getElementById("ve_course");
        const ve_role = document.getElementById("ve_role");
        const ve_login = document.getElementById("ve_login");
        
        let ve_selectedPhotoDataUrl = null;

        // Handle photo file input change for preview
        const ve_photoInput = document.getElementById('photo_url');
        const ve_photoPreview = document.getElementById('ve_photoPreview');
        const ve_fileStatus = document.getElementById('ve_fileStatus');
        if (ve_photoInput) {
          ve_photoInput.addEventListener('change', function() {
            const file = ve_photoInput.files && ve_photoInput.files[0];
            if (!file) {
              ve_selectedPhotoDataUrl = null;
              if (ve_fileStatus) ve_fileStatus.textContent = 'No file chosen';
              return;
            }
            if (!file.type.startsWith('image/')) {
              if (ve_fileStatus) ve_fileStatus.textContent = 'Invalid file type';
              ve_selectedPhotoDataUrl = null;
              return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
              ve_selectedPhotoDataUrl = e.target.result;
              if (ve_photoPreview) {
                ve_photoPreview.src = ve_selectedPhotoDataUrl;
                ve_photoPreview.style.display = '';
              }
            };
            reader.readAsDataURL(file);
            if (ve_fileStatus) ve_fileStatus.textContent = file.name;
          });
        }

        //fetch modal
        function openViewEditModal(mode, data = {}) {
          ve_studentId.value = data.studentId || "";
          ve_firstName.value = data.first_name || data.First_Name || "";
          ve_lastName.value = data.last_name || data.Last_Name || "";
          ve_middle.value = data.middle_initial || data.Middle_Initial || "";
          ve_email.value = data.email_address || data.Email_Address || data.email || "";
          ve_course.value = data.course || data.Course || "";
          ve_role.value = data.role || data.Role || "";
          ve_login.value = (data.login || data.Login || "Disable");
          // Show current photo or initials fallback
          const ve_photoPreview = document.getElementById('ve_photoPreview');
          let firstName = ve_firstName.value;
          let lastName = ve_lastName.value;
          let initials = ((firstName || '').charAt(0) + (lastName || '').charAt(0)).toUpperCase();
          function findPhotoField(obj) {
            if (!obj) return "";
            const keys = Object.keys(obj);
            // consider common variants including snake_case and storage path
            for (const k of ['photo_url','photoURL','photoUrl','photo_path','photo']) if (k in obj) return obj[k];
            for (const k of keys) { if (/photo/i.test(k)) return obj[k]; }
            return "";
          }
          let photoUrl = findPhotoField(data) || "";
          let resolvedPhotoUrl = photoUrl;
          if (resolvedPhotoUrl) {
            if (/^data:/i.test(resolvedPhotoUrl) || /^https?:\/\//i.test(resolvedPhotoUrl)) {
              // Use as is
            } else if (window.getDownloadURL && window.storageRef && window.getStorage) {
              // Try to resolve Firebase Storage path (async not possible here, fallback to blank)
              resolvedPhotoUrl = "";
            } else {
              resolvedPhotoUrl = "";
            }
          }
          if (ve_photoPreview) {
            if (resolvedPhotoUrl) {
              ve_photoPreview.src = resolvedPhotoUrl;
              ve_photoPreview.style.display = '';
              ve_photoPreview.alt = firstName;
            } else {
              ve_photoPreview.src = '';
              ve_photoPreview.style.display = '';
              // Optionally, show initials fallback (could be a div, but for now just hide img)
            }
          }
          const readOnly = (mode === "view");
          [ve_firstName, ve_lastName, ve_middle, ve_email, ve_course, ve_role, ve_login].forEach(inp => {
            inp.disabled = readOnly;
          });
          ve_saveBtn.style.display = readOnly ? "none" : "";
          viewEditModal.style.display = "flex";
          viewEditModal.setAttribute("aria-hidden", "false");
        }
      
      
      //m
        function closeViewEditModal() {
          viewEditModal.style.display = "none";
          viewEditModal.setAttribute("aria-hidden", "true");
        }
        
        // Dynamically load and append the individual inventory modal file, then open it.
        // This function will execute any inline scripts found in the fetched file so
        // functions like `openIndividualInventory()` become available.
        async function loadAndOpenIndividualInventory(studentId) {
          // If modal already present, just open it
          if (document.getElementById('individualInventoryModal')) {
            if (typeof openIndividualInventory === 'function') {
              openIndividualInventory();
            } else {
              // try dispatching a custom event for modules that may attach later
              const ev = new CustomEvent('openIndividualInventory', { detail: { studentId } });
              document.dispatchEvent(ev);
            }
            return;
          }

          const resp = await fetch('student_profile.html', {cache: 'no-store'});
          if (!resp.ok) throw new Error('Failed to fetch modal file: ' + resp.statusText);
          const html = await resp.text();
          const container = document.createElement('div');
          container.innerHTML = html;

          // Create a fixed wrapper so the injected modal/content appears near the top
          const wrapperId = 'injectedIndividualInventoryWrapper';
          let wrapper = document.getElementById(wrapperId);
          if (!wrapper) {
            wrapper = document.createElement('div');
            wrapper.id = wrapperId;
            // position fixed, top-aligned, centered horizontally, allow scrolling inside
            Object.assign(wrapper.style, {
              position: 'fixed',
              top: '60px',
              left: '0',
              right: '0',
              bottom: '0',
              zIndex: '5000',
              display: 'flex',
              justifyContent: 'center',
              alignItems: 'flex-start',
              overflow: 'auto',
              padding: '20px',
              pointerEvents: 'auto'
            });
          }

          // Extract and execute scripts (inline and external) safely, and move other nodes to wrapper
          const scripts = Array.from(container.querySelectorAll('script'));
          // Move non-script children to wrapper first (so markup appears immediately)
          while (container.firstChild) {
            const node = container.firstChild;
            if (node.tagName && node.tagName.toLowerCase() === 'script') {
              // leave scripts to process separately
              container.removeChild(node);
              continue;
            }
            wrapper.appendChild(node);
          }
          // append wrapper to body (once)
          if (!document.getElementById(wrapperId)) document.body.appendChild(wrapper);

          // Create a semi-transparent backdrop overlay that blurs everything except the left sidebar/header
          const overlayId = 'injectedIndividualInventoryOverlay';
          let overlay = document.getElementById(overlayId);
          if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = overlayId;
            const sidebarEl = document.getElementById('sidebar');
            const headerEl = document.querySelector('.header-and-sidebar-top') || document.querySelector('header');
            function computeGeo() {
              const left = (sidebarEl && sidebarEl.getBoundingClientRect) ? Math.max(0, Math.round(sidebarEl.getBoundingClientRect().width)) : 250;
              const top = (headerEl && headerEl.getBoundingClientRect) ? Math.max(0, Math.round(headerEl.getBoundingClientRect().height)) : 60;
              return { left, top };
            }
            const geo = computeGeo();
            Object.assign(overlay.style, {
              position: 'fixed',
              left: geo.left + 'px',
              top: geo.top + 'px',
              right: '0',
              bottom: '0',
              // Put overlay below the sidebar/header (sidebar uses z-index:999, header:1000)
              zIndex: '900',
              backdropFilter: 'blur(6px)',
              WebkitBackdropFilter: 'blur(6px)',
              background: 'rgba(0,0,0,0.22)'
            });
            // Clicking the overlay should close the injected modal
            overlay.addEventListener('click', function () {
              try { const w = document.getElementById('injectedIndividualInventoryWrapper'); if (w) w.remove(); } catch (e) {}
              try { const btn = document.querySelector('#injectedIndividualInventoryWrapper button[aria-label="Close"]'); if (btn && btn.parentNode) btn.parentNode.removeChild(btn); } catch (e) {}
              try { overlay.remove(); } catch (e) {}
              try { document.body.style.overflow = ''; } catch (e) {}
            });
            // Keep overlay aligned if window resizes or layout changes
            function adjustInjectedOverlay() {
              try {
                const g = computeGeo();
                overlay.style.left = g.left + 'px';
                overlay.style.top = g.top + 'px';
              } catch (e) { /* ignore */ }
            }
            window.addEventListener('resize', adjustInjectedOverlay);
            // store ref so we can remove listener later if needed
            overlay._adjustHandler = adjustInjectedOverlay;

            document.body.appendChild(overlay);
          }

          // Now process scripts so they execute
          for (const s of scripts) {
            const newScript = document.createElement('script');
            // copy attributes
            for (const attr of s.attributes) newScript.setAttribute(attr.name, attr.value);
            if (s.src) {
              // external script; set src so it loads and executes
              newScript.src = s.src;
              newScript.async = false;
              document.body.appendChild(newScript);
              // wait for it to load before continuing
              await new Promise((resolve, reject) => {
                newScript.onload = resolve; newScript.onerror = () => resolve();
              });
            } else {
              newScript.textContent = s.textContent;
              document.body.appendChild(newScript);
            }
          }

          // Give a tick for any init code to run
          await new Promise(r => setTimeout(r, 30));

          // If an open function exists, call it. Otherwise dispatch event to notify.
          if (typeof openIndividualInventory === 'function') {
            openIndividualInventory();
          } else {
            const ev = new CustomEvent('openIndividualInventory', { detail: { studentId } });
            document.dispatchEvent(ev);
          }

          // Add a close (Ã—) button inside the injected modal/form so it appears on the form itself
          (function addInjectedWrapperCloseInsideModal() {
            try {
              const wrapperEl = document.getElementById('injectedIndividualInventoryWrapper');
              if (!wrapperEl) return;
              if (wrapperEl._hasCloseBtn) return; wrapperEl._hasCloseBtn = true;

              // Prefer modal content containers commonly used: .bg-white, .modal-content, main, section
              const modalContent = wrapperEl.querySelector('.bg-white, .modal-content, main, section');
              // If not found, fall back to wrapper itself
              const targetEl = modalContent || wrapperEl;

              // Ensure the target is positioned relative so absolute button positions correctly
              const computed = window.getComputedStyle(targetEl);
              if (computed.position === 'static' || !computed.position) {
                targetEl.style.position = 'relative';
              }

              const btn = document.createElement('button');
              btn.type = 'button';
              btn.setAttribute('aria-label', 'Close');
              btn.innerHTML = 'âœ•';
              Object.assign(btn.style, {
                position: 'absolute',
                top: '8px',
                right: '8px',
                zIndex: '9999',
                background: 'rgba(0,0,0,0.6)',
                color: '#fff',
                border: '0',
                width: '36px',
                height: '36px',
                borderRadius: '18px',
                cursor: 'pointer',
                fontSize: '18px',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                boxShadow: '0 6px 18px rgba(0,0,0,0.12)'
              });

              btn.addEventListener('click', function closeInjected() {
                try {
                  if (typeof closeIndividualInventory === 'function') closeIndividualInventory();
                  document.dispatchEvent(new CustomEvent('closeIndividualInventory', { detail: { studentId } }));
                } catch (e) { /* ignore */ }
                try { wrapperEl.remove(); } catch (e) { wrapperEl.style.display = 'none'; }
                // remove overlay if present
                try { const ov = document.getElementById('injectedIndividualInventoryOverlay'); if (ov) ov.remove(); } catch (e) {}
                try { document.body.style.overflow = ''; } catch (e) {}
                // remove the close button itself (in case it wasn't inside modal)
                try { if (btn && btn.parentNode) btn.parentNode.removeChild(btn); } catch (e) {}
              });

              targetEl.appendChild(btn);

              // Close when clicking on backdrop area (wrapper background)
              wrapperEl.addEventListener('click', function onWrapClick(ev) {
                if (ev.target === wrapperEl) {
                  btn.click();
                }
              });
            } catch (err) { console.debug('addInjectedWrapperCloseInsideModal error', err); }
          })();
        }
        // (Replaced) unified handler is attached earlier; duplicate listener removed.
        ve_closeBtn?.addEventListener("click", closeViewEditModal);
        viewEditModal?.addEventListener("click", (ev) => { if (ev.target === viewEditModal) closeViewEditModal(); });
        ve_saveBtn?.addEventListener("click", async () => {
          const id = ve_studentId.value;
          if (!id) { await showMessage("Missing Student ID.", "Error"); return; }
          ve_saveBtn.disabled = true;
          try {
            const updateObj = {
              first_name: ve_firstName.value || "",
              last_name: ve_lastName.value || "",
              middle_initial: ve_middle.value || "",
              email_address: ve_email.value || "",
              course: ve_course.value || "",
              role: ve_role.value || "",
              login: ve_login.value || ""
            };

            // Prefer the cropped blob produced by the Cropper modal (stored on the file input)
            // Convert the blob to a data URL so it can be saved into Firebase the same way
            // other images are saved (as data URLs). Fall back to the original selected
            // data URL if no cropped blob exists.
            if (ve_photoInput && ve_photoInput.croppedBlob) {
              try {
                const dataUrl = await new Promise((resolve, reject) => {
                  const reader = new FileReader();
                  reader.onload = () => resolve(reader.result);
                  reader.onerror = (e) => reject(e);
                  reader.readAsDataURL(ve_photoInput.croppedBlob);
                });
                updateObj.photoURL = dataUrl;
              } catch (readErr) {
                console.warn('Failed to convert cropped blob to dataURL, falling back to original selection', readErr);
                if (ve_selectedPhotoDataUrl) updateObj.photoURL = ve_selectedPhotoDataUrl;
              }
            } else if (ve_selectedPhotoDataUrl) {
              updateObj.photoURL = ve_selectedPhotoDataUrl;
            }

            await update(ref(db, `students/${id}`), updateObj);
            // clear temporary cropped blob after successful save
            try { if (ve_photoInput && ve_photoInput.croppedBlob) delete ve_photoInput.croppedBlob; } catch(_){}

            await fetchAndDisplayUsers();
            closeViewEditModal();
            await showMessage("User updated.", "Saved");
            try { if (typeof window.pushLocalActivity === 'function') window.pushLocalActivity(`Edited student ${id}`, 'âœï¸'); } catch(e){ console.debug('pushLocalActivity error', e); }
          } catch (err) {
            console.error(err);
            await showMessage("Failed to save user: " + (err.message || err), "Error");
          } finally {
            ve_saveBtn.disabled = false;
          }
        });
        
     (function enableRowSelection(){
       const tbody = document.getElementById("userTableBody");
       if (!tbody) return;
       tbody.addEventListener("click", (ev) => {
         const tr = ev.target.closest("tr");
         if (!tr) return;
         const prev = tbody.querySelector("tr.selected");
         if (prev && prev !== tr) prev.classList.remove("selected");
         tr.classList.toggle("selected");
       });
     })();

        document.getElementById("userTableBody")?.addEventListener("change", async (e) => {
          const input = e.target;
          if (!input || !input.classList.contains("login-switch")) return;
          const id = input.dataset.id || input.closest("tr")?.querySelector("td")?.textContent?.trim();
          if (!id) {
            input.checked = !input.checked;
            await showMessage("Unable to determine Student ID for login change.", "Error");
            return;
          }
          const checked = !!input.checked;
          input.disabled = true;
          try {
            await update(ref(db, `students/${id}`), { login: checked ? "Enable" : "Disable" });
            const lbl = input.closest("td")?.querySelector(".login-label");
            if (lbl) lbl.textContent = checked ? "On" : "Off";
            try { if (typeof window.pushLocalActivity === 'function') window.pushLocalActivity(`${checked ? 'Enabled' : 'Disabled'} login for ${id}`, 'ðŸ”’'); } catch(e){ console.debug('pushLocalActivity error', e); }
          } catch (err) {
            console.error("Failed to update login:", err);
            input.checked = !checked;
            await showMessage("Failed to update login: " + (err.message || err), "Error");
          } finally {
            input.disabled = false;
          }
        });
        
        // ** NEW SIDEBAR LOGIC (Copied from appointment.html) **
        const menuIcon = document.getElementById('menuIcon');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const sidebarTop = document.getElementById('sidebarTop');
        
        const overlay = document.createElement('div');
        overlay.className = 'sidebar-overlay';
        document.body.appendChild(overlay);
        
        function isMobile() {
            return window.innerWidth <= 768;
        }
        
        menuIcon.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (isMobile()) {
                const isOpen = sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active', isOpen);
                document.body.style.overflow = isOpen ? 'hidden' : '';
            } else {
                const isCollapsed = sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('shifted', isCollapsed);
                sidebarTop.classList.toggle('collapsed', isCollapsed);
            }
        });
        
        overlay.addEventListener('click', () => {
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        });
        
        window.addEventListener('resize', () => {
            if (!isMobile()) {
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
                const isCollapsed = sidebar.classList.contains('collapsed');
                mainContent.classList.toggle('shifted', isCollapsed);
                sidebarTop.classList.toggle('collapsed', isCollapsed);
            } else {
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('shifted');
                sidebarTop.classList.remove('collapsed');
            }
        });
        
        document.querySelectorAll('.nav-item').forEach(link => {
            link.addEventListener('click', () => {
                if (isMobile()) {
                     if (!link.classList.contains('active')) {
                        sidebar.classList.remove('mobile-open');
                        overlay.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                }
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (!isMobile()) {
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('shifted');
                sidebarTop.classList.remove('collapsed');
            }
        });

        // --- Image Viewer Modal Logic (robust version) ---
        (function(){
  if (window.__imgViewerModalFixed) return; window.__imgViewerModalFixed = true;
  let imgViewerModal = document.getElementById('imgViewerModal');
  let imgViewerImg = document.getElementById('imgViewerImg');
  let imgViewerClose = document.getElementById('imgViewerClose');
  if (!imgViewerModal) {
    const html = `
      <div id="imgViewerModal" style="display:none;position:fixed;z-index:4000;inset:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;">
        <div style="position:relative;max-width:90vw;max-height:90vh;">
          <img id="imgViewerImg" src="" alt="Photo" style="max-width:90vw;max-height:90vh;border-radius:10px;box-shadow:0 8px 32px #0008;display:block;" />
          <button id="imgViewerClose" style="position:absolute;top:8px;right:8px;background:#fff;border-radius:50%;border:0;width:36px;height:36px;font-size:22px;cursor:pointer;box-shadow:0 2px 8px #0004;">&times;</button>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
    imgViewerModal = document.getElementById('imgViewerModal');
    imgViewerImg = document.getElementById('imgViewerImg');
    imgViewerClose = document.getElementById('imgViewerClose');
  }
  function closeImgViewer() {
    if (imgViewerModal) imgViewerModal.style.display = 'none';
    if (imgViewerImg) imgViewerImg.src = '';
  }
  if (imgViewerClose) {
    imgViewerClose.onclick = function(e) { e.stopPropagation(); closeImgViewer(); };
  }
  if (imgViewerModal) {
    imgViewerModal.onclick = function(e) { if (e.target === imgViewerModal) closeImgViewer(); };
  }
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && imgViewerModal && imgViewerModal.style.display === 'flex') closeImgViewer();
  });
  // Table photo click
  const userTableBody = document.getElementById('userTableBody');
  if (userTableBody) {
    userTableBody.addEventListener('click', function(e) {
      const img = e.target.closest('img.user-photo');
      if (img && imgViewerModal && imgViewerImg) {
        imgViewerImg.src = img.src;
        imgViewerModal.style.display = 'flex';
      }
    });
  }
  // Modal photo click
  const ve_photoPreview = document.getElementById('ve_photoPreview');
  if (ve_photoPreview) {
    ve_photoPreview.addEventListener('click', function() {
      if (ve_photoPreview.src && imgViewerModal && imgViewerImg) {
        imgViewerImg.src = ve_photoPreview.src;
        imgViewerModal.style.display = 'flex';
      }
    });
  }
})();
    </script>
  <script src="./profile_dropdown.js"></script>
  <script>
  // --- Cropper.js integration for photo upload ---
  let cropper;
  const vePhotoInput = document.getElementById('ve_photo_url');
  const cropperModal = document.getElementById('cropperModal');
  const cropperImage = document.getElementById('cropperImage');
  const cropperCancelBtn = document.getElementById('cropperCancelBtn');
  const cropperCropBtn = document.getElementById('cropperCropBtn');
  const vePhotoPreview = document.getElementById('ve_photoPreview');
  const veFileStatus = document.getElementById('ve_fileStatus');

  if (vePhotoInput) {
    vePhotoInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && /^image\//.test(file.type)) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          cropperImage.src = evt.target.result;
          cropperModal.style.display = 'flex';
          if (cropper) cropper.destroy();
          cropper = new Cropper(cropperImage, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 1,
          });
        };
        reader.readAsDataURL(file);
      }
    });
  }

  if (cropperCancelBtn) {
    cropperCancelBtn.onclick = function() {
      cropperModal.style.display = 'none';
      if (cropper) cropper.destroy();
      vePhotoInput.value = '';
    };
  }

  if (cropperCropBtn) {
    cropperCropBtn.onclick = function() {
      if (cropper) {
        cropper.getCroppedCanvas({width:256,height:256}).toBlob(function(blob) {
          const url = URL.createObjectURL(blob);
          vePhotoPreview.src = url;
          vePhotoPreview.style.display = 'block';
          veFileStatus.textContent = 'Photo ready';
          cropperModal.style.display = 'none';
          cropper.destroy();
          // Optionally, you can store the blob for upload
          vePhotoInput.croppedBlob = blob;
        }, 'image/png');
      }
    };
  }
  </script>
  <script>
  // Ensure notifPanel lives at the end of <body> to avoid stacking/transform issues
  (function(){
    try {
      function ensurePanelInBody(){
        const panel = document.getElementById('notifPanel');
        if (!panel) return;
        // If panel isn't already a direct child of body, move it
        if (panel.parentNode && panel.parentNode !== document.body) {
          try { document.body.appendChild(panel); panel.style.position = 'fixed'; } catch(_){}
        }
      }

      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ensurePanelInBody); else ensurePanelInBody();

      // Local toggle fallback (keeps using inline forced styles)
      const btn = document.getElementById('notifBtn');
      const panel = document.getElementById('notifPanel');
      if (!btn || !panel) return;
      if (btn._notifLocalAttached) return; btn._notifLocalAttached = true;
      btn.addEventListener('click', function(e){
        e && e.stopPropagation && e.stopPropagation();
        const open = panel.getAttribute('data-open') === 'true';
        if (open) {
          panel.setAttribute('data-open','false');
          panel.style.display = 'none'; panel.style.visibility = 'hidden'; panel.style.opacity = '0';
          btn.setAttribute('aria-expanded','false');
          console.debug && console.debug('local: notifPanel closed');
        } else {
          panel.setAttribute('data-open','true');
          panel.style.display = 'block'; panel.style.visibility = 'visible'; panel.style.opacity = '1'; panel.style.zIndex = '9999';
          btn.setAttribute('aria-expanded','true');
          console.debug && console.debug('local: notifPanel opened (forced)');
        }
      });
    } catch(e){ console.debug && console.debug('local notif handler error', e); }
  })();
  </script>

  <script>
  (function(){
    if (window.__sidebarLogoutHandlerAdded) return; window.__sidebarLogoutHandlerAdded = true;
    function attachLogout(){
      const sidebarLogout = document.getElementById('sidebarLogoutBtn');
      if (!sidebarLogout) return;
      // logout handled by modal-driven handler appended below
    }
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attachLogout); else attachLogout();
  })();
  </script>
    <!-- Confirm modal for logout -->
    <div id="confirmModalLogout" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;z-index:3000">
      <div style="background:#fff;border-radius:12px;padding:18px;max-width:420px;width:92%;box-shadow:0 12px 40px rgba(2,6,23,0.2)">
        <h3 id="confirmModalLogoutTitle" style="margin:0 0 8px 0;font-size:16px;font-weight:700">Confirm</h3>
        <div id="confirmModalLogoutMessage" style="font-size:15px;margin-bottom:12px;color:#111">Are you sure you want to sign out?</div>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="confirmModalLogoutCancel" style="background:#6c757d;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer">Cancel</button>
          <button id="confirmModalLogoutOk" style="background:#00723f;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer">Confirm</button>
        </div>
      </div>
    </div>
    <script>
    (function(){
      function attachLogout(){
        const sidebarLogout = document.getElementById('sidebarLogoutBtn');
        if (!sidebarLogout) return;
        if (sidebarLogout._logoutHandlerAttached) return;
        sidebarLogout._logoutHandlerAttached = true;
        const confirmModal = document.getElementById('confirmModalLogout');
        const confirmOk = document.getElementById('confirmModalLogoutOk');
        const confirmCancel = document.getElementById('confirmModalLogoutCancel');
        function doLogout(){
          const profileLogout = document.getElementById('accountLogout');
          if (profileLogout) { profileLogout.click(); return; }
          if (typeof window.signOutAndRedirect === 'function') { window.signOutAndRedirect(); return; }
          try { localStorage.removeItem('authToken'); } catch(e){}
          window.location.href = 'login.html';
        }
        sidebarLogout.addEventListener('click', () => {
          if (!confirmModal || !confirmOk || !confirmCancel) { if (confirm('Are you sure you want to sign out?')) doLogout(); return; }
          confirmModal.style.display = 'flex';
          function cleanup(){ confirmModal.style.display = 'none'; confirmOk.removeEventListener('click', onOk); confirmCancel.removeEventListener('click', onCancel); document.removeEventListener('keydown', onKeyDown); }
          function onOk(){ cleanup(); doLogout(); }
          function onCancel(){ cleanup(); }
          function onKeyDown(e){ if (e.key === 'Escape') cleanup(); }
          confirmOk.addEventListener('click', onOk);
          confirmCancel.addEventListener('click', onCancel);
          document.addEventListener('keydown', onKeyDown);
        });
      }
      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attachLogout); else attachLogout();
    })();
    </script>
  <div id="profileModal" style="display:none; position:fixed; inset:0; z-index:4000;">
    <div class="profile-panel" style="background:#fff;border-radius:12px;padding:18px;position:relative;max-width:1600px;width:100%;overflow:auto;box-shadow: var(--card-shadow); margin:0 auto;">
      <div class="profile-panel" style="background:#fff;border-radius:12px;padding:18px;position:relative;max-width:1600px;width:100%;max-height:calc(100vh - 160px);overflow:auto;box-shadow: var(--card-shadow); margin:0 auto;">
        <button aria-label="Hide profile" id="closeProfileBtn" style="position:absolute; right:12px; top:12px; background:#fff; border:1px solid #e5e7eb; color:#166534; padding:6px 8px; border-radius:6px; cursor:pointer;">Hide</button>
        
        <!-- BEGIN: Inserted Profile Content -->
        <div class="modal-content">
            <h3 class="text-xl font-semibold text-green-700">INDIVIDUAL INVENTORY</h3>
        </div>

        <!-- Data Privacy Statement -->
        <div class="border border-gray-300 p-3 mb-6 text-sm text-gray-700 rounded">
            <p><strong>Data Privacy Statement</strong></p>
            <p>
                Romblon State University respects your right to privacy and is committed to protecting
                the confidentiality of your personal information. By filling out this form, you are consenting
                to the collection, processing, and use of the information in accordance with this privacy notice.
                The information you have provided is used for access provision, attendance, monitoring,
                evaluation, documentation, and communication purposes. The University shall only retain
                the said personal information until it serves its purpose, after which it shall be securely
                disposed of.
            </p>
            <div class="mt-2 flex items-center">
                <input type="checkbox" id="privacyAgreement" disabled class="accent-green-700 mr-2">
                <label for="privacyAgreement" class="text-sm">I agree that my personal data shall be used as stated in the Data Privacy Notice.</label>
            </div>
        </div>

        <!-- Student Info Fields -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
            <div class="md:col-span-3 space-y-4">
                <!-- Student ID -->
                <div class="flex items-center border border-gray-400">
                    <label class="w-28 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Student ID:</label>
                    <input id="studentIdInput" type="text" value="001-2022-000523" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
                </div>

                <!-- Name -->
                <div class="flex items-center border border-gray-400">
                    <label class="w-28 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Name:</label>
                    <div class="flex-1 grid grid-cols-4 divide-x divide-gray-400">
                        <input id="lastNameInput" type="text" value="Falcutila" placeholder="Last Name" class="p-2 text-sm w-full border-none focus:ring-0" readonly>
                        <input id="firstNameInput" type="text" value="Marc Benedic" placeholder="First Name" class="p-2 text-sm w-full border-none focus:ring-0" readonly>
                        <input id="middleInitialInput" type="text" value="M" placeholder="Middle Initial" class="p-2 text-sm w-full border-none focus:ring-0" readonly>
                        <input id="suffix" type="text" disabled class="p-2 text-sm w-full border-none focus:ring-0" placeholder="Suffix (optional)">
    </div>
                </div>

                <!-- Program and Year Level (Horizontal Layout) -->
                <div class="flex border border-gray-400">
                    <!-- Program -->
                    <div class="flex flex-1 items-center border-r border-gray-400">
                        <label class="w-32 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Program:</label>
                        <input id="programInput" type="text" value="BSE" placeholder="e.g., BS in Computer Science" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
                    </div>

                    <!-- Year Level -->
                    <div class="flex flex-1 items-center">
                        <label class="w-32 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Year Level:</label>
                        <input id="year_level" type="text" value="4th Year" placeholder="e.g., 2nd Year" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
                    </div>
                </div>

                <!-- Campus and College -->
                <div class="flex border border-gray-400">
                    <!-- Campus -->
                    <div class="flex flex-1 items-center border-r border-gray-400">
                        <label class="w-32 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Campus:</label>
                        <input id="campusInput" type="text" value="Main Campus" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
                    </div>

                    <!-- College -->
                    <div class="flex flex-1 items-center">
                        <label class="w-32 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">College:</label>
                        <input id="collegeInput" type="text" value="College of Education" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
                    </div>
                </div>

                <!-- Academic Year Admitted -->
                <div>
                    <label class="block font-semibold">Academic Year Admitted</label>
                    <div class="flex items-center gap-4 mt-1">
                    <label class="flex items-center gap-1">
                      <!-- name changed to match mapper: 'academic_admit_sem' -->
                      <input type="radio" name="academic_admit_sem" value="1st Sem" disabled class="accent-green-700"> 1st Sem
                    </label>
                    <label class="flex items-center gap-1">
                      <input type="radio" name="academic_admit_sem" value="2nd Sem" disabled class="accent-green-700"> 2nd Sem
                    </label>
            <div class="flex items-center gap-2">
              <span>Year</span>
              <!-- give an id so mapper can set this value from student data -->
              <input id="admit_year_from" type="text" value="2022 - 2023" class="bg-gray-100 p-2 rounded border w-32" readonly>
            </div>
                    </div>
                </div>

                <!-- Status of Enrolment -->
                <div>
                    <label class="block font-semibold">Status of Enrolment</label>
                    <div class="flex items-center gap-4 mt-1">
            <label class="flex items-center gap-1">
              <input type="radio" name="status_of_enrollment" value="new" disabled class="accent-green-700" > New
            </label>
            <label class="flex items-center gap-1">
              <input type="radio" name="status_of_enrollment" value="transferee" disabled class="accent-green-700"> Transferee
            </label>
            <label class="flex items-center gap-1">
              <input type="radio" name="status_of_enrollment" value="returnee" disabled class="accent-green-700"> Returnee
            </label>
                    </div>
                </div>

                <!-- Account Status -->
                <div class="flex items-center border border-gray-400">
                    <label class="w-48 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Account Status:</label>
                    <div class="flex items-center gap-4 px-3">
            <label class="flex items-center gap-1">
              <input type="radio" name="accountStatus" value="enabled" disabled class="accent-green-700" > Enabled
            </label>
            <label class="flex items-center gap-1">
              <input type="radio" name="accountStatus" value="disabled" disabled class="accent-green-700"> Disabled
            </label>
                    </div>
                </div>
            </div>

            <!-- Improved 1x1 Photo Section -->
            <div class="photo-container flex flex-col items-center justify-center p-4 border-2 border-dashed border-green-300 rounded-xl bg-green-50 transition-all duration-300">
                <div class="relative w-40 h-48 mb-3 rounded-md overflow-hidden bg-white shadow-md">
                    <input 
                        id="photoInput" 
                        type="file" 
                        accept="image/*" 
                        class="absolute inset-0 opacity-0 cursor-pointer z-10" 
                        onchange="previewPhoto(event)" 
                        aria-label="Choose profile photo" 
                        disabled 
                    />
                    <div id="photoPlaceholder" class="w-full h-full flex flex-col items-center justify-center text-gray-500">
                        <i class="fas fa-camera text-3xl mb-2 text-green-500"></i>
                        <span class="text-xs text-center px-2">1x1 ID Photo</span>
                    </div>
                    <img id="photoPreview" src="" alt="Student Photo" class="hidden w-full h-full object-cover">
                </div>
                
                <div class="text-center">
                    <p class="text-xs text-gray-600 mb-2">Profile photo</p>
                </div>
                
                <div class="mt-3 text-center">
                    <p class="text-xs text-gray-500"></p>
                </div>
            </div>
        </div>

        <!-- Section 1: Background Information -->
        <section class="bg-white mt-8 p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-green-700">I. Background Information</h3>
            </div>

            <!-- Present Address -->
            <div class="flex items-center border border-gray-400">
                <label class="w-48 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Present Address:</label>
                <input id="present_address" type="text" value="Odiongan, Romblon" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
            </div>

      <!-- FB Messenger -->
      <div class="flex items-center border border-t-0 border-gray-400">
        <label class="w-48 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">FB Messenger:</label>
        <input id="fbMessengerInput" type="text" value="jerrygoco.fb" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
      </div>

            <!-- Permanent Address -->
            <div class="flex items-center border border-t-0 border-gray-400">
                <label class="w-48 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Permanent Address:</label>
                <input id="permanent_address" type="text" value="Odiongan, Romblon" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
            </div>
            <div class="flex items-center gap-2 mt-2 ml-1">
                <input type="checkbox" id="sameAddress" disabled class="accent-green-700" >
                <label for="sameAddress" class="text-gray-700 text-sm">Check if same as present address</label>
            </div>

            <!-- Email -->
            <div class="flex items-center border border-t-0 border-gray-400 mt-2">
                <label class="w-48 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Email Address:</label>
                <input id="emailInput" type="email" value="falcutilamarc23@gmail.com" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
            </div>

            <!-- Birth Info -->
            <div class="grid grid-cols-1 md:grid-cols-3 border border-t-0 border-gray-400">
                <div class="flex items-center border-r border-gray-400">
                    <label class="w-48 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Date of Birth:</label>
                    <input id="dobInput" type="date" value="2004-06-15" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
                </div>
                <div class="flex items-center border-r border-gray-400">
                    <label class="w-32 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Contact No.:</label>
                    <input id="contact_no" type="text" value="09345678919" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
                </div>
                <div class="flex items-center">
                    <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Place of Birth:</label>
                    <input id="place_of_birth" aria-label="Place of birth" type="text" value="Odiongan, Romblon" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
                </div>
            </div>

            <!-- Sex, Age, Civil Status, Religion -->
            <div class="grid grid-cols-1 md:grid-cols-4 border border-t-0 border-gray-400">
                <div class="flex items-center border-r border-gray-400">
                    <label class="w-32 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Sex:</label>
                    <input id="sexInput" type="text" value="Male" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
                </div>
                <div class="flex items-center border-r border-gray-400">
                    <label class="w-32 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Age:</label>
                    <input id="ageInput" type="number" value=" " class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
                </div>
                <div class="flex items-center border-r border-gray-400">
                    <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Civil Status:</label>
                    <div class="flex gap-3 px-2">
                        <label class="flex items-center gap-1 text-sm"><input type="radio" name="civilStatus" disabled class="accent-green-700" > Single</label>
                        <label class="flex items-center gap-1 text-sm"><input type="radio" name="civilStatus" disabled class="accent-green-700"> Married</label>
                        <label class="flex items-center gap-1 text-sm"><input type="radio" name="civilStatus" disabled class="accent-green-700"> Others</label>
                    </div>
                </div>
                <div class="flex items-center">
                    <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Religion:</label>
                    <input id="religionInput" type="text" value="Roman Catholic" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
                </div>
            </div>

            <!-- If Married -->
            <div class="grid grid-cols-1 md:grid-cols-4 border border-t-0 border-gray-400">
                <div class="flex items-center border-r border-gray-400">
                  <label class="w-56 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Name of Spouse:</label>
                  <input id="name_of_spouse" aria-label="Name of spouse" type="text" value="" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
                </div>
                <div class="flex items-center border-r border-gray-400">
                    <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Occupation:</label>
                    <input type="text" value="" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
                </div>
        <div class="flex items-center border-r border-gray-400">
          <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">No. of Children:</label>
          <input id="numChildrenInput" type="number" value="" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
        </div>
                <div class="flex items-center">
                    <label class="w-56 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Address of Spouse:</label>
                    <input type="text" value="" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
                </div>
            </div>

            <!-- IP Member -->
            <div class="flex items-center border border-t-0 border-gray-400">
                <label class="w-80 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Member of Indigenous People Community?</label>
                <div class="flex items-center gap-3 px-2">
                    <label class="flex items-center gap-1"><input type="radio" name="ipMember" disabled class="accent-green-700"> Yes</label>
                    <label class="flex items-center gap-1"><input type="radio" name="ipMember" disabled class="accent-green-700" > No</label>
                    <input type="text" placeholder="If yes, specify group" class="p-1 border rounded text-sm bg-gray-100 w-56" readonly>
                </div>
            </div>

            <!-- Present Living Arrangement -->
            <div class="border border-t-0 border-gray-400">
                <label class="block bg-gray-100 border-b border-gray-400 px-2 py-2 font-semibold text-sm">Present Living Arrangement:</label>
                <div class="flex flex-wrap gap-3 px-3 py-2">
                    <label class="flex items-center gap-1"><input type="radio" name="livingArrangement" disabled class="accent-green-700"> Own House</label>
                    <label class="flex items-center gap-1"><input type="radio" name="livingArrangement" disabled class="accent-green-700"> Apartment</label>
                    <label class="flex items-center gap-1"><input type="radio" name="livingArrangement" disabled class="accent-green-700"> Boarding House</label>
                    <label class="flex items-center gap-1"><input type="radio" name="livingArrangement" disabled class="accent-green-700"> Living with Relatives/Non-Relatives</label>
                </div>

                <div class="flex border-t border-gray-400">
                    <label class="w-64 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Name of Landlord/Landlady:</label>
                    <input id="landlordNameInput" aria-label="Landlord name" type="text" value="" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
        </div>
        <div class="flex border-t border-gray-400">
          <label class="w-64 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Contact Number:</label>
          <input id="landlordContactInput" aria-label="Landlord contact number" type="text" value="" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
        </div>
            </div>
        </section>

        <!-- Section 2: Family Background -->
        <section class="bg-white mt-8 p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-green-700">II. Family Background</h3>
            </div>

            <!-- FATHER INFORMATION -->
            <h4 class="text-md font-semibold text-gray-800 mb-2">Father's Information</h4>
            <div class="border border-gray-400 rounded-md overflow-hidden text-sm text-gray-700">
                <div class="flex items-center border-b border-gray-400">
                    <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">Father's Name</label>
                    <input id="father" aria-label="Father name" type="text" value="jh" class="flex-1 p-2 border-none focus:ring-0" readonly>
        </div>
        <div class="flex items-center border-b border-gray-400">
          <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">Age</label>
          <input id="fatherAgeInput" aria-label="Father age" type="number" value="50" class="flex-1 p-2 border-none focus:ring-0" readonly>
        </div>
        <div class="flex items-center border-b border-gray-400">
          <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">Occupation</label>
          <input id="fatherOccupationInput" aria-label="Father occupation" type="text" value="Fisherman" class="flex-1 p-2 border-none focus:ring-0" readonly>
        </div>
                <div class="flex items-center border-b border-gray-400">
                    <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">Contact No.</label>
                    <input id="fatherMobile" aria-label="Father contact number" type="text" value="09" class="flex-1 p-2 border-none focus:ring-0" readonly>
                  </div>
                <div class="flex items-center border-b border-gray-400">
                    <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">Father's Address</label>
                    <input id="father_address" aria-label="Father address" type="text" value="09" class="flex-1 p-2 border-none focus:ring-0" readonly>
                  </div>
                
            </div>

            <!-- MOTHER INFORMATION -->
            <h4 class="text-md font-semibold text-gray-800 mt-6 mb-2">Mother's Information</h4>
            <div class="border border-gray-400 rounded-md overflow-hidden text-sm text-gray-700">
                <div class="flex items-center border-b border-gray-400">
                  <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">Mother's Name</label>
                  <input id="mother" aria-label="Mother name" type="text" value="vjv" class="flex-1 p-2 border-none focus:ring-0" readonly>
                </div>
        <div class="flex items-center border-b border-gray-400">
          <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">Age</label>
          <input id="mother_age" aria-label="Mother age" type="number" value="48" class="flex-1 p-2 border-none focus:ring-0" readonly>
        </div>
        <div class="flex items-center border-b border-gray-400">
          <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">Occupation</label>
          <input id="mother_occupation" aria-label="Mother occupation" type="text" value="Vendor" class="flex-1 p-2 border-none focus:ring-0" readonly>
        </div>
                <div class="flex items-center border-b border-gray-400">
                    <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">Contact No.</label>
                  <input id="motherMobile" aria-label="Mother contact number" type="text" value="09" class="flex-1 p-2 border-none focus:ring-0" readonly>
                </div>
                <div class="flex items-center border-b border-gray-400">
                    <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">Mother's Address</label>
                  <input id="mother_address" aria-label="Mother address" type="text" value="Odiongan, Romblon" class="flex-1 p-2 border-none focus:ring-0" readonly>
                </div>
                
            </div>

            <!-- ADDITIONAL FAMILY INFO -->
            <h4 class="text-md font-semibold text-gray-800 mt-6 mb-2">Additional Family Details</h4>
            <div class="border border-gray-400 rounded-md overflow-hidden text-sm text-gray-700">
                <div class="flex items-center border-b border-gray-400">
                    <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">Birth Order</label>
                    <input type="text" value="1st" class="flex-1 p-2 border-none focus:ring-0" readonly>
                </div>
        <div class="flex items-center border-b border-gray-400">
          <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">No. of Brothers</label>
          <input id="numBrothersInput" aria-label="Number of brothers" type="number" value="1" class="flex-1 p-2 border-none focus:ring-0" readonly>
        </div>
        <div class="flex items-center border-b border-gray-400">
          <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">No. of Sisters</label>
          <input id="numSistersInput" aria-label="Number of sisters" type="number" value="0" class="flex-1 p-2 border-none focus:ring-0" readonly>
        </div>
            </div>

            <!-- LEGAL GUARDIAN -->
            <h4 class="text-md font-semibold text-gray-800 mt-6 mb-2">Legal Guardian Information</h4>
            <div class="border border-gray-400 rounded-md overflow-hidden text-sm text-gray-700">
        <div class="flex items-center border-b border-gray-400">
          <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">Guardian's Name</label>
          <input id="guardianNameInput" aria-label="Guardian name" type="text" value="" class="flex-1 p-2 border-none focus:ring-0" readonly>
        </div>
        <div class="flex items-center border-b border-gray-400">
          <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">Relationship</label>
          <input id="guardianRelationshipInput" aria-label="Guardian relationship" type="text" value="" class="flex-1 p-2 border-none focus:ring-0" readonly>
        </div>
        <div class="flex items-center border-b border-gray-400">
          <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">Contact No.</label>
          <input id="guardianContactInput" aria-label="Guardian contact" type="text" value="" class="flex-1 p-2 border-none focus:ring-0" readonly>
        </div>
        <div class="flex items-center">
          <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold">Address</label>
          <input id="guardianAddressInput" aria-label="Guardian address" type="text" value="" class="flex-1 p-2 border-none focus:ring-0" readonly>
        </div>
            </div>

            <!-- MARITAL STATUS -->
            <h4 class="text-md font-semibold text-gray-800 mt-6 mb-2">Marital Status of Parents</h4>
            <div class="p-2 flex flex-wrap gap-4 text-sm">
                <label><input type="radio" name="parentsMaritalStatus" disabled class="accent-green-700" > Living Together</label>
                <label><input type="radio" name="parentsMaritalStatus" disabled class="accent-green-700"> Separated</label>
                <label><input type="radio" name="parentsMaritalStatus" disabled class="accent-green-700"> One/Both Deceased</label>
                <label><input type="radio" name="parentsMaritalStatus" disabled class="accent-green-700"> Solo Parent (Mother/Father)</label>
                <label class="flex items-center gap-1"><input type="radio" name="parentsMaritalStatus" disabled class="accent-green-700"> Others: <input type="text" class="border-b border-gray-400 bg-transparent w-32 focus:outline-none" readonly></label>
            </div>

            <!-- RELATIONSHIPS -->
            <h4 class="text-md font-semibold text-gray-800 mt-6 mb-2">Current Description of Home Life</h4>
            <div class="space-y-3 text-sm text-gray-700">
                <div class="flex flex-wrap gap-4">
                    <label class="font-semibold">Relationship with Mother:</label>
                    <label><input type="radio" name="relationship_parent_mother" disabled class="accent-green-700"> Very Close</label>
                    <label><input type="radio" name="relationship_parent_mother" disabled class="accent-green-700"> Close</label>
                    <label><input type="radio" name="relationship_parent_mother" disabled class="accent-green-700"> Distant</label>
                </div>
                <div class="flex flex-wrap gap-4">
                    <label class="font-semibold">Relationship with Father:</label>
                    <label><input type="radio" name="relationship_parent_father" disabled class="accent-green-700"> Very Close</label>
                    <label><input type="radio" name="relationship_parent_father" disabled class="accent-green-700"> Close</label>
                    <label><input type="radio" name="relationship_parent_father" disabled class="accent-green-700"> Distant</label>
                </div>
                 <div class="flex flex-wrap gap-4">
                    <label class="font-semibold">Relationship with Sibling/s:</label>
                    <label><input type="radio" name="relationship_siblings" disabled class="accent-green-700"> Very Close</label>
                    <label><input type="radio" name="relationship_siblings" disabled class="accent-green-700"> Close</label>
                    <label><input type="radio" name="relationship_siblings" disabled class="accent-green-700"> Distant</label>
                </div>
                <div class="flex flex-wrap gap-4">
                    <label class="font-semibold">Relationship with Spouse:</label>
                    <label><input type="radio" name="relationship_spouse" disabled class="accent-green-700"> Very Close</label>
                    <label><input type="radio" name="relationship_spouse" disabled class="accent-green-700"> Close</label>
                    <label><input type="radio" name="relationship_spouse" disabled class="accent-green-700"> Distant</label>
                </div>
                 <div class="flex flex-wrap gap-4">
                    <label class="font-semibold">Relationship with Children:</label>
                    <label><input type="radio" name="relationship_children" disabled class="accent-green-700"> Very Close</label>
                    <label><input type="radio" name="relationship_children" disabled class="accent-green-700"> Close</label>
                    <label><input type="radio" name="relationship_children" disabled class="accent-green-700"> Distant</label>
                </div>
            </div>

            <!-- SIBLINGS ENROLLED AT RSU -->
            <h4 class="text-md font-semibold text-gray-800 mt-6 mb-2">Siblings Enrolled at RSU</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full border text-gray-700 text-sm">
                    <thead class="bg-green-50 text-green-700">
                        <tr>
                            <th class="p-2 border">Name</th>
                            <th class="p-2 border">Program & Year Level</th>
                            <th class="p-2 border">Contact No.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border p-2"><input type="text" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                            <td class="border p-2"><input type="text" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                            <td class="border p-2"><input type="text" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- HOUSEHOLD INFO -->
            <div class="mt-6 flex flex-col md:flex-row gap-4">
        <div class="flex-1 flex items-center border border-gray-400 rounded">
          <label class="w-64 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Number of persons in the household:</label>
          <input id="householdCountInput" aria-label="Number of persons in the household" type="number" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
        </div>
                <div class="flex-1 flex items-center border border-gray-400 rounded">
                    <label class="w-40 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">Head of Household:</label>
                    <input type="text" class="flex-1 p-2 text-sm border-none focus:ring-0" readonly>
                </div>
            </div>

            <!-- FAMILY INCOME -->
            <h4 class="text-md font-semibold text-gray-800 mt-6 mb-2">Estimated Family Monthly Income</h4>
            <div class="flex flex-col mt-2 space-y-1 text-sm text-gray-700">
                <label><input type="radio" name="familyIncome" disabled class="accent-green-700"> Less than â‚±10,957</label>
                <label><input type="radio" name="familyIncome" disabled class="accent-green-700" > â‚±9,520 â€“ â‚±21,194</label>
                <label><input type="radio" name="familyIncome" disabled class="accent-green-700"> â‚±21,194 â€“ â‚±43,828</label>
                <label><input type="radio" name="familyIncome" disabled class="accent-green-700"> â‚±43,828 â€“ â‚±76,669</label>
                <label><input type="radio" name="familyIncome" disabled class="accent-green-700"> â‚±76,669 â€“ â‚±131,484</label>
                <label><input type="radio" name="familyIncome" disabled class="accent-green-700"> â‚±131,484 â€“ â‚±219,140</label>
                <label><input type="radio" name="familyIncome" disabled class="accent-green-700"> â‚±219,140 and up</label>
            </div>
        </section>

        <!-- Section 3: Medical History -->
        <section class="bg-white mt-8 p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-green-700">III. Medical History</h3>
            </div>

            <!-- Therapy / Counseling -->
            <div class="flex items-center border border-gray-400">
                <label class="w-80 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">
                    Have you received therapy, counseling, or treatment in the past?
                </label>
                <div class="flex items-center gap-4 px-3">
          <label class="flex items-center gap-1">
            <input id="therapyYes" type="radio" name="therapyReceived" value="yes" disabled class="accent-green-700"> Yes
          </label>
          <label class="flex items-center gap-1">
            <input id="therapyNo" type="radio" name="therapyReceived" value="no" disabled class="accent-green-700"> No
          </label>
                </div>
        <input id="therapyDetailsInput" type="text" placeholder="If Yes, when and with whom?" class="flex-1 p-2 text-sm border-l border-gray-400 focus:ring-0 bg-gray-100" readonly aria-label="Therapy details">
            </div>

            <!-- Physical Disability -->
            <div class="flex border border-t-0 border-gray-400">
              <label class="w-60 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">
                Physical Disability:
              </label>
              <input id="physical_disability" aria-label="Physical disability" type="text" value="" class="flex-1 p-2 text-sm border-none focus:ring-0 bg-gray-100" readonly>
              <label class="w-40 bg-gray-100 border-x border-gray-400 px-2 py-2 font-semibold text-sm">
                PWD ID No.:
              </label>
          <input id="physical_pwd_id" type="text" value="" class="w-48 p-2 text-sm border-none focus:ring-0 bg-gray-100" readonly>
            </div>

            <!-- Psychosocial Disability -->
            <div class="flex border border-t-0 border-gray-400">
                <label class="w-60 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">
                        Psychosocial Disability:
                    </label>
                    <input id="psychosocial_disability" aria-label="Psychosocial disability" type="text" value="" class="flex-1 p-2 text-sm border-none focus:ring-0 bg-gray-100" readonly>
            <label class="w-40 bg-gray-100 border-x border-gray-400 px-2 py-2 font-semibold text-sm">
              PWD ID No.:
            </label>
            <input id="psychosocial_pwd_id" type="text" value="" class="w-48 p-2 text-sm border-none focus:ring-0 bg-gray-100" readonly>
            </div>

            <!-- Current Medications -->
            <div class="flex border border-t-0 border-gray-400">
                <label class="w-60 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">
                    Current Medications:
                </label>
                <input type="text" value="" class="flex-1 p-2 text-sm border-none focus:ring-0 bg-gray-100" readonly>
            </div>

            <!-- PWD Status -->
            <div class="flex items-center border border-t-0 border-gray-400">
                <label class="w-80 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">
                    Person with Disability (PWD)?
                </label>
                <div class="flex items-center gap-4 px-3">
          <label class="flex items-center gap-1">
            <input id="pwdYes" type="radio" name="pwdStatus" value="yes" disabled class="accent-green-700"> Yes
          </label>
          <label class="flex items-center gap-1">
            <input id="pwdNo" type="radio" name="pwdStatus" value="no" disabled class="accent-green-700" > No
          </label>
                </div>
            </div>
        </section>
        <!-- Section 4: Educational Background -->
        <section class="bg-white mt-8 p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-green-700">IV. Educational Background</h3>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full border text-gray-700 text-sm">
                    <thead class="bg-green-50 text-green-700">
                        <tr>
                            <th class="p-2 border">Level</th>
                            <th class="p-2 border">School Name</th>
                            <th class="p-2 border">Year Graduated</th>
                            <th class="p-2 border">Honors Received</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border p-2">Elementary</td>
                            <td class="border p-2"><input type="text" value="Odiongan Central School" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                            <td class="border p-2"><input type="number" value="2015" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                            <td class="border p-2"><input type="text" value="With Honors" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                        </tr>
                        <tr>
                            <td class="border p-2">Junior High</td>
                            <td class="border p-2"><input type="text" value="RSU Laboratory High School" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                            <td class="border p-2"><input type="number" value="2019" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                            <td class="border p-2"><input type="text" value="â€”" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                        </tr>
                        <tr>
                            <td class="border p-2">Senior High</td>
                            <td class="border p-2"><input type="text" value="RSU Laboratory SHS" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                            <td class="border p-2"><input type="number" value="2021" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                            <td class="border p-2"><input type="text" value="â€”" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- V. Employment History -->
        <section class="bg-white mt-8 p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-green-700">V. Employment History</h3>
            </div>

            <!-- Work Experience -->
            <div class="flex items-center border border-gray-400">
                <label class="w-80 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">
                    Do you have a work experience?
                </label>
                <div class="flex items-center gap-4 px-3">
          <label class="flex items-center gap-1">
            <input id="workExpYes" type="radio" name="workExperience" value="yes" disabled class="accent-green-700"> Yes
          </label>
          <label class="flex items-center gap-1">
            <input id="workExpNo" type="radio" name="workExperience" value="no" disabled class="accent-green-700"> No
          </label>
                </div>
                <span class="text-gray-700 px-2 text-sm">(If yes, please fill out the table below.)</span>
            </div>

            <!-- Employment Table -->
            <div class="overflow-x-auto border border-t-0 border-gray-400">
                <table class="min-w-full text-gray-700 text-sm">
                    <thead class="bg-green-50 text-green-700">
                        <tr>
                            <th class="p-2 border">Position Title</th>
                            <th class="p-2 border">Agency/Company/Organization</th>
                            <th class="p-2 border">Status of Appointment</th>
                            <th class="p-2 border">Inclusive Dates From</th>
                            <th class="p-2 border">Inclusive Dates To</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border p-2"><input type="text" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                            <td class="border p-2"><input type="text" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                            <td class="border p-2"><input type="text" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                            <td class="border p-2"><input type="date" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                            <td class="border p-2"><input type="date" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                        </tr>
                        <tr>
                            <td class="border p-2"><input type="text" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                            <td class="border p-2"><input type="text" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                            <td class="border p-2"><input type="text" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                            <td class="border p-2"><input type="date" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                            <td class="border p-2"><input type="date" class="bg-gray-100 p-1 rounded w-full border" readonly></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- VI. Other Relevant Information -->
        <section class="bg-white mt-8 p-6 rounded-xl shadow-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-green-700">VI. Other Relevant Information</h3>
            </div>

            <!-- Scholarship -->
            <div class="flex items-center border border-gray-400">
                <label class="w-80 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">
                    Are you enjoying any scholarship grant/s?
                </label>
                <div class="flex items-center gap-4 px-3">
                    <label class="flex items-center gap-1">
                        <input type="radio" name="scholarship" disabled class="accent-green-700"> Yes
                    </label>
                    <label class="flex items-center gap-1">
                        <input type="radio" name="scholarship" disabled class="accent-green-700"> No
                    </label>
                </div>
                <input type="text" placeholder="If yes, put the name of the sponsor" class="flex-1 p-2 text-sm border-l border-gray-400 bg-gray-100 focus:ring-0" readonly>
            </div>

            <!-- Interests -->
            <div class="border border-t-0 border-gray-400">
                <div class="flex border-b border-gray-400">
                    <label class="w-80 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">
                        Performing Arts (Sports, Drama, Singing, Dancing, etc.)
                    </label>
                    <input type="text" class="flex-1 p-2 text-sm bg-gray-100 border-none focus:ring-0" readonly>
                </div>
                <div class="flex border-b border-gray-400">
                    <label class="w-80 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">
                        Creative Arts (Painting, Drawing, Photography, etc.)
                    </label>
                    <input type="text" class="flex-1 p-2 text-sm bg-gray-100 border-none focus:ring-0" readonly>
                </div>
                <div class="flex border-b border-gray-400">
                    <label class="w-80 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">
                        Literary Arts (Declamation, Reading, Writing, etc.)
                    </label>
                    <input type="text" class="flex-1 p-2 text-sm bg-gray-100 border-none focus:ring-0" readonly>
                </div>
                <div class="flex">
                    <label class="w-80 bg-gray-100 border-r border-gray-400 px-2 py-2 font-semibold text-sm">
                        Others, specify:
                    </label>
                    <input type="text" class="flex-1 p-2 text-sm bg-gray-100 border-none focus:ring-0" readonly>
                </div>
            </div>

            <!-- Coping Mechanisms -->
            <div class="mt-6 border border-gray-400">
                <label class="block bg-gray-100 border-b border-gray-400 px-2 py-2 font-semibold text-sm">
                    Coping Mechanisms (How do you cope with stress?)
                </label>
                <div class="p-3">
                    <textarea class="w-full h-20 p-2 bg-gray-100 border rounded" readonly>vmjhv</textarea>
                </div>
            </div>

            <!-- People Who Can Help -->
            <div class="mt-6 border border-gray-400">
                <label class="block bg-gray-100 border-b border-gray-400 px-2 py-2 font-semibold text-sm">
                    People who can help you in times of need
                </label>
                <div class="p-3">
                    <textarea class="w-full h-20 p-2 bg-gray-100 border rounded" readonly>vj, kv</textarea>
                </div>
            </div>

            <!-- Sensitive Information -->
            <div class="mt-6 border border-gray-400">
                <label class="block bg-gray-100 border-b border-gray-400 px-2 py-2 font-semibold text-sm">
                    Sensitive Information
                </label>
                <div class="p-3 space-y-3">
                    <div class="flex items-center">
                        <label class="w-80 font-semibold">Have you experienced sensitive situations?</label>
                        <div class="flex items-center gap-4">
                            <label class="flex items-center gap-1">
                                <input type="radio" name="sensitiveExperienced" disabled class="accent-green-700"> Yes
                            </label>
                            <label class="flex items-center gap-1">
                                <input type="radio" name="sensitiveExperienced" disabled class="accent-green-700" > Not applicable
                            </label>
                        </div>
                    </div>
                    <div>
                        <label class="font-semibold">Description (if applicable):</label>
                        <textarea class="w-full h-20 p-2 bg-gray-100 border rounded mt-1" readonly></textarea>
                    </div>
                    
                </div>
            </div>
        </section>
    </div>
</div>

<script>
    function previewPhoto(event) {
        const input = event.target;
        const preview = document.getElementById('photoPreview');
        const placeholder = document.getElementById('photoPlaceholder');
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
            }
            
            reader.readAsDataURL(input.files[0]);
        }
    }
</script>
<script>
  // Collector: read all visible values from the inline profile panel and return a structured object
  // Helper: produce a safe key for Firebase from arbitrary label/text
  function sanitizeKey(raw){
    if(!raw && raw !== 0) return null;
    let k = String(raw).trim();
    if(k === '') return null;
    // normalize whitespace -> underscore, lowercase
    k = k.replace(/\s+/g, '_').toLowerCase();
    // remove forbidden Firebase characters and common punctuation we don't want in keys
    // forbidden: . # $ / [ ] and also remove ':' and other punctuation
    k = k.replace(/[.#$\/:\[\]]+/g, '');
    // strip any remaining characters that aren't alphanumeric, underscore or dash
    k = k.replace(/[^a-z0-9_\-]/g, '');
    // final trim
    k = k.trim();
    return k || null;
  }

  // Derive a DB-friendly key from element id/name/label using sanitizeKey + heuristics
  function deriveKey(raw, el){
    // Prefer explicit sanitized raw value
    let k = sanitizeKey(raw);
    // Heuristic mappings for common profile fields
    const heur = (str) => (str||'').toString().toLowerCase();
    const tryMap = (s) => {
      if(!s) return null;
      s = s.toLowerCase();
      // PWD / disability status mapping
      if((/\bpwd\b/.test(s) || /person with disability/.test(s) || /person_with_disability/.test(s) || /pwdstatus/.test(s)) && /status|pwd|has|is/.test(s)) return 'pwd';
    // Landlord / Landlady name mapping
    if(/landlord|landlady/.test(s) && /name/.test(s)) return 'name_of_landlordlandlady';
      // Specific parent/guardian age mappings should take precedence over generic `age`.
      if(/mother/.test(s) && /age/.test(s)) return 'mother_age';
      if(/father/.test(s) && /age/.test(s)) return 'father_age';
      if(/guardian/.test(s) && /age/.test(s)) return 'guardian_age';
      if(/first/.test(s) && /name|first/.test(s)) return 'first_name';
      if(/last/.test(s)) return 'last_name';
      if(/middle/.test(s) || /middle_initial/.test(s)) return 'middle_initial';
      if(/email/.test(s)) return 'email_address';
      if(/contact|phone|mobile|tel/.test(s)) return 'contact_no';
      if(/program|course|degree|programofstudy/.test(s)) return 'course';
      if(/year_level|yearlevel|year/.test(s)) return 'year_level';
      if(/studentid|student_id|id\b/.test(s)) return 'student_id';
      if(/campus/.test(s)) return 'campus';
      if(/college/.test(s)) return 'college';
      if(/address/.test(s)) return 'present_address';
      if(/placeofbirth|place_of_birth|birthplace/.test(s)) return 'place_of_birth';
      if(/dob|dateofbirth|date_of_birth/.test(s)) return 'date_of_birth';
      if(/sex|gender/.test(s)) return 'sex';
      if(/age/.test(s)) return 'age';
      if(/religion/.test(s)) return 'religion';
      if(/login/.test(s)) return 'login';
      if(/role/.test(s)) return 'role';
      return null;
    };

    // If sanitize produced a key that looks like a canonical key, use it
    if(k) {
      // If it already matches common DB keys, return
      const common = ['first_name','last_name','middle_initial','email_address','contact_no','course','year_level','student_id','campus','college','present_address','place_of_birth','date_of_birth','sex','age','religion','login','role'];
      if(common.indexOf(k) !== -1) return k;
    }

    // Try mapping from raw string heuristics
    const mapped = tryMap(raw) || (el ? tryMap(el.id || el.name || (el.getAttribute && el.getAttribute('aria-label')) || '') : null);
    if(mapped) return mapped;

    // fallback to sanitized key
    return k;
  }

  function collectTableRows(table){
    const headers = Array.from(table.querySelectorAll('thead th')).map(h=> (h.textContent||'').trim());
    const rows = Array.from(table.querySelectorAll('tbody tr'));
    return rows.map(tr => {
      const inputs = Array.from(tr.querySelectorAll('input, select, textarea'));
      if(inputs.length === 1) return (inputs[0].value || '').trim();
      const out = {};
      inputs.forEach((inp, i) => {
        const rawKey = headers[i] || inp.id || inp.name || (`col_${i}`);
        const key = sanitizeKey(rawKey) || `col_${i}`;
        out[key] = (inp.value || '').trim();
      });
      return out;
    }).filter(r => {
      if(typeof r === 'string') return r !== '';
      return Object.values(r).some(v=>v!=='' && v!=='â€”');
    });
  }

  function fetchProfileData(){
    const modal = document.getElementById('profileModal');
    if(!modal) return null;
    const data = {};

    // Radios (grouped by name)
    const radios = Array.from(modal.querySelectorAll('input[type=radio]'));
    const radioNames = Array.from(new Set(radios.map(r=>r.name).filter(Boolean)));
    radioNames.forEach(name => {
      const checked = modal.querySelector(`input[type=radio][name="${name}"]:checked`);
      // derive the radio group name as output key
      const outKey = deriveKey(name, checked) || (sanitizeKey(name) || name);
      if(checked){
        // extract human label text
        const parent = checked.parentElement;
        let labelText = '';
        if(parent){
          // look for text nodes in the parent
          const nodes = Array.from(parent.childNodes).filter(n=>n.nodeType===3 && n.textContent.trim());
          labelText = nodes.map(n=>n.textContent.trim()).join(' ').trim() || (parent.textContent||'').trim();
        }
        data[outKey] = labelText || checked.value || true;
      } else data[outKey] = null;
    });

    // Checkboxes
    const checkboxes = Array.from(modal.querySelectorAll('input[type=checkbox]'));
    checkboxes.forEach(cb => {
      const raw = cb.id || cb.name || (cb.parentElement ? (cb.parentElement.textContent||'').trim().slice(0,40) : 'checkbox');
      const key = deriveKey(raw, cb) || sanitizeKey(raw);
      if(!key) return; // skip if no valid key
      data[key] = !!cb.checked;
    });

    // Persist privacy agreement into canonical and CSV-compatible keys.
    try {
      const privacyEl = modal.querySelector('#privacyAgreement');
      if (privacyEl) {
        const checked = !!privacyEl.checked;
        // canonical boolean field
        data.field_privacy_agreement = checked;
        // a human-readable text for compatibility with CSV-imported old rows
        const ptext = 'I agree that my personal data shall be used as stated in the Data Privacy Notice.';
        if (checked) {
          data.field_privacy_agreement_text = ptext;
          // also write into column_1 for CSV-style compatibility
          data.column_1 = ptext;
        } else {
          data.field_privacy_agreement_text = '';
          // do not erase column_1 if it already had other content â€” leave it unless explicitly cleared by the admin
        }
      }
    } catch (err) { /* ignore privacy save errors */ }

    // Text inputs, selects, textareas (exclude hidden/file inputs)
    const textual = Array.from(modal.querySelectorAll('input, select, textarea')).filter(i=> !(i.type==='radio' || i.type==='checkbox' || i.type==='file'));
    textual.forEach(i => {
      const raw = i.id || i.name || (i.previousElementSibling ? (i.previousElementSibling.textContent||'').trim() : null) || (i.closest('label') ? (i.closest('label').textContent||'').trim() : null) || null;
      const key = deriveKey(raw, i) || sanitizeKey(raw);
      if(!key) return;
      data[key] = (i.value || '').toString().trim();
    });

    // photo preview
    const photo_url = modal.querySelector('#photoPreview'); if(photo && photo.src) data.photo = photo.src;

    // tables
    const tables = Array.from(modal.querySelectorAll('table'));
    if(tables.length) data.tables = tables.map(t => collectTableRows(t));

    // Post-process known/ambiguous keys into canonical DB keys
    // Normalize accountStatus -> login with canonical values used elsewhere (CSV uses "Enable")
    (function normalizeAccountStatus(){
      // possible keys that may hold the account status
      const candidates = ['login','accountstatus','account_status','accountStatus'];
      let foundKey = null;
      for(const k of candidates){ if(Object.prototype.hasOwnProperty.call(data,k)){ foundKey = k; break; } }
      if(!foundKey) return;
      // If it's already the desired 'login' key, try to normalize its value casing
      const raw = data[foundKey];
      if(raw === undefined || raw === null) return;
      const s = (typeof raw === 'string') ? raw.trim().toLowerCase() : (raw ? 'enable' : 'disable');
      let out = null;
      if(['enable','enabled','true','ok','on','1'].indexOf(s) !== -1) out = 'Enable';
      else if(['disable','disabled','false','off','0'].indexOf(s) !== -1) out = 'Disable';
      else {
        // fallback: capitalize first char of original string
        const orig = String(raw || '').trim();
        out = orig ? (orig.charAt(0).toUpperCase() + orig.slice(1)) : orig;
      }
      // assign canonical key and remove the old key if different
      data.login = out;
      if(foundKey !== 'login') delete data[foundKey];
    })();

    return data;
  }

  window.fetchProfileData = fetchProfileData;
  window.logProfileData = function(){ const d = fetchProfileData(); console.log('Profile data:', d); return d; };

  // Populate medical therapy / counseling inputs from student object
  function populateMedicalTherapy(student){
    if(!student) return;
    const yesEl = document.getElementById('therapyYes');
    const noEl = document.getElementById('therapyNo');
    const detailsEl = document.getElementById('therapyDetailsInput');

    function normalizeToken(t){
      if(t === null || t === undefined) return '';
      t = String(t).trim();
      const lower = t.toLowerCase();
      // common affirmative tokens
      const yes = ['yes','y','true','1','received','received therapy','received_counseling','receivedcounseling'];
      const no = ['no','n','false','0','na','n/a','not applicable','none'];
      if(yes.indexOf(lower) !== -1) return 'yes';
      if(no.indexOf(lower) !== -1) return 'no';
      // handle tokens like 'very_close' etc. (not related but fallback)
      return t;
    }

    // Try multiple possible student keys where this info might be stored
    const candidateTokens = [
      student.therapy,
      student.therapy_received,
      student.therapyReceived,
      student.received_therapy,
      student.receivedTherapy,
      student.has_therapy,
      student.hasTherapy,
      student.medical_therapy,
      student.medicalTherapy,
      student.medical_therapy_flag
    ];
    const raw = candidateTokens.find(c => c !== undefined && c !== null && String(c).trim() !== '') || '';
    const norm = normalizeToken(raw);
    if(yesEl && noEl){
      if(norm === 'yes') { yesEl.checked = true; noEl.checked = false; }
      else if(norm === 'no') { noEl.checked = true; yesEl.checked = false; }
      else { yesEl.checked = false; noEl.checked = false; }
    }

    // Details: try typical fields from different DB schemas
    const detailCandidates = [
      student.therapy_details,
      student.therapyDetails,
      student.therapy_when,
      student.therapy_when_with,
      student.therapy_with,
      student.therapy_provider,
      student.therapy_note,
      student.therapyNotes,
      student.therapy_note,
      student.therapy_notes,
      student.medical_therapy_details,
      student.medicalTherapyDetails,
      student.medical_therapy_note
    ];
    const detail = detailCandidates.find(d => d !== undefined && d !== null && String(d).trim() !== '') || '';
    if(detailsEl){
      detailsEl.value = detail || '';
      // If no explicit detail, keep placeholder visible (readonly input)
    }
  }

  // Auto-run if a global student object is found (common names used in this project)
  (function autoRunPopulateTherapy(){
    const possibleGlobals = [window.student, window.currentStudent, window._selectedStudent, window._currentStudent, window._studentsCache && window._studentsCache[0]];
    const s = possibleGlobals.find(x => x && typeof x === 'object');
    if(s){
      // slight delay to allow DOM to be ready if this script runs early
      setTimeout(()=> populateMedicalTherapy(s), 80);
    }
    // Also expose globally so other mappers can call it
    window.populateMedicalTherapy = populateMedicalTherapy;
  })();
</script>
<script>
  // Populate work experience inputs from student object
  function populateWorkExperience(student){
    if(!student) return;
    const yesEl = document.getElementById('workExpYes');
    const noEl = document.getElementById('workExpNo');

    function isYes(val){
      if(val === true || val === 1) return true;
      const s = (val || '').toString().trim().toLowerCase();
      return s === '1' || s === 'true' || s === 'yes' || s === 'y' || s === 'have' || s === 'has' || s === 'received';
    }
    function isNo(val){
      if(val === false || val === 0) return true;
      const s = (val || '').toString().trim().toLowerCase();
      return s === '0' || s === 'false' || s === 'no' || s === 'n' || s === 'none' || s === 'na' || s === 'n/a' || s === 'not applicable';
    }

    const keys = ['has_work_exp','hasWorkExp','has_work_experience','work_experience','workExperience','work_exp','workExp','work_experience_flag','workExperience_flag','has_workexp'];
    for(const k of keys){
      if(Object.prototype.hasOwnProperty.call(student,k) && student[k] !== null && student[k] !== undefined){
        const v = student[k];
        if(isYes(v)){
          if(yesEl) yesEl.checked = true;
          if(noEl) noEl.checked = false;
        } else if(isNo(v)){
          if(noEl) noEl.checked = true;
          if(yesEl) yesEl.checked = false;
        } else {
          const s = (v||'').toString().trim();
          if(s){ if(yesEl) yesEl.checked = true; if(noEl) noEl.checked = false; }
        }
        break;
      }
    }
  }

  // Auto-run for work experience if a global student object exists
  (function autoRunPopulateWorkExp(){
    const s = window.student || window.currentStudent || window.profileStudent || window._selectedStudent || window._studentsCache && window._studentsCache[0];
    if(s) setTimeout(()=> populateWorkExperience(s), 60);
    window.populateWorkExperience = populateWorkExperience;
  })();
</script>
  <!-- END Inline profile panel -->
  </div> <!-- .app -->
    
<script>
// Populate colleges based on selected campus (Main Campus -> listing)
(function(){
  const campusCollegeMap = {
    "Main Campus": [
      "College of Education",
      "College of Business and Accountancy",
      "College of Arts and Sciences",
      "College of Engineering and Technology",
      "College of Computing, Multimedia Arts and Digital Innovation"
    ]
  };

  function populateCollegeSelectFor(selectId, campusVal){
    const sel = document.getElementById(selectId);
    if(!sel) return;
    // default option
    sel.innerHTML = '<option value="">All colleges</option>';
    // Only enable & populate college select when we have a mapping (currently Main Campus).
    // For any other campus (including the campuses in your screenshot), the college
    // control will be disabled so it cannot be clicked.
    if (campusVal && campusCollegeMap[campusVal]) {
      for (const col of campusCollegeMap[campusVal]) {
        const opt = document.createElement('option'); opt.value = col; opt.textContent = col; sel.appendChild(opt);
      }
      sel.disabled = false;
      sel.removeAttribute('aria-disabled');
    } else {
      // disable the control when a specific non-mapped campus is selected
      // If campusVal is empty (All campuses), keep it enabled but with only the default option.
      if (!campusVal) {
        sel.disabled = false;
        sel.removeAttribute('aria-disabled');
      } else {
        sel.disabled = true;
        sel.setAttribute('aria-disabled', 'true');
      }
      sel.value = '';
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    const campus = document.getElementById('filterCampus');
    const college = document.getElementById('filterCollege');
    const course = document.getElementById('filterCourse');
    if(!campus || !college) return;

    campus.addEventListener('change', function(){
      const v = (campus.value || '').trim();
      populateCollegeSelectFor('filterCollege', v);
      // reset course when campus changes
      if(course) { course.innerHTML = '<option value="">All courses</option>'; course.value = ''; }
      if(window.updateUserTablePagination) window.updateUserTablePagination(1);
    });

    // ensure college list reflects initial campus selection
    populateCollegeSelectFor('filterCollege', (campus.value || '').trim());

    // Populate course select with full course list (from attachment)
    function populateCourseSelect(selectId){
      const sel = document.getElementById(selectId);
      if(!sel) return;
      const courses = [
        "BMMA",
        "BS Biology",
        "BSA",
        "BSABE",
        "BSBA FM",
        "BSBA OM",
        "BSCE",
        "BSEE",
        "BSHM",
        "BSIT",
        "BSME",
        "BS Criminology",
        "BS Information Systems",
        "BSE",
        "BS in Accountancy",
        "BS in Tourism Management",
        "BS in Hotel and Restaurant Management",
        "BS in Computer Science",
        "BS in Civil Engineering",
        "BS in Mechanical Engineering",
        "BS in Electrical Engineering",
        "BS in Marine Engineering",
        "BS in Entrepreneurship",
        "Associate in Computer Technology",
        "Diploma in Office Management"
      ];
      // Clear and add default option first
      sel.innerHTML = '<option value="">All courses</option>';
      for(const c of courses){
        const o = document.createElement('option'); o.value = c; o.textContent = c; sel.appendChild(o);
      }
      // leave existing enabled/disabled state as-is
    }

    // initial populate
    populateCourseSelect('filterCourse');

    // repopulate courses when filters are cleared (keeps the list present)
    window.addEventListener('filtersCleared', function(){ populateCourseSelect('filterCourse'); });

    // when college changes, reset pagination so filtered view starts at page 1
    college.addEventListener('change', function(){ if(window.updateUserTablePagination) window.updateUserTablePagination(1); });
  });
})();
</script>
<script>
(function(){
  const tbody = document.getElementById('userTableBody');
  const info = document.getElementById('paginationInfo');
  const controls = document.getElementById('paginationControls');
  if(!tbody || !info || !controls) return;
  let pageSize = 10;
  let currentPage = 1;

  function getVisibleRows(){
    return Array.from(tbody.rows).filter(r => r.style.display !== 'none');
  }

  function renderControls(totalPages){
    controls.innerHTML = '';
    const prev = document.createElement('button'); prev.textContent = 'â€¹'; prev.disabled = currentPage === 1;
    prev.addEventListener('click', ()=> updatePagination(currentPage - 1));
    controls.appendChild(prev);

    const maxButtons = 5;
    let start = Math.max(1, currentPage - Math.floor(maxButtons/2));
    let end = Math.min(totalPages, start + maxButtons - 1);
    start = Math.max(1, end - maxButtons + 1);
    for(let p = start; p <= end; p++){
      const b = document.createElement('button'); b.textContent = p;
      if(p === currentPage) b.classList.add('active');
      b.addEventListener('click', ()=> updatePagination(p));
      controls.appendChild(b);
    }

    const next = document.createElement('button'); next.textContent = 'â€º'; next.disabled = currentPage === totalPages || totalPages === 0;
    next.addEventListener('click', ()=> updatePagination(currentPage + 1));
    controls.appendChild(next);
  }

  function updatePagination(page){
    const rows = getVisibleRows();
    const total = rows.length;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    if(page < 1) page = 1;
    if(page > totalPages) page = totalPages;
    currentPage = page;
    const startIdx = (page - 1) * pageSize;
    const endIdx = Math.min(total, startIdx + pageSize);
    rows.forEach((r, i) => { r.style.display = (i >= startIdx && i < endIdx) ? '' : 'none'; });
    info.textContent = total === 0 ? 'Showing 0 to 0 of 0 entries' : `Showing ${startIdx+1} to ${endIdx} of ${total} entries`;
    renderControls(totalPages);
  }

  // Observe changes to the tbody so pagination updates when rows are added/removed or filtered
  let debounceTimer = null;
  const mo = new MutationObserver(()=>{
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(()=> updatePagination(1), 120);
  });
  mo.observe(tbody, { childList: true, subtree: true, attributes: true, attributeFilter: ['style'] });

  // Hook search input to reset pagination (debounced)
  const search = document.getElementById('searchInput');
  if(search){
    let sTimer = null;
    search.addEventListener('input', ()=>{
      clearTimeout(sTimer);
      sTimer = setTimeout(()=> updatePagination(1), 150);
    });
  }

  window.addEventListener('filtersCleared', ()=> updatePagination(1));

  // initial call after rows populate
  setTimeout(()=> updatePagination(1), 500);
  window.updateUserTablePagination = updatePagination;
})();
</script>

</body>
</html>