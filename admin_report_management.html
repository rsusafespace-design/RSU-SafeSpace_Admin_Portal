<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports Management - Admin Portal</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* BASE STYLES */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f8fafc;
            color: #333;
            line-height: 1.5;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* HEADER & TOP BAR STYLES */
        .header-and-sidebar-top {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1400;
            display: flex;
            background: linear-gradient(135deg, #1e8e3e 0%, #0f7a34 100%);
            color: white;
            height: 60px;
            transition: left 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .sidebar-top {
            width: 250px;
            display: flex;
            align-items: center;
            padding: 10px 20px;
            box-sizing: border-box;
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            height: 60px;
            transition: width 0.3s ease;
        }
        
        .sidebar-top.collapsed {
            width: 80px;
            justify-content: center;
        }
        
        .sidebar-top.collapsed .sidebar-logo {
            opacity: 0;
            pointer-events: none;
            width: 0;
        }
        
        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            transition: opacity 0.3s ease, width 0.3s ease;
        }

        .sidebar-logo img {
            height: 40px;
        }
        
        .sidebar-logo span {
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
            white-space: nowrap;
        }
        
        .menu-icon {
            cursor: pointer;
            font-size: 24px;
            margin-left: auto;
            transition: all 0.3s ease;
            padding: 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            min-height: 40px;
        }
        
        .menu-icon:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .menu-icon:active {
            transform: scale(0.95);
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .main-top-bar {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 30px; 
        }

        .main-top-bar .portal-title {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }

        .main-top-bar .user-info {
            display: flex;
            align-items: center;
            color: white;
        }

        .main-top-bar .user-info .material-icons {
            margin-right: 10px;
            font-size: 24px;
        }

        .main-top-bar .user-avatar {
            width: 40px;
            height: 40px;
            background-color: white;
            color: #1e8e3e; 
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-left: 10px;
            font-size: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .main-top-bar .user-avatar:hover {
            transform: scale(1.05);
        }

        /* SIDEBAR STYLES */
        .sidebar {
            width: 250px;
            background: #f0f3f6;
            border-right: 1px solid rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 60px;
            left: 0;
            height: calc(100vh - 60px);
            z-index: 999;
            overflow: auto;
            transition: width 0.3s ease, transform 0.3s ease;
        }
        
        .nav-menu ul {
            list-style: none;
            padding: 12px;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .nav-item {
            color: #1f2937;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 10px;
            border-radius: 8px;
            border: 0;
            background: transparent;
            cursor: pointer;
            font-weight: 400;
            font-size: 15px;
            transition: all 0.2s ease;
            text-align: left;
            width: 100%;
        }
    
        .nav-item:hover {
            background: rgba(15,122,52,0.08) !important;
            color: #0f7a34 !important;
            font-weight: 400 !important;
            border-radius: 8px !important;
            transform: translateX(2px);
        }
        
        .nav-item.active {
            background: rgba(15,122,52,0.12) !important;
            color: #0f7a34 !important;
            font-weight: 600 !important;
            box-shadow: 0 2px 5px rgba(15,122,52,0.1);
        }
        
        .nav-item:hover .icon,
        .nav-item.active .icon {
            color: #1f2937 !important;
        }

        .nav-item .icon {
            width: 28px;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            line-height: 1;
            color: #1f2937;
            transition: color 0.2s;
        }
        
        .nav-item .label {
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            opacity: 1;
            transition: opacity 0.2s, transform 0.2s;
        }

        .sidebar.collapsed {
            width: 80px;
        }
        
        .sidebar.collapsed .nav-item .label {
            display: none;
        }
        
        .sidebar.collapsed .nav-item .icon {
            width: 56px;
            font-size: 26px;
            justify-content: center;
        }
        
        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 12px 6px;
            gap: 0;
        }
        
        .sidebar-footer {
            margin-top: auto;
            padding: 12px;
        }
        
        .sidebar-footer .nav-item { 
            display:flex; 
            align-items:center; 
            gap:12px; 
            padding:10px; 
            border-radius:8px; 
        }
        
        .sidebar-footer .nav-item .label { 
            transition: opacity 0.15s ease; 
        }
        
        .sidebar.collapsed .sidebar-footer .nav-item .label { 
            display:none; 
        }

        .menu-icon { 
            z-index: 1500; 
            position: relative; 
            pointer-events: auto; 
        }
        
        /* Mobile sidebar overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 998;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
                box-shadow: 4px 0 15px rgba(0, 0, 0, 0.2);
                transition: transform 0.3s ease;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .sidebar.collapsed {
                width: 280px;
                transform: translateX(-100%);
            }
            
            .main-content {
                left: 0 !important;
                padding: 20px 15px;
            }
        }
        
        /* MAIN CONTENT STYLES */
        .main-content {
            position: fixed;
            top: 60px;
            left: 250px;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            overflow: auto;
            padding: 30px;
            transition: left 0.3s ease;
            min-height: auto;
            background: transparent;
        }

        .main-content.shifted {
            left: 80px;
        }
        
        .dashboard-content-wrapper {
            padding: 0;
            flex-grow: 1;
        }

        /* Reports Management Styles */
        .reports-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .reports-header h1 {
            color: #1f2937;
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .reports-actions {
            display: flex;
            gap: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
        }

        .filters-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
        }

        .filter-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-item label {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .filter-item select, .filter-item input {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            min-width: 150px;
            transition: all 0.2s;
            font-size: 14px;
        }

        .filter-item select:focus, .filter-item input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .reports-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .reports-table {
            width: 100%;
            border-collapse: collapse;
        }

        .reports-table th {
            background: #f9fafb;
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .reports-table td {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .reports-table tr:hover {
            background: #f9fafb;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-pending { background: #fef2f2; color: #dc2626; }
        .status-in-progress { background: #ecfdf5; color: #059669; }
        .status-resolved { background: #f0fdf4; color: #16a34a; }
        .status-new { background: #fffbeb; color: #d97706; }

        .type-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .type-bullying { background: #fef2f2; color: #dc2626; }
        .type-harassment { background: #f3e8ff; color: #9333ea; }
        .type-discrimination { background: #ecfdf5; color: #059669; }
        .type-other { background: #f0fdf4; color: #16a34a; }

        .anonymous-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            background: #6b7280;
            color: white;
            display: inline-block;
            margin-left: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .btn-view { background: #10b981; color: white; }
        .btn-view:hover { background: #059669; transform: scale(1.05); }

        .btn-edit { background: #059669; color: white; }
        .btn-edit:hover { background: #047857; transform: scale(1.05); }

        .btn-delete { background: #dc2626; color: white; }
        .btn-delete:hover { background: #b91c1c; transform: scale(1.05); }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }

        .pagination-info {
            color: #6b7280;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .pagination-btn:hover {
            background: #f3f4f6;
        }

        .pagination-btn.active {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9fafb;
            border-radius: 12px 12px 0 0;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-sizing: border-box;
            transition: all 0.2s;
            font-size: 14px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .reporter-info {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #10b981;
        }

        .attachment-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            margin-bottom: 10px;
            transition: background 0.2s;
        }

        .attachment-item:hover {
            background: #f1f5f9;
        }

        .attachment-icon {
            color: #6b7280;
        }

        /* Profile dropdown styles */
        .profile-dropdown .profile-card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 12px 34px rgba(2,6,23,0.12), 0 4px 10px rgba(2,6,23,0.06);
            overflow: hidden;
            animation: fadeIn .12s ease;
            transition: transform .14s ease, box-shadow .14s ease, opacity .12s ease;
            transform-origin: top right;
        }
        
        .profile-card-top { 
            display:flex; 
            justify-content:center; 
            padding:14px 12px 6px; 
        }
        
        .avatar-large {
            width:120px; 
            height:120px; 
            border-radius:500%; 
            background:#f3faf5; 
            display:flex; 
            align-items:left; 
            justify-content:left; 
            font-weight:7000; 
            font-size:32px; 
            position:relative; 
            overflow:hidden; 
            border:4px solid rgba(16,185,129,0.06);
        }
        
        .avatar-large img { 
            width:100%; 
            height:100%; 
            object-fit:cover; 
            display:block; 
            transition: transform .18s ease; 
            box-shadow: 0 6px 18px rgba(2,6,23,0.08); 
        }
        
        .avatar-large:hover img { 
            transform: scale(1.02); 
        }
        
        .avatar-camera { 
            position:absolute; 
            right:6px; 
            bottom:6px; 
            border-radius:50%; 
            background:#fff; 
            border:0; 
            width:30px; 
            height:30px; 
            display:flex; 
            align-items:center; 
            justify-content:center; 
            box-shadow:0 6px 12px rgba(2,6,23,0.06); 
            cursor:pointer; 
            font-size:13px; 
        }
        
        .profile-card-body { 
            padding: 10px 18px 16px; 
            text-align:center; 
            display:flex; 
            flex-direction:column; 
            gap:8px; 
        }
        
        .profile-email { 
            font-size:13px; 
            color:#6b7280; 
            margin-top:2px; 
            white-space:nowrap; 
            overflow:hidden; 
            text-overflow:ellipsis; 
        }
        
        .profile-greeting { 
            font-weight:700; 
            font-size:18px; 
            margin-top:4px; 
            color:#111827; 
        }
        
        .manage-btn { 
            display:inline-block; 
            width:100%; 
            padding:10px 12px; 
            border-radius:999px; 
            border:1px solid rgba(16,185,129,0.12); 
            background:#10b981; 
            color:#fff; 
            font-weight:700; 
            box-shadow:none; 
            cursor:pointer; 
        }
        
        .manage-btn:hover { 
            transform:none; 
            filter:brightness(.98); 
        }
        
        .profile-divider { 
            height:1px; 
            background:#f1f5f9; 
            margin:8px 0; 
        }
        
        .profile-actions { 
            display:flex; 
            justify-content:space-between; 
            gap:12px; 
            align-items:center; 
        }
        
        .profile-link { 
            flex:1; 
            text-align:left; 
            border:0; 
            background:transparent; 
            padding:8px; 
            color:#374151; 
            font-weight:600; 
            cursor:pointer; 
        }
        
        .signout-link { 
            flex:1; 
            text-align:right; 
            border:0; 
            background:transparent; 
            padding:8px; 
            color:#ef4444; 
            font-weight:700; 
            cursor:pointer; 
        }
        
        .icon-btn { 
            background: transparent !important; 
            border: 0 !important; 
            outline: none !important; 
            box-shadow: none !important; 
            padding: 6px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            cursor: pointer; 
            transition: all 0.2s;
        }
        
        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.1) !important;
            border-radius: 6px;
        }
        
        .icon-btn:focus { 
            outline: 2px solid rgba(255,255,255,0.18); 
        }

        /* popover / dropdown visibility */
        .popover { 
            display: none; 
        }
        
        .popover[data-open="true"] { 
            display: block; 
        }
        
        .dropdown { 
            display: none; 
        }
        
        .dropdown[aria-hidden="false"] { 
            display: block; 
        }

        @keyframes fadeIn { 
            from { 
                opacity: 0; 
                transform: translateY(-10px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }
        
        /* Logout button styling */
        #sidebarLogoutBtn { 
            cursor: pointer; 
        }
        
        #sidebarLogoutBtn .label, 
        #sidebarLogoutBtn .icon {
            color: inherit;
            transition: color 160ms ease-in-out, transform 120ms ease;
        }
        
        #sidebarLogoutBtn:hover .label,
        #sidebarLogoutBtn:hover .icon {
            color: #ef4444 !important;
        }
        
        #sidebarLogoutBtn:focus-visible .label,
        #sidebarLogoutBtn:focus-visible .icon {
            color: #ef4444 !important;
        }
        
        #profileDropdown { 
            display: none; 
        }
        
        #profileDropdown[aria-hidden="false"] { 
            display: block; 
        }

        /* Confirm Modal */
        #confirmModalLogout {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(2,6,23,0.45);
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }
        
        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
            transition: transform 0.3s ease;
            position: relative;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card.new { border-left: 4px solid #d97706; }
        .stat-card.pending { border-left: 4px solid #dc2626; }
        .stat-card.in-progress { border-left: 4px solid #059669; }
        .stat-card.resolved { border-left: 4px solid #16a34a; }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }
        
        .stat-icon {
            float: right;
            font-size: 24px;
            opacity: 0.7;
        }
        
        .stat-card.new .stat-icon { color: #d97706; }
        .stat-card.pending .stat-icon { color: #dc2626; }
        .stat-card.in-progress .stat-icon { color: #059669; }
        .stat-card.resolved .stat-icon { color: #16a34a; }

        /* Skeleton loading styles for summary cards */
        .stat-card { overflow: hidden; }
        .stat-content { display: block; }
        .skeleton-box { display: none; position: absolute; inset: 0; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; justify-content: center; gap: 10px; background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.4)); }
        .skeleton-line { height: 18px; border-radius: 8px; background: linear-gradient(90deg, #ececec 25%, #f5f5f5 50%, #ececec 75%); background-size: 200% 100%; animation: shimmer 1.2s linear infinite; }
        .skeleton-line.skeleton-value { height: 28px; width: 60%; }
        .skeleton-line.skeleton-label { height: 14px; width: 40%; }

        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* When container has loading state show skeleton and hide real content */
        .stats-container.loading .stat-content { visibility: hidden; }
        .stats-container.loading .skeleton-box { display: flex; }

        /* Table row skeletons */
        .table-skeleton-row td { padding: 16px; vertical-align: middle; }
        .table-skeleton-row .skeleton-line { height: 14px; border-radius: 8px; background: linear-gradient(90deg, #ececec 25%, #f5f5f5 50%, #ececec 75%); background-size: 200% 100%; animation: shimmer 1.2s linear infinite; }
        .table-skeleton-row .skeleton-id { width: 70px; height: 16px; }
        .table-skeleton-row .skeleton-type { width: 90px; height: 16px; }
        .table-skeleton-row .skeleton-desc { width: 40%; height: 14px; }
        .table-skeleton-row .skeleton-reporter { width: 140px; }
        .table-skeleton-row .skeleton-date { width: 90px; }
        .table-skeleton-row .skeleton-status { width: 80px; }
        .table-skeleton-row .skeleton-actions { width: 100px; }
    </style>
</head>
<body>
    <div class="header-and-sidebar-top">
        <aside class="sidebar-top" id="sidebarTop">
            <div class="sidebar-logo">
                <img src="safespace.png" alt="SafeSpace Logo">
                <span>SafeSpace</span>
            </div>
            <i class="material-icons menu-icon" id="menuIcon">menu</i>
        </aside>
        <header class="main-top-bar">
            <h1 class="portal-title">Admin Portal</h1>
            <div class="user-info">
                <div class="top-greeting" aria-live="polite" style="margin-right:12px; text-align:right; color:#fff; margin-left:8px;">
                    <div id="topGreetingName" style="font-weight:700; font-size:14px;">Good Morning, Admin</div>
                    <div id="topGreetingTime" style="font-size:12px; opacity:0.95; margin-top:2px;">Tuesday, Oct 14, 2025 â€” 02:51 AM</div>
                </div>
                <div style="position:relative;display:inline-block;">
                    <button id="notifBtn" class="icon-btn" aria-expanded="false" title="Notifications" style="color:white;padding:8px;border:none;border:0;display:inline-flex;align-items:center;justify-content:center;box-shadow:none;">
                        <i class="material-icons" style="color:white;font-size:20px;border:none;outline:none;background:transparent;">notifications</i>
                    </button>
                    <div id="notifPanel" class="popover" data-open="false" style="position:fixed;right:20px;top:62px;min-width:280px;z-index:4500;display:none;">
                        <div class="notif-card" role="dialog" aria-label="Notifications" aria-hidden="true" style="border-radius:10px;overflow:hidden;box-shadow:0 12px 30px rgba(2,6,23,0.08);background:#fff;font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-width:280px;">
                            <div class="notif-header popover-header" style="background:#10b981;color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;">
                                <div class="notif-title" style="font-weight:700;font-size:15px;">Notifications</div>
                                <div id="notifTimestamp" class="notif-timestamp" style="font-size:12px;opacity:0.95;">--</div>
                            </div>
                            <div id="notifList" class="popover-body" style="color:#111827;padding:8px 12px;">
                                <div class="popover-empty">No new notifications.</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="position:relative;display:inline-block;margin-left:-8px;">
                    <button id="profileBtn" class="user-avatar" aria-haspopup="true" aria-expanded="false" title="Profile" style="border:0;cursor:pointer;padding:0;position:relative;overflow:hidden;">
                        <div id="profileBtnSpinner" style="position:absolute;inset:0;display:none;align-items:center;justify-content:center;pointer-events:none">
                            <svg width="28" height="28" viewBox="0 0 50 50" aria-hidden="true">
                                <circle cx="25" cy="25" r="18" fill="#ffffff" opacity="0.2"></circle>
                                <path fill="#10B981" d="M25 5a20 20 0 0 1 0 6a14 14 0 1 0 0 28 14 14 0 0 1 0-34">
                                    <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite" />
                                </path>
                            </svg>
                        </div>
                        <div id="profileBtnDefaultIcon" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none">
                            <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5z" fill="#9CA3AF"></path>
                                <path d="M3 20c0-2.761 4.477-5 9-5s9 2.239 9 5v1H3v-1z" fill="#9CA3AF"></path>
                            </svg>
                        </div>
                    </button>
                    <div id="profileDropdown" class="dropdown profile-dropdown" aria-hidden="true" style="position:fixed;right:20px;top:62px;min-width:320px;z-index:3000;">
                        <div style="background:#fff;border-radius:12px;padding:10px;min-width:320px;box-shadow:0 12px 30px rgba(2,6,23,0.12);font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111;">
                            <div style="display:flex;gap:12px;align-items:center;padding:10px;border-bottom:1px solid rgba(0,0,0,0.06)">
                                <div class="avatar-large" id="profileAvatar" style="width:80px;height:80px;border-radius:60px;overflow:hidden;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-weight:700;color:#111;font-size:18px">
                                    <!-- profile image or initial inserted by script -->
                                </div>
                                <div style="flex:1;min-width:0">
                                    <div id="profileGreeting" style="font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Hi, Admin</div>
                                    <div id="profileEmail" style="font-size:13px;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">you@example.com</div>
                                </div>
                            </div>
                            <div style="padding:8px 6px;display:flex;flex-direction:column;gap:6px">
                                <button id="accountEdit" class="profile-item" style="text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;cursor:pointer;display:flex;align-items:center;gap:10px">
                                    <i class="material-icons icon" style="font-size:18px;line-height:1;">person</i>
                                    <span style="flex:1;text-align:left">Manage your profile</span>
                                </button>
                                <button id="accountSettings" class="profile-item" style="text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;cursor:pointer;display:flex;align-items:center;gap:10px">
                                    <i class="material-icons icon" style="font-size:18px;line-height:1;">settings</i>
                                    <span style="flex:1;text-align:left">Settings & privacy</span>
                                    <i class="material-icons icon" style="font-size:16px;opacity:0.7;">chevron_right</i>
                                </button>
                                <button id="accountLogout" class="profile-item" style="text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;cursor:pointer;display:flex;align-items:center;gap:10px;color:#111;font-weight:600">
                                    <i class="material-icons icon" style="font-size:18px;line-height:1;color:#ef4444">logout</i>
                                    <span style="flex:1;text-align:left">Log Out</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </div>

    <div class="container">
        <aside class="sidebar" id="sidebar">
            <nav class="nav-menu">
                <nav class="nav" id="nav" style="display:flex;flex-direction:column;gap:8px;padding:12px;">
                    <button class="nav-item" onclick="location.href='admin_dashboard.html'" data-name="Dashboard">
                        <span class="material-icons icon" style="font-size:26px;">dashboard</span>
                        <span class="label" style="font-size:15px;">Home</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_user_management.html'" data-name="User Management">
                        <span class="material-icons icon" style="font-size:26px;">groups</span>
                        <span class="label" style="font-size:15px;">Student Management</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_counselor_management.html'" data-name="Counselor Management">
                        <span class="material-icons icon" style="font-size:26px;">psychology</span>
                        <span class="label" style="font-size:15px;">Counselor Management</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_content_management.html'" data-name="Content Management">
                        <span class="material-icons icon" style="font-size:26px;">description</span>
                        <span class="label" style="font-size:15px;">Content Management</span>
                    </button>
                    <button class="nav-item active" onclick="location.href='admin_report_management.html'" data-name="Reports Management">
                        <span class="material-icons icon" style="font-size:26px;">warning</span>
                        <span class="label">Reports Management</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_session_report.html'" data-name="Session Reports">
                        <span class="material-icons icon" style="font-size:26px;">fact_check</span>
                        <span class="label">Session Reports</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_psych_test.html'" data-name="Session Reports">
                        <span class="material-icons icon" style="font-size:26px;">assessment</span>
                        <span class="label">Psychological Test</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_settings.html'" data-name="System Settings">
                        <span class="material-icons icon" style="font-size:26px;">settings</span>
                        <span class="label" style="font-size:15px;">System Settings</span>
                    </button>
                </nav>
            </nav>
            <div class="sidebar-footer">
                <button class="nav-item" id="sidebarLogoutBtn" type="button" title="Sign out">
                    <i class="material-icons icon" style="font-size:26px;">logout</i>
                    <span class="label" style="font-size:15px;">Logout</span>
                </button>
            </div>
        </aside>
        
        <main class="main-content" id="mainContent">
            <div class="dashboard-content-wrapper">
                <div class="reports-header">
                    <h1><span class="material-icons" style="vertical-align: middle; margin-right: 10px; color: #ef4444;">warning</span>Reports Management</h1>
                    <div class="reports-actions">
                        <button class="btn-secondary" onclick="exportReports()">
                            <span class="material-icons" style="font-size: 18px; vertical-align: middle;">download</span>
                            Export
                        </button>
                        <button class="btn-primary" onclick="refreshReports()">
                            <span class="material-icons" style="font-size: 18px; vertical-align: middle;">refresh</span>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-container">
                        <div class="stat-card new">
                            <div class="stat-content">
                                <div class="stat-value" id="newCount">0</div>
                                <div class="stat-label">New Reports</div>
                                <span class="material-icons stat-icon">new_releases</span>
                            </div>
                            <div class="skeleton-box" aria-hidden="true">
                                <div class="skeleton-line skeleton-value"></div>
                                <div class="skeleton-line skeleton-label"></div>
                            </div>
                        </div>
                        <div class="stat-card pending">
                            <div class="stat-content">
                                <div class="stat-value" id="pendingCount">0</div>
                                <div class="stat-label">Pending</div>
                                <span class="material-icons stat-icon">pending_actions</span>
                            </div>
                            <div class="skeleton-box" aria-hidden="true">
                                <div class="skeleton-line skeleton-value"></div>
                                <div class="skeleton-line skeleton-label"></div>
                            </div>
                        </div>
                        <div class="stat-card in-progress">
                            <div class="stat-content">
                                <div class="stat-value" id="inProgressCount">0</div>
                                <div class="stat-label">In Progress</div>
                                <span class="material-icons stat-icon">update</span>
                            </div>
                            <div class="skeleton-box" aria-hidden="true">
                                <div class="skeleton-line skeleton-value"></div>
                                <div class="skeleton-line skeleton-label"></div>
                            </div>
                        </div>
                        <div class="stat-card resolved">
                            <div class="stat-content">
                                <div class="stat-value" id="resolvedCount">0</div>
                                <div class="stat-label">Resolved</div>
                                <span class="material-icons stat-icon">check_circle</span>
                            </div>
                            <div class="skeleton-box" aria-hidden="true">
                                <div class="skeleton-line skeleton-value"></div>
                                <div class="skeleton-line skeleton-label"></div>
                            </div>
                        </div>
                </div>

                <!-- Filters Section -->
                <div class="filters-section">
                    <div class="filter-group">
                        <div class="filter-item">
                            <label>Report Type</label>
                            <select id="typeFilter" onchange="filterReports()">
                                <option value="">All Types</option>
                                <option value="bullying">Bullying</option>
                                <option value="harassment">Harassment</option>
                                <option value="discrimination">Discrimination</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>Anonymous</label>
                            <select id="anonymousFilter" onchange="filterReports()">
                                <option value="">All</option>
                                <option value="true">Anonymous</option>
                                <option value="false">With Reporter Info</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>Status</label>
                            <select id="statusFilter" onchange="filterReports()">
                                <option value="">All Status</option>
                                <option value="new">New</option>
                                <option value="pending">Pending</option>
                                <option value="in-progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                            </select>
                        </div>
                        <div class="filter-item">
                            <label>Date From</label>
                            <input type="date" id="dateFromFilter" onchange="filterReports()">
                        </div>
                        <div class="filter-item">
                            <label>Date To</label>
                            <input type="date" id="dateToFilter" onchange="filterReports()">
                        </div>
                    </div>
                </div>

                <!-- Reports Table -->
                <div class="reports-table-container">
                    <table class="reports-table">
                        <thead>
                            <tr>
                                <th>Report ID</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Reporter</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                            <!-- Reports will be populated by JavaScript -->
                        </tbody>
                    </table>

                    <!-- Pagination -->
                    <div class="pagination">
                        <div class="pagination-info" id="paginationInfo">
                            Loading reports...
                        </div>
                        <div class="pagination-controls">
                            <button class="pagination-btn" onclick="changePage(-1)">Previous</button>
                            <button class="pagination-btn active">1</button>
                            <button class="pagination-btn" onclick="changePage(1)">Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Report Detail Modal -->
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Report Details</h2>
                <span class="material-icons" style="cursor: pointer;" onclick="closeModal()">close</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Modal content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn-primary" onclick="updateReportStatus()" id="updateStatusBtn">Update Status</button>
            </div>
        </div>
    </div>

    <!-- Confirm modal for logout -->
    <div id="confirmModalLogout" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;z-index:3000">
        <div style="background:#fff;border-radius:12px;padding:18px;max-width:420px;width:92%;box-shadow:0 12px 40px rgba(2,6,23,0.2)">
            <h3 id="confirmModalLogoutTitle" style="margin:0 0 8px 0;font-size:16px;font-weight:700">Confirm</h3>
            <div id="confirmModalLogoutMessage" style="font-size:15px;margin-bottom:12px;color:#111">Are you sure you want to sign out?</div>
            <div style="display:flex;gap:8px;justify-content:flex-end">
                <button id="confirmModalLogoutCancel" style="background:#6c757d;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer">Cancel</button>
                <button id="confirmModalLogoutOk" style="background:#00723f;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Generic confirm modal (used for deletions and other confirmations) -->
    <div id="confirmModal" class="modal" aria-hidden="true" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;z-index:3000">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="confirmModalLabel" style="max-width:480px;padding:18px;">
            <div class="modal-header" id="confirmModalLabel" style="font-weight:700;font-size:16px;margin-bottom:8px;">Confirm</div>
            <div id="confirmModalBody" style="min-height:20px;margin-bottom:12px;color:#111">Are you sure?</div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
                <button id="confirmModalNo" class="btn-secondary" style="background:#6c757d;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer">No</button>
                <button id="confirmModalYes" class="btn-primary" style="background:#00723f;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer">Yes</button>
            </div>
        </div>
    </div>

    <!-- Info modal for simple messages (replaces alert()) -->
    <div id="infoModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;z-index:3000">
        <div class="modal-content" style="max-width:420px;padding:18px;">
            <div class="modal-header" style="font-weight:700;font-size:16px;margin-bottom:8px;">Message</div>
            <div id="infoModalBody" style="min-height:20px;margin-bottom:12px;color:#111">Message text</div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
                <button id="infoModalOk" class="btn-primary" style="background:#00723f;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, ref, get, update, remove, onValue, createNotification, broadcastNotification } from './admin_main.js';
        import { loadAdminProfileInto, startGreetingClock } from './admin_profile_loader.js';

        // Local activity logger (writes to shared key used by admin dashboard)
        (function registerLocalActivityHelper(){
            const KEY = 'admin_recent_activity';
            const MAX = 20;
            function pushLocalActivity(text, icon) {
                try {
                    const entry = { text: String(text || ''), ts: (new Date()).toISOString(), icon: icon || '' };
                    const raw = localStorage.getItem(KEY);
                    let arr = [];
                    try { arr = raw ? JSON.parse(raw) : []; } catch(e){ arr = []; }
                    arr.unshift(entry);
                    if (arr.length > MAX) arr = arr.slice(0, MAX);
                    localStorage.setItem(KEY, JSON.stringify(arr));
                } catch (e) { console.warn('pushLocalActivity failed', e); }
            }
            try { window.pushLocalActivity = pushLocalActivity; } catch(e){}
        })();

        // Load admin profile
        loadAdminProfileInto({ 
            greetingSelector: '#topGreetingName', 
            avatarSelector: '#profileBtn', 
            timeSelector: '#topGreetingTime' 
        });
        startGreetingClock('#topGreetingName', '#topGreetingTime');

        let allReports = [];
        let currentPage = 1;
        const reportsPerPage = 10;
        let filteredReports = [];
        let currentReportId = null;
        let knownReportIds = new Set();

        // Toggle loading skeleton for stats cards (with ARIA and explicit sync)
        function setStatsLoading(isLoading) {
            const sc = document.querySelector('.stats-container');
            if (!sc) return;
            const loading = !!isLoading;
            sc.classList.toggle('loading', loading);
            sc.setAttribute('aria-busy', loading ? 'true' : 'false');

            // Sync aria-hidden and visibility for each card's skeleton and content
            const skeletons = sc.querySelectorAll('.skeleton-box');
            const contents = sc.querySelectorAll('.stat-content');
            skeletons.forEach(s => {
                s.setAttribute('aria-hidden', !loading);
                // also ensure correct display in case CSS was modified
                s.style.display = loading ? 'flex' : 'none';
            });
            contents.forEach(c => {
                c.setAttribute('aria-hidden', loading);
                c.style.visibility = loading ? 'hidden' : 'visible';
            });
        }

        // Inject/remove skeleton rows inside the reports table body
        function setTableLoading(isLoading, rows = 4) {
            const tbody = document.getElementById('reportsTableBody');
            if (!tbody) return;
            const loading = !!isLoading;
            if (loading) {
                const skeletonRows = Array.from({ length: rows }).map(() => `
                    <tr class="table-skeleton-row">
                        <td><div class="skeleton-line skeleton-id"></div></td>
                        <td><div class="skeleton-line skeleton-type"></div></td>
                        <td><div class="skeleton-line skeleton-desc"></div></td>
                        <td><div class="skeleton-line skeleton-reporter"></div></td>
                        <td><div class="skeleton-line skeleton-date"></div></td>
                        <td><div class="skeleton-line skeleton-status"></div></td>
                        <td><div class="skeleton-line skeleton-actions"></div></td>
                    </tr>
                `).join('');
                tbody.innerHTML = skeletonRows;
                tbody.setAttribute('aria-busy', 'true');
            } else {
                // remove busy state - real content will be rendered by displayReports()
                tbody.removeAttribute('aria-busy');
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', async function() {
            await loadReportsFromFirebase();
            setupSidebar();

            // Track currently-known reports to detect newly added reports in realtime
            try { knownReportIds = new Set(allReports.map(r => r.id)); } catch (e) { knownReportIds = new Set(); }

            // Apply URL-driven filter or open actions (e.g. ?filter=new or ?report=<id>)
            try {
                const params = new URLSearchParams(window.location.search || '');
                const filterParam = params.get('filter');
                const reportParam = params.get('report');
                if (filterParam && filterParam.toLowerCase() === 'new') {
                    try { const sf = document.getElementById('statusFilter'); if (sf) sf.value = 'new'; } catch(e){}
                    try { if (typeof filterReports === 'function') filterReports(); } catch(e){}
                }
                if (reportParam) {
                    // Open specific report after a short delay so the table/modal is ready
                    setTimeout(()=>{ try{ if (typeof viewReport === 'function') viewReport(reportParam); } catch(e){} }, 250);
                }
            } catch (e) { console.debug && console.debug('apply URL filters failed', e); }

            // Realtime listener: notify admins when a new report is submitted
            try {
                const reportsRefRealtime = ref(db, 'reports');
                onValue(reportsRefRealtime, (snap) => {
                    try {
                        if (!snap.exists()) return;
                        const data = snap.val() || {};
                        const ids = Object.keys(data);
                        ids.forEach(id => {
                            if (!knownReportIds.has(id)) {
                                knownReportIds.add(id);
                                const reportData = data[id] || {};
                                const reportObj = {
                                    id,
                                    ...reportData,
                                    status: reportData.status || 'new',
                                    created_at: reportData.created_at ? new Date(reportData.created_at).toLocaleDateString() : 'Unknown date',
                                    date: reportData.date || 'Unknown date'
                                };

                                // Add to local state and refresh UI
                                allReports.unshift(reportObj);
                                filteredReports.unshift(reportObj);
                                displayReports();
                                updatePaginationInfo();
                                updateStats();

                                // Notify (DB + broadcast) admins about new report
                                try { if (typeof createNotification === 'function') createNotification({ title: 'New Reports Submitted', body: `Report ${id} submitted`, ts: Date.now(), path: 'admin_report_management.html', reportId: id }); } catch (e) { console.debug('create new report notif failed', e); }
                                try { if (typeof broadcastNotification === 'function') broadcastNotification({ title: 'New Reports Submitted', body: `Report ${id} submitted`, ts: Date.now(), path: 'admin_report_management.html', reportId: id }); } catch (e) { console.debug('broadcast new report failed', e); }
                            }
                        });
                    } catch (err) { console.debug && console.debug('onValue reports handler error', err); }
                });
            } catch (e) { console.debug && console.debug('realtime reports listener failed', e); }
        });

        // Setup sidebar functionality
        function setupSidebar() {
            const menuIcon = document.getElementById('menuIcon');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const sidebarTop = document.getElementById('sidebarTop');
            
            // Create overlay for mobile
            const overlay = document.createElement('div');
            overlay.className = 'sidebar-overlay';
            document.body.appendChild(overlay);
            
            // Mobile detection
            function isMobile() {
                return window.innerWidth <= 768;
            }
            
            // Toggle sidebar with mobile responsiveness
            menuIcon.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                if (isMobile()) {
                    // Mobile behavior - overlay sidebar
                    const isOpen = sidebar.classList.toggle('mobile-open');
                    overlay.classList.toggle('active', isOpen);
                    document.body.style.overflow = isOpen ? 'hidden' : '';
                } else {
                    // Desktop behavior - collapse sidebar
                    const isCollapsed = sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('shifted', isCollapsed);
                    sidebarTop.classList.toggle('collapsed', isCollapsed);
                }
            });
            
            // Close mobile sidebar when clicking overlay
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (!isMobile()) {
                    // Reset mobile states when switching to desktop
                    sidebar.classList.remove('mobile-open');
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                    // Ensure desktop state is consistent
                    const isCollapsed = sidebar.classList.contains('collapsed');
                    mainContent.classList.toggle('shifted', isCollapsed);
                    sidebarTop.classList.toggle('collapsed', isCollapsed);
                } else {
                    // Reset desktop states when switching to mobile
                    sidebar.classList.remove('collapsed');
                    mainContent.classList.remove('shifted');
                    sidebarTop.classList.remove('collapsed');
                }
            });
        }

        // Load reports from Firebase
        async function loadReportsFromFirebase() {
            try {
                setStatsLoading(true);
                setTableLoading(true);
                console.log('Loading reports from Firebase...');
                const reportsRef = ref(db, 'reports');
                const snapshot = await get(reportsRef);
                
                if (snapshot.exists()) {
                    const reportsData = snapshot.val();
                    allReports = Object.entries(reportsData).map(([reportId, reportData]) => {
                        return {
                            id: reportId,
                            ...reportData,
                            // Add default status if not exists
                            status: reportData.status || 'new',
                            // Convert timestamp to readable date
                            created_at: reportData.created_at ? new Date(reportData.created_at).toLocaleDateString() : 'Unknown date',
                            // Format the date
                            date: reportData.date || 'Unknown date'
                        };
                    });
                    
                    console.log('Loaded reports:', allReports);
                    filteredReports = [...allReports];
                    displayReports();
                    updatePaginationInfo();
                    updateStats();
                    setStatsLoading(false);
                    setTableLoading(false);
                } else {
                    setStatsLoading(false);
                    setTableLoading(false);
                    console.log('No reports found in Firebase');
                    document.getElementById('reportsTableBody').innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                                No reports found in the database.
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                setStatsLoading(false);
                setTableLoading(false);
                console.error('Error loading reports:', error);
                document.getElementById('reportsTableBody').innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #dc2626;">
                            Error loading reports: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        // Update stats cards
        function updateStats() {
            const newCount = allReports.filter(r => r.status === 'new').length;
            const pendingCount = allReports.filter(r => r.status === 'pending').length;
            const inProgressCount = allReports.filter(r => r.status === 'in-progress').length;
            const resolvedCount = allReports.filter(r => r.status === 'resolved').length;
            
            document.getElementById('newCount').textContent = newCount;
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('inProgressCount').textContent = inProgressCount;
            document.getElementById('resolvedCount').textContent = resolvedCount;
        }

        // Display reports in the table
        function displayReports() {
            const tbody = document.getElementById('reportsTableBody');
            
            if (filteredReports.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                            No reports match the current filters.
                        </td>
                    </tr>
                `;
                // Ensure table skeleton state cleared when there are no rows
                setTableLoading(false);
                return;
            }

            tbody.innerHTML = '';

            const startIndex = (currentPage - 1) * reportsPerPage;
            const endIndex = startIndex + reportsPerPage;
            const reportsToShow = filteredReports.slice(startIndex, endIndex);

            reportsToShow.forEach(report => {
                const row = document.createElement('tr');
                
                // Determine reporter information
                let reporterInfo = 'Anonymous';
                if (!report.anonymous && report.reporter) {
                    reporterInfo = `${report.reporter.name} (${report.reporter.student_id})`;
                }

                // Determine type display text
                const typeDisplay = report.type ? report.type.charAt(0).toUpperCase() + report.type.slice(1) : 'Unknown';

                row.innerHTML = `
                    <td>
                        <strong>${report.id.substring(0, 8)}...</strong>
                        ${report.anonymous ? '<span class="anonymous-badge">Anonymous</span>' : ''}
                    </td>
                    <td><span class="type-badge type-${report.type || 'other'}">${typeDisplay}</span></td>
                    <td>
                        <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${report.description || 'No description'}
                        </div>
                    </td>
                    <td>${reporterInfo}</td>
                    <td>${report.date}</td>
                    <td><span class="status-badge status-${report.status || 'new'}">${(report.status || 'new').charAt(0).toUpperCase() + (report.status || 'new').slice(1)}</span></td>
                    <td class="action-buttons">
                        <button class="btn-sm btn-view btn-view-details" data-report-id="${report.id}" title="View Details">
                            <span class="material-icons" style="font-size: 16px;">visibility</span>
                        </button>
                        <button class="btn-sm btn-edit btn-edit-status" data-report-id="${report.id}" title="Update Status">
                            <span class="material-icons" style="font-size: 16px;">update</span>
                        </button>
                        <button class="btn-sm btn-delete btn-delete-report" data-report-id="${report.id}" title="Delete Report">
                            <span class="material-icons" style="font-size: 16px;">delete</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
                // Attach event listeners to avoid relying on inline onclick (module scope safe)
                const viewBtn = row.querySelector('.btn-view-details');
                if (viewBtn) viewBtn.addEventListener('click', () => viewReport(report.id));
                const editBtn = row.querySelector('.btn-edit-status');
                if (editBtn) editBtn.addEventListener('click', () => updateReportStatusModal(report.id));
                const delBtn = row.querySelector('.btn-delete-report');
                if (delBtn) delBtn.addEventListener('click', () => deleteReport(report.id));
            });
            // Done rendering rows - ensure skeletons are hidden
            setTableLoading(false);
        }

        // Filter reports based on selected filters
        function filterReports() {
            const typeFilter = document.getElementById('typeFilter').value;
            const anonymousFilter = document.getElementById('anonymousFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFromFilter').value;
            const dateTo = document.getElementById('dateToFilter').value;

            filteredReports = allReports.filter(report => {
                const matchesType = !typeFilter || report.type === typeFilter;
                const matchesAnonymous = anonymousFilter === '' || 
                    (anonymousFilter === 'true' && report.anonymous) ||
                    (anonymousFilter === 'false' && !report.anonymous);
                const matchesStatus = !statusFilter || report.status === statusFilter;
                const matchesDateFrom = !dateFrom || (report.date && report.date >= dateFrom);
                const matchesDateTo = !dateTo || (report.date && report.date <= dateTo);

                return matchesType && matchesAnonymous && matchesStatus && matchesDateFrom && matchesDateTo;
            });

            currentPage = 1;
            displayReports();
            updatePaginationInfo();
        }

        // View report details
        function viewReport(reportId) {
            const report = allReports.find(r => r.id === reportId);
            if (report) {
                document.getElementById('modalTitle').textContent = 'Report Details';
                document.getElementById('updateStatusBtn').style.display = 'none';
                
                let reporterHTML = '';
                if (report.anonymous) {
                    reporterHTML = `
                        <div class="reporter-info">
                            <h4 style="margin: 0 0 10px 0; color: #374151;">Reporter Information</h4>
                            <p style="margin: 0; color: #6b7280;"><strong>Status:</strong> Anonymous Report</p>
                        </div>
                    `;
                } else if (report.reporter) {
                    reporterHTML = `
                        <div class="reporter-info">
                            <h4 style="margin: 0 0 10px 0; color: #374151;">Reporter Information</h4>
                            <p style="margin: 5px 0;"><strong>Name:</strong> ${report.reporter.name}</p>
                            <p style="margin: 5px 0;"><strong>Student ID:</strong> ${report.reporter.student_id}</p>
                            <p style="margin: 5px 0;"><strong>Email:</strong> ${report.reporter.email}</p>
                            <p style="margin: 5px 0;"><strong>Mobile:</strong> ${report.reporter.mobile}</p>
                            <p style="margin: 5px 0;"><strong>Campus:</strong> ${report.reporter.campus}</p>
                            <p style="margin: 5px 0;"><strong>College:</strong> ${report.reporter.college}</p>
                        </div>
                    `;
                }

                let attachmentsHTML = '';
                if (report.attachments && report.attachments.length > 0) {
                    attachmentsHTML = `
                        <div class="form-group">
                            <label>Attachments</label>
                            ${report.attachments.map(attachment => `
                                <div class="attachment-item">
                                    <span class="material-icons attachment-icon">attach_file</span>
                                    <div>
                                        <div style="font-weight: 600;">${attachment.filename}</div>
                                        <div style="font-size: 12px; color: #6b7280;">
                                            ${(attachment.size / 1024).toFixed(2)} KB
                                        </div>
                                    </div>
                                    <button class="btn-sm btn-download" data-file-key="${attachment.fileKey}" data-filename="${attachment.filename}" style="margin-left: auto;">
                                        Download
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                document.getElementById('modalBody').innerHTML = `
                    ${reporterHTML}
                    <div class="form-group">
                        <label>Report Type</label>
                        <input type="text" value="${report.type ? report.type.charAt(0).toUpperCase() + report.type.slice(1) : 'Unknown'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Current Status</label>
                        <input type="text" value="${(report.status || 'new').charAt(0).toUpperCase() + (report.status || 'new').slice(1)}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Incident Date</label>
                        <input type="text" value="${report.date || 'Unknown'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" value="${report.location || 'Not specified'}" readonly>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea readonly style="height: 120px;">${report.description || 'No description provided'}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Submitted On</label>
                        <input type="text" value="${report.created_at}" readonly>
                    </div>
                    ${attachmentsHTML}
                `;
                
                document.getElementById('reportModal').style.display = 'flex';
                // Attach download listeners for attachments
                const modalBody = document.getElementById('modalBody');
                setTimeout(() => {
                    if (!modalBody) return;
                    const dlBtns = modalBody.querySelectorAll('.btn-download');
                    dlBtns.forEach(btn => {
                        const key = btn.getAttribute('data-file-key');
                        const name = btn.getAttribute('data-filename');
                        btn.addEventListener('click', () => downloadAttachment(key, name));
                    });
                }, 0);
                // Viewing a report is considered a read-only action; do not add to Recent Activity to avoid noise.
                currentReportId = reportId;
            }
        }

        // Generic confirm helper that shows the `#confirmModal` and resolves true/false
        function showConfirm(message, title = 'Confirm') {
            return new Promise((resolve) => {
                try {
                    const modal = document.getElementById('confirmModal');
                    const lbl = document.getElementById('confirmModalLabel');
                    const body = document.getElementById('confirmModalBody');
                    const yes = document.getElementById('confirmModalYes');
                    const no = document.getElementById('confirmModalNo');
                    if (!modal || !lbl || !body || !yes || !no) {
                        // Fallback to native confirm
                        return resolve(confirm(message));
                    }
                    lbl.textContent = title || 'Confirm';
                    body.textContent = message || '';
                    modal.style.display = 'flex';
                    modal.setAttribute('aria-hidden','false');

                    function cleanup(result) {
                        try { yes.removeEventListener('click', onYes); } catch(_){}
                        try { no.removeEventListener('click', onNo); } catch(_){}
                        modal.style.display = 'none';
                        modal.setAttribute('aria-hidden','true');
                        resolve(!!result);
                    }
                    function onYes() { cleanup(true); }
                    function onNo() { cleanup(false); }
                    yes.addEventListener('click', onYes);
                    no.addEventListener('click', onNo);
                    // dismiss when clicking backdrop
                    function onBackdrop(ev) { if (ev.target === modal) { modal.removeEventListener('click', onBackdrop); cleanup(false); } }
                    modal.addEventListener('click', onBackdrop);
                    // Escape key
                    function onKey(e) { if (e.key === 'Escape') { cleanup(false); document.removeEventListener('keydown', onKey); } }
                    document.addEventListener('keydown', onKey);
                } catch (err) { console.debug && console.debug('showConfirm error', err); resolve(confirm(message)); }
            });
        }

        // Update report status
     // Update report status
async function updateReportStatus() {
    if (!currentReportId) return;

    const newStatus = document.getElementById('newStatus').value;
    const counselorNotes = document.getElementById('counselorNotes').value;
    const reportRef = ref(db, `reports/${currentReportId}`);

    try {
        await update(reportRef, {
            status: newStatus,
            counselor_notes: counselorNotes,
            updated_at: Date.now()
        });

        // Update local data
        const reportIndex = allReports.findIndex(r => r.id === currentReportId);
        if (reportIndex !== -1) {
            allReports[reportIndex].status = newStatus;
            allReports[reportIndex].counselor_notes = counselorNotes;
        }

        displayReports();
        updateStats();
        closeModal();
        	    showInfo('Report status updated successfully!');
            try { if (window.pushLocalActivity) window.pushLocalActivity(`Updated report ${currentReportId} status to ${newStatus}`, 'ðŸ”'); } catch(e) { console.warn('pushLocalActivity', e); }
    } catch (error) {
        console.error('Error updating report status:', error);
        alert('Error updating report status: ' + error.message);
    }
}
        // Open update status modal
       // Open update status modal
function updateReportStatusModal(reportId) {
    const report = allReports.find(r => r.id === reportId);
    if (report) {
        document.getElementById('modalTitle').textContent = 'Update Report Status';
        document.getElementById('updateStatusBtn').style.display = 'block';
        document.getElementById('updateStatusBtn').setAttribute('data-report-id', reportId);
        
        document.getElementById('modalBody').innerHTML = `
            <div class="form-group">
                <label>Report ID</label>
                <input type="text" value="${report.id}" readonly>
            </div>
            <div class="form-group">
                <label>Current Status</label>
                <input type="text" value="${(report.status || 'new').charAt(0).toUpperCase() + (report.status || 'new').slice(1)}" readonly>
            </div>
            <div class="form-group">
                <label>New Status</label>
                <select id="newStatus">
                    <option value="new" ${report.status === 'new' ? 'selected' : ''}>New</option>
                    <option value="pending" ${report.status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="in-progress" ${report.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                    <option value="resolved" ${report.status === 'resolved' ? 'selected' : ''}>Resolved</option>
                </select>
            </div>
            <div class="form-group">
                <label>Report Description</label>
                <textarea readonly style="height: 80px;">${report.description || 'No description'}</textarea>
            </div>
            <div class="form-group">
                <label>Counselor Notes</label>
                <textarea id="counselorNotes" placeholder="Add notes about actions taken, follow-up required, or resolution details..." style="height: 120px;">${report.counselor_notes || ''}</textarea>
            </div>
        `;
        
        document.getElementById('reportModal').style.display = 'flex';
        // ensure Update button calls the module function
        const updateBtnModal = document.getElementById('updateStatusBtn');
        if (updateBtnModal) { updateBtnModal.onclick = updateReportStatus; }
        currentReportId = reportId;
    }
}
        // Delete report
        async function deleteReport(reportId) {
            const ok = await showConfirm(`Delete report ${reportId}? This action cannot be undone.`, 'Confirm Delete');
            if (!ok) return;

                try {
                    // Permanently remove the report from Firebase Realtime Database
                    const reportRef = ref(db, `reports/${reportId}`);
                    await remove(reportRef);

                    // Also update local state so UI updates immediately
                    allReports = allReports.filter(r => r.id !== reportId);
                    filteredReports = filteredReports.filter(r => r.id !== reportId);

                    displayReports();
                    updatePaginationInfo();
                    updateStats();
                    alert('Report deleted successfully!');
                    try { if (window.pushLocalActivity) window.pushLocalActivity(`Deleted report ${reportId}`, 'ðŸ—‘ï¸'); } catch(e) { console.warn('pushLocalActivity', e); }
                } catch (error) {
                    console.error('Error deleting report:', error);
                    alert('Error deleting report: ' + error.message);
                }
        }

        // Download attachment (placeholder function)
        function downloadAttachment(fileKey, filename) {
            alert(`This would download attachment: ${filename}\nFile Key: ${fileKey}`);
            // Downloads are not recorded in Recent Activity to reduce noise.
            // In real implementation, you would fetch the file from Firebase Storage
        }

        // Export reports
        function exportReports() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Report ID,Type,Description,Reporter,Date,Status,Anonymous\n"
                + filteredReports.map(report => {
                    const reporter = report.anonymous ? 'Anonymous' : 
                        (report.reporter ? `${report.reporter.name} (${report.reporter.student_id})` : 'Unknown');
                    return `"${report.id}","${report.type}","${report.description || ''}","${reporter}","${report.date}","${report.status || 'new'}","${report.anonymous}"`;
                }).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "reports_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            try { if (window.pushLocalActivity) window.pushLocalActivity(`Exported ${filteredReports.length} reports`, 'ðŸ“¤'); } catch(e) { console.warn('pushLocalActivity', e); }
        }

        // Refresh reports: reset filters, reload data and update UI
        async function refreshReports() {
            try {
                // reset filters to default (show all)
                const filterIds = ['typeFilter','anonymousFilter','statusFilter','dateFromFilter','dateToFilter'];
                filterIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });

                // reset pagination
                currentPage = 1;

                // show loading indicators while fetching
                try { setTableLoading(true); } catch (e) {}
                try { setStatsLoading(true); } catch (e) {}

                await loadReportsFromFirebase();

                // ensure UI is updated
                displayReports();
                updatePaginationInfo();
                updateStats();

                // Do not show modal for refresh; use console log for non-blocking feedback
                console.log('Reports refreshed successfully.');
            } catch (error) {
                console.error('Error refreshing reports:', error);
                showInfo('Error refreshing reports: ' + (error && error.message ? error.message : error));
            } finally {
                try { setTableLoading(false); } catch (e) {}
                try { setStatsLoading(false); } catch (e) {}
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('reportModal').style.display = 'none';
            currentReportId = null;
        }

        // Show an information modal (replacement for alert())
        function showInfo(message) {
            const infoModal = document.getElementById('infoModal');
            const infoBody = document.getElementById('infoModalBody');
            const okBtn = document.getElementById('infoModalOk');
            if (!infoModal || !infoBody || !okBtn) {
                // fallback to alert if modal not present
                alert(message);
                return;
            }
            infoBody.textContent = message;
            infoModal.style.display = 'flex';
            okBtn.onclick = () => { infoModal.style.display = 'none'; };
        }

        // Pagination functions
        function changePage(direction) {
            const totalPages = Math.ceil(filteredReports.length / reportsPerPage);
            currentPage += direction;
            
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            displayReports();
            updatePaginationInfo();
        }

        function updatePaginationInfo() {
            const totalReports = filteredReports.length;
            const startIndex = (currentPage - 1) * reportsPerPage + 1;
            const endIndex = Math.min(startIndex + reportsPerPage - 1, totalReports);
            
            document.getElementById('paginationInfo').textContent = 
                totalReports > 0 
                ? `Showing ${startIndex}-${endIndex} of ${totalReports} reports`
                : 'No reports found';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('reportModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Logout functionality (wrapped so runtime errors are caught)
        try {
            (function(){
                function attachLogout(){
                    const sidebarLogout = document.getElementById('sidebarLogoutBtn');
                    if (!sidebarLogout) return;
                    if (sidebarLogout._logoutHandlerAttached) return;
                    sidebarLogout._logoutHandlerAttached = true;
                    const confirmModal = document.getElementById('confirmModalLogout');
                    const confirmOk = document.getElementById('confirmModalLogoutOk');
                    const confirmCancel = document.getElementById('confirmModalLogoutCancel');
                    function doLogout(){
                        const profileLogout = document.getElementById('accountLogout');
                        if (profileLogout) { profileLogout.click(); return; }
                        if (typeof window.signOutAndRedirect === 'function') { window.signOutAndRedirect(); return; }
                        try { localStorage.removeItem('authToken'); } catch(e){}
                        window.location.href = 'login.html';
                    }
                    sidebarLogout.addEventListener('click', () => {
                        if (!confirmModal || !confirmOk || !confirmCancel) { 
                            if (confirm('Are you sure you want to sign out?')) doLogout(); 
                            return; 
                        }
                        confirmModal.style.display = 'flex';
                        function cleanup(){ 
                            confirmModal.style.display = 'none'; 
                            confirmOk.removeEventListener('click', onOk); 
                            confirmCancel.removeEventListener('click', onCancel); 
                            document.removeEventListener('keydown', onKeyDown); 
                        }
                        function onOk(){ cleanup(); doLogout(); }
                        function onCancel(){ cleanup(); }
                        function onKeyDown(e){ if (e.key === 'Escape') cleanup(); }
                        confirmOk.addEventListener('click', onOk);
                        confirmCancel.addEventListener('click', onCancel);
                        document.addEventListener('keydown', onKeyDown);
                    });
                }
                if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attachLogout); 
                else attachLogout();
            })();
        } catch (e) {
            console.error('Logout IIFE threw an error:', e);
        }
            // Expose module-scoped functions to the global window so inline
            // onclick="viewReport('...')" (and similar) work when this script
            // is loaded with type="module".
            // These make the handlers available to the DOM inline attributes.
            window.viewReport = viewReport;
            window.updateReportStatusModal = updateReportStatusModal;
            window.deleteReport = deleteReport;
            window.downloadAttachment = downloadAttachment;
            // Also expose functions that are referenced by inline attributes in the HTML
            window.filterReports = filterReports;
            window.changePage = changePage;
            window.exportReports = exportReports;
            window.refreshReports = refreshReports;
            window.closeModal = closeModal;
            window.updateReportStatus = updateReportStatus;
    </script>
    <script src="./profile_dropdown.js"></script>
</body>
</html>