<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - Session Reports</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Prevent browser caching of this page
        if (window.history && window.history.replaceState) {
            window.history.replaceState(null, '', window.location.href);
        }
        window.addEventListener('pageshow', function(event) {
            if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
                window.location.reload();
            }
        });
    </script>
    <style>
        /* --- START OF SHARED STYLES (MATCHED TO admin_dashboard.html) --- */
        html, body { /* Added 'html,' and '!important' for Tailwind override */
            font-family: Arial, sans-serif !important;
            margin: 0;
            background-color: #f4f7fa;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }
        /* HEADER & TOP BAR STYLES */
        .header-and-sidebar-top {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1400;
            display: flex;
            background-color: #1e8e3e;
            color: #f0f3f6;
            height: 60px;
            transition: left 0.3s ease;
        }
        .sidebar-top {
            width: 250px;
            display: flex;
            align-items: center;
            padding: 10px 20px;
            box-sizing: border-box;
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            height: 60px;
            transition: width 0.3s ease;
        }
        .sidebar-top.collapsed {
            width: 80px;
            justify-content: center;
        }
        .sidebar-top.collapsed .sidebar-logo {
            opacity: 0;
            pointer-events: none;
            width: 0;
        }
        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            transition: opacity 0.3s ease, width 0.3s ease;
        }
        .sidebar-logo img {
            height: 40px;
        }
        .sidebar-logo span {
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
            white-space: nowrap;
        }
        .menu-icon {
            cursor: pointer;
            font-size: 24px;
            margin-left: auto;
            transition: all 0.3s ease;
            padding: 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            min-height: 40px;
        }
        .menu-icon:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        .menu-icon:active {
            transform: scale(0.95);
            background-color: rgba(255, 255, 255, 0.3);
        }
        .main-top-bar {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 30px; 
        }
        .main-top-bar .portal-title {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }
        .main-top-bar .user-info {
            display: flex;
            align-items: center;
            color: white;
        }
        .main-top-bar .user-info .material-icons {
            margin-right: 10px;
            font-size: 24px;
        }
        .main-top-bar .user-avatar {
            width: 40px;
            height: 40px;
            background-color: white;
            color: #1e8e3e; 
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-left: 10px;
            font-size: 18px;
        }
        /* SIDEBAR STYLES */
        .sidebar {
            width: 250px;
            background: #f0f3f6;
            border-right: 1px solid rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 60px;
            left: 0;
            height: calc(100vh - 60px);
            z-index: 999;
            overflow: auto;
            transition: width 0.3s ease;
        }
        .nav-menu ul {
            list-style: none;
            padding: 12px;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .nav-item {
            color: #1f2937;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 10px;
            border-radius: 8px;
            border: 0;
            background: transparent;
            cursor: pointer;
            font-weight: 400;
            font-size: 15px;
            transition: background 0.2s, color 0.2s;
            text-align: left;
            width: 100%;
        }
        .nav-item:hover {
            background: rgba(15,122,52,0.08) !important;
            color: #0f7a34 !important;
            font-weight: 400 !important;
            border-radius: 8px !important;
        }
        .nav-item.active {
            background: rgba(15,122,52,0.12) !important;
            color: #0f7a34 !important;
            font-weight: 600 !important;
        }
        .nav-item:hover .icon,
        .nav-item.active .icon {
            color: #1f2937 !important;
        }
        .nav-item .icon {
            width: 28px;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            line-height: 1;
            color: #1f2937;
            transition: color 0.2s;
        }
        .nav-item .label {
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            opacity: 1;
            transition: opacity 0.2s, transform 0.2s;
        }
        .sidebar.collapsed {
            width: 80px;
        }
        .sidebar.collapsed .nav-item .label {
            display: none;
        }
        .sidebar.collapsed .nav-item .icon {
            width: 56px;
            font-size: 26px;
            justify-content: center;
        }
        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 12px 6px;
            gap: 0;
        }
        /* --- END OF SHARED STYLES --- */

        /* Mobile sidebar overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 998;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
                box-shadow: 4px 0 15px rgba(0, 0, 0, 0.2);
                transition: transform 0.3s ease;
            }
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            .sidebar.collapsed {
                width: 280px;
                transform: translateX(-100%);
            }
        }
        /* MAIN CONTENT STYLES */
        .main-content {
            position: fixed;
            top: 60px; 
            left: 250px; 
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            overflow: auto; /* internal scrolling */
            padding: 30px;
            transition: left 0.3s ease;
            min-height: auto;
            background: transparent;
        }

        .main-content.shifted {
            left: 80px; /* when sidebar collapses */
        }
        
        /* Mobile overlay and responsive content */
        @media (max-width: 768px) {
            .main-content {
                left: 0 !important; /* full width on small screens */
                padding: 20px 15px;
            }
            .main-content.shifted {
                left: 0;
            }
        }
        
        @media (max-width: 480px) {
            .main-content {
                padding: 15px 10px;
            }
        }
        /* --- END OF SHARED STYLES --- */

        /* --- START OF CUSTOM STYLES FOR REPLACED CONTENT --- */
        .sidebar-footer {
            margin-top: auto;
            padding: 12px;
        }
        .sidebar-footer .nav-item { display:flex; align-items:center; gap:12px; padding:10px; border-radius:8px; }
        .sidebar-footer .nav-item .label { transition: opacity 0.15s ease; }
        .sidebar.collapsed .sidebar-footer .nav-item .label { display:none; }
        .sidebar-footer { z-index: 1000; }
        
    /* Profile dropdown styles (shared across pages) */
    .profile-dropdown .profile-card {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 12px 34px rgba(2,6,23,0.12), 0 4px 10px rgba(2,6,23,0.06);
      overflow: hidden;
      animation: fadeIn .12s ease;
      transition: transform .14s ease, box-shadow .14s ease, opacity .12s ease;
      transform-origin: top right;
    }
    .profile-card-top { display:flex; justify-content:center; padding:14px 12px 6px; }
    .avatar-large {
      width:120px; height:120px; border-radius:50%; background:#f3faf5; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:32px; position:relative; overflow:hidden; border:4px solid rgba(16,185,129,0.06);
    }
    .avatar-large img { width:100%; height:100%; object-fit:cover; display:block; transition: transform .18s ease; box-shadow: 0 6px 18px rgba(2,6,23,0.08); }
    .avatar-large:hover img { transform: scale(1.02); }
    .avatar-camera { position:absolute; right:6px; bottom:6px; border-radius:50%; background:#fff; border:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 12px rgba(2,6,23,0.06); cursor:pointer; font-size:13px; }
    .profile-card-body { padding: 10px 18px 16px; text-align:center; display:flex; flex-direction:column; gap:8px; }
    .profile-email { font-size:13px; color:#6b7280; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .profile-greeting { font-weight:700; font-size:18px; margin-top:4px; color:#111827; }
    .manage-btn { display:inline-block; width:100%; padding:10px 12px; border-radius:999px; border:1px solid rgba(16,185,129,0.12); background:#10b981; color:#fff; font-weight:700; box-shadow:none; cursor:pointer; }
    .manage-btn:hover { transform:none; filter:brightness(.98); }
    .profile-divider { height:1px; background:#f1f5f9; margin:8px 0; }
    .profile-actions { display:flex; justify-content:space-between; gap:12px; align-items:center; }
    .profile-link { flex:1; text-align:left; border:0; background:transparent; padding:8px; color:#374151; font-weight:600; cursor:pointer; }
    .signout-link { flex:1; text-align:right; border:0; background:transparent; padding:8px; color:#ef4444; font-weight:700; cursor:pointer; }
    @media (max-width:420px) { .profile-dropdown { right:8px !important; left:8px !important; min-width:auto; } }
    .profile-dropdown[aria-hidden="false"] .profile-card { transform: translateY(-6px); box-shadow: 0 20px 54px rgba(2,6,23,0.16), 0 6px 18px rgba(2,6,23,0.06); }

    .icon-btn { background: transparent !important; border: 0 !important; outline: none !important; box-shadow: none !important; padding: 6px; display: inline-flex; align-items: center; justify-content: center; color: white; cursor: pointer; }
    .icon-btn:focus, .icon-btn:active {
        outline: none !important;
        border: 0 !important;
        box-shadow: none !important;
    }

    /* popover / dropdown visibility controlled by attributes */
    .popover { display: none; }
    .popover[data-open="true"] { display: block; }
    .dropdown { display: none; }
    .dropdown[aria-hidden="false"] { display: block; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    /* Make sidebar logout text/icon red on hover/focus and keyboard focus */
    #sidebarLogoutBtn { cursor: pointer; }
    #sidebarLogoutBtn .label, #sidebarLogoutBtn .icon {
        color: inherit;
        transition: color 160ms ease-in-out, transform 120ms ease;
    }
    /* Hover and focus (mouse) */
    #sidebarLogoutBtn:hover .label,
    #sidebarLogoutBtn:hover .icon {
        color: #ef4444 !important; /* red text/icon on hover */
    }
    /* Keyboard focus visible for accessibility */
    #sidebarLogoutBtn:focus-visible .label,
    #sidebarLogoutBtn:focus-visible .icon {
        color: #ef4444 !important; /* red text/icon on keyboard focus */
    }
        /* Added from try.html to support the accordion effect's rotation */
        .rotate-180 {
            transform: rotate(180deg);
        }
           /* Session Note Modal (copied from todo.html) */
            #modal {
                display: none;
                position: fixed;
                inset: 0;
                z-index: 5000; /* must be above the header (1400) */
                align-items: center;
                justify-content: center;
                background: rgba(0, 0, 0, 0.45);
                /* use flex centering when shown */
                display: none;
            }

        #modal>div {
            background: #fff;
            width: 820px;
            max-width: calc(100% - 32px);
            border-radius: 12px;
            box-shadow: 0 12px 40px rgba(2, 6, 23, 0.2);
            padding: 18px;
            /* keep modal content readable within the viewport */
            max-height: calc(100vh - 140px);
            overflow: auto;
        }

    #modal h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      font-weight: 700;
    }

    #modal label {
      font-size: 12px;
      color: #6b7280;
    }

    #modal input,
    #modal select,
    #modal textarea {
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #e6eef7;
    }

    #modal textarea {
      resize: vertical;
    }

    #modal .btn {
      padding: 8px 12px;
      border-radius: 6px;
      border: 0;
      cursor: pointer;
      font-weight: 600;
    }

    #modal .btn.save {
      background: #10b981;
      color: #fff;
    }

    #modal .btn.submit {
      background: #2563eb;
      color: #fff;
    }

    #modal .btn.close {
      background: transparent;
      border: 0;
      color: #6b7280;
      cursor: pointer;
    }

    /* Note: the visual loading overlay (spinner + message) was removed per request.
       Skeleton placeholders remain; leave the loading-skeleton keyframes intact. */

    .loading-skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 4px;
    }

    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    .skeleton-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        min-height: 88px; /* match summary card height */
        border-radius: 8px;
        background: #fff;
        box-sizing: border-box;
    }

    .skeleton-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        flex: 0 0 48px;
    }

    .skeleton-card-content { flex: 1; }

    .skeleton-row {
        height: 14px;
        margin-bottom: 8px;
        border-radius: 6px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }

    .skeleton-row.title { height: 16px; width: 50%; }
    .skeleton-row.sub { height: 12px; width: 40%; }

    /* Table skeleton: use one <td> per column so placeholders align under headers */
    .skeleton-cell {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 6px;
        height: 14px;
        display: block;
        margin: 6px 0;
    }

    /* Relative widths for the placeholder bars inside each column */
    .skeleton-student { width: 70%; }
    .skeleton-counselor { width: 60%; }
    .skeleton-date { width: 50%; }
    .skeleton-session { width: 35%; }
    .skeleton-status { width: 55%; }
    .skeleton-actions { width: 40%; }
        /* --- END OF CUSTOM STYLES FOR REPLACED CONTENT --- */
    </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen">
    <!-- Loading Overlay (moved inside session card) -->

    <div class="header-and-sidebar-top">
        <aside class="sidebar-top" id="sidebarTop">
            <div class="sidebar-logo">
                <img src="safespace.png" alt="SafeSpace Logo">
                <span>SafeSpace</span>
            </div>
            <i class="material-icons menu-icon" id="menuIcon">menu</i>
        </aside>
        <header class="main-top-bar">
            <h1 class="portal-title">Admin Portal</h1>
            <div class="user-info">
                <div class="top-greeting" aria-live="polite" style="margin-right:12px; text-align:right; color:#fff; margin-left:8px;">
                    <div id="topGreetingName" style="font-weight:700; font-size:14px;">Good Morning, Admin</div>
                    <div id="topGreetingTime" style="font-size:12px; opacity:0.95; margin-top:2px;">Tuesday, Oct 14, 2025 — 02:51 AM</div>
                </div>
                <div style="position:relative;display:inline-block;">
                    <button id="notifBtn" class="icon-btn" aria-expanded="false" title="Notifications" style="color:white;background:#16a34a;padding:8px;border-radius:8px;border:0;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 6px 14px rgba(22,163,74,0.15);">
                        <i class="material-icons" style="color:white;font-size:20px;">notifications</i>
                    </button>
                    <div id="notifPanel" class="popover" data-open="false" style="position:fixed;right:20px;top:62px;min-width:280px;z-index:4500;display:none;">
                        <div class="notif-card" role="dialog" aria-label="Notifications" aria-hidden="true" style="border-radius:10px;overflow:hidden;box-shadow:0 12px 30px rgba(2,6,23,0.08);background:#fff;font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-width:280px;">
                            <div class="notif-header popover-header" style="background:#10b981;color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;">
                                <div class="notif-title" style="font-weight:700;font-size:15px;">Notifications</div>
                                <div id="notifTimestamp" class="notif-timestamp" style="font-size:12px;opacity:0.95;">--</div>
                            </div>
                            <div id="notifList" class="popover-body" style="color:#111827;padding:8px 12px;">
                                <div class="popover-empty">No new notifications.</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div style="position:relative;display:inline-block;margin-left:-8px;">
                    <button id="profileBtn" class="user-avatar" aria-haspopup="true" aria-expanded="false" title="Profile" style="border:0;cursor:pointer;padding:0;position:relative;overflow:hidden;">
                        <div id="profileBtnSpinner" style="position:absolute;inset:0;display:none;align-items:center;justify-content:center;pointer-events:none">
                            <svg width="28" height="28" viewBox="0 0 50 50" aria-hidden="true">
                                <circle cx="25" cy="25" r="18" fill="#ffffff" opacity="0.2"></circle>
                                <path fill="#10B981" d="M25 5a20 20 0 0 1 0 6a14 14 0 1 0 0 28 14 14 0 0 1 0-34">
                                    <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite" />
                                </path>
                            </svg>
                        </div>
                        <div id="profileBtnDefaultIcon" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none">
                            <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5z" fill="#9CA3AF"></path>
                                <path d="M3 20c0-2.761 4.477-5 9-5s9 2.239 9 5v1H3v-1z" fill="#9CA3AF"></path>
                            </svg>
                        </div>
                    </button>
                    <div id="profileDropdown" class="dropdown profile-dropdown" aria-hidden="true" style="position:fixed;right:20px;top:62px;min-width:320px;z-index:3000;">
                        <div style="background:#fff;border-radius:12px;padding:10px;min-width:320px;box-shadow:0 12px 30px rgba(2,6,23,0.12);font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111;">
                            <div style="display:flex;gap:12px;align-items:center;padding:10px;border-bottom:1px solid rgba(0,0,0,0.06)">
                                <div class="avatar-large" id="profileAvatar" style="width:80px;height:80px;border-radius:60px;overflow:hidden;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-weight:700;color:#111;font-size:18px"></div>
                                <div style="flex:1;min-width:0">
                                    <div id="profileGreeting" style="font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Hi, Admin</div>
                                    <div id="profileEmail" style="font-size:13px;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">you@example.com</div>
                                </div>
                            </div>
                            <div style="padding:8px 6px;display:flex;flex-direction:column;gap:6px">
                                <button id="accountEdit" class="profile-item" style="text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;cursor:pointer;display:flex;align-items:center;gap:10px">
                                    <i class="material-icons icon" style="font-size:18px;line-height:1;">person</i>
                                    <span style="flex:1;text-align:left">Manage your profile</span>
                                </button>
                                <button id="accountSettings" class="profile-item" style="text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;cursor:pointer;display:flex;align-items:center;gap:10px">
                                    <i class="material-icons icon" style="font-size:18px;line-height:1;">settings</i>
                                    <span style="flex:1;text-align:left">Settings & privacy</span>
                                    <i class="material-icons icon" style="font-size:16px;opacity:0.7;">chevron_right</i>
                                </button>
                                <button id="accountLogout" class="profile-item" style="text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;cursor:pointer;display:flex;align-items:center;gap:10px;color:#111;font-weight:600">
                                    <i class="material-icons icon" style="font-size:18px;line-height:1;color:#ef4444">logout</i>
                                    <span style="flex:1;text-align:left">Log Out</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </div>

    <div class="container">
        <aside class="sidebar" id="sidebar">
            <nav class="nav-menu">
                <nav class="nav" id="nav" style="display:flex;flex-direction:column;gap:8px;padding:12px;">
                    <button class="nav-item" onclick="location.href='admin_dashboard.html'" data-name="Dashboard">
                        <span class="material-icons icon" style="font-size:26px;">dashboard</span>
                        <span class="label" style="font-size:15px;">Home</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_user_management.html'" data-name="User Management">
                        <span class="material-icons icon" style="font-size:26px;">groups</span>
                        <span class="label" style="font-size:15px;">Student Management</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_counselor_management.html'" data-name="Counselor Management">
                        <span class="material-icons icon" style="font-size:26px;">psychology</span>
                        <span class="label" style="font-size:15px;">Counselor Management</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_content_management.html'" data-name="Content Management">
                        <span class="material-icons icon" style="font-size:26px;">description</span>
                        <span class="label" style="font-size:15px;">Content Management</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_report_management.html'" data-name="Reports Management">
                        <span class="material-icons icon" style="font-size:26px;">warning</span>
                        <span class="label">Reports Management</span>
                    </button>
                    <button class="nav-item active" onclick="location.href='admin_session_report.html'" data-name="Session Reports">
                        <span class="material-icons icon" style="font-size:26px;">fact_check</span>
                        <span class="label">Session Reports</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_psych_test.html'" data-name="Session Reports">
                        <span class="material-icons icon" style="font-size:26px;">assessment</span>
                        <span class="label">Psychological Test</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_settings.html'" data-name="System Settings">
                        <span class="material-icons icon" style="font-size:26px;">settings</span>
                        <span class="label" style="font-size:15px;">System Settings</span>
                    </button>
                </nav>
            </nav>
            <div class="sidebar-footer">
                <button class="nav-item" id="sidebarLogoutBtn" type="button" title="Sign out">
                    <i class="material-icons icon" style="font-size:26px;">logout</i>
                    <span class="label" style="font-size:15px;">Logout</span>
                </button>
            </div>
        </aside>
        
        <!-- MAIN CONTENT AREA -->
        <main class="main-content" id="mainContent">
            <div class="bg-white rounded-lg shadow-sm p-6">

                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">Session Report</h1>
                </div>

                <!-- SUMMARY CARDS - Skeleton Loading -->
                <div id="summaryCards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="skeleton-card">
                        <div class="skeleton-avatar"></div>
                        <div class="skeleton-card-content">
                            <div class="skeleton-row title"></div>
                            <div class="skeleton-row sub"></div>
                        </div>
                    </div>
                    <div class="skeleton-card">
                        <div class="skeleton-avatar"></div>
                        <div class="skeleton-card-content">
                            <div class="skeleton-row title"></div>
                            <div class="skeleton-row sub"></div>
                        </div>
                    </div>
                    <div class="skeleton-card">
                        <div class="skeleton-avatar"></div>
                        <div class="skeleton-card-content">
                            <div class="skeleton-row title"></div>
                            <div class="skeleton-row sub"></div>
                        </div>
                    </div>
                </div>
                
                <!-- FILTERS AND SEARCH -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                            <div class="relative">
                                <input type="text" placeholder="Search by student or counselor" class="w-full border border-gray-300 rounded-lg p-2 pl-10 focus:ring-green-400 focus:outline-none">
                                <i class="material-icons absolute left-3 top-2.5 text-gray-400 text-lg">search</i>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select class="border border-gray-300 rounded-lg p-2 focus:ring-green-400 focus:outline-none w-full md:w-40">
                                <option>All Sessions</option>
                                <option>Ongoing</option>
                                <option>Completed</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                            <select class="border border-gray-300 rounded-lg p-2 focus:ring-green-400 focus:outline-none w-full md:w-40">
                                <option>All Time</option>
                                <option>Last 7 Days</option>
                                <option>Last 30 Days</option>
                                <option>Last 3 Months</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- SESSION REPORTS TABLE - Skeleton Loading -->
                <div class="bg-white rounded-lg overflow-hidden border border-gray-200" style="position:relative;">
                    <!-- Loading overlay removed: using in-table skeleton placeholders instead -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-green-600 text-white">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Student</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Counselor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Session #</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="sessionTableBody">
                                <!-- Skeleton rows while loading -->
                                <tr>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-student" role="status" aria-label="Loading student"></div></td>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-counselor" role="status" aria-label="Loading counselor"></div></td>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-date" role="status" aria-label="Loading date"></div></td>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-session" role="status" aria-label="Loading session"></div></td>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-status" role="status" aria-label="Loading status"></div></td>
                                    <td class="px-6 py-4 text-center"><div class="skeleton-cell skeleton-actions" role="status" aria-label="Loading actions"></div></td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-student"></div></td>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-counselor"></div></td>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-date"></div></td>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-session"></div></td>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-status"></div></td>
                                    <td class="px-6 py-4 text-center"><div class="skeleton-cell skeleton-actions"></div></td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-student"></div></td>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-counselor"></div></td>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-date"></div></td>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-session"></div></td>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-status"></div></td>
                                    <td class="px-6 py-4 text-center"><div class="skeleton-cell skeleton-actions"></div></td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-student"></div></td>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-counselor"></div></td>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-date"></div></td>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-session"></div></td>
                                    <td class="px-6 py-4"><div class="skeleton-cell skeleton-status"></div></td>
                                    <td class="px-6 py-4 text-center"><div class="skeleton-cell skeleton-actions"></div></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- PAGINATION -->
                    <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                        <div class="flex-1 flex justify-between sm:hidden">
                            <button class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Previous</button>
                            <button class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Next</button>
                        </div>
                        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                            <div>
                                <p class="text-sm text-gray-700">
                                    <span class="font-medium">Loading...</span>
                                </p>
                            </div>
                            <div>
                                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                                    <button class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                        <span class="sr-only">Previous</span>
                                        <i class="material-icons text-sm">chevron_left</i>
                                    </button>
                                    <button aria-current="page" class="z-10 bg-green-50 border-green-500 text-green-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">1</button>
                                    <button class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">2</button>
                                    <button class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">3</button>
                                    <button class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                        <span class="sr-only">Next</span>
                                        <i class="material-icons text-sm">chevron_right</i>
                                    </button>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile sidebar overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Logout Confirmation Modal -->
    <div id="confirmModalLogout" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;z-index:3000">
        <div style="background:#fff;border-radius:12px;padding:18px;max-width:420px;width:92%;box-shadow:0 12px 40px rgba(2,6,23,0.2)">
            <h3 id="confirmModalLogoutTitle" style="margin:0 0 8px 0;font-size:16px;font-weight:700">Confirm</h3>
            <div id="confirmModalLogoutMessage" style="font-size:15px;margin-bottom:12px;color:#111">Are you sure you want to sign out?</div>
            <div style="display:flex;gap:8px;justify-content:flex-end">
                <button id="confirmModalLogoutCancel" style="background:#6c757d;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer">Cancel</button>
                <button id="confirmModalLogoutOk" style="background:#00723f;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer">Confirm</button>
            </div>
        </div>
    </div>

   <div id="modal"
    style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:1200;background:rgba(0,0,0,0.45);width:100%;height:100%;">
    <div class="modal-inner"
      style="position:relative;margin:auto;background:#fff;width:820px;max-width:calc(100% - 24px);border-radius:6px;box-shadow:0 12px 40px rgba(2,6,23,0.2);padding:14px;max-height:88vh;overflow:auto;">

  <style>
      /* Modal base */
        .modal-inner { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:#0f172a }

        /* Grid layout */
  .grid-modal { display:block; }
        /* Header box (paper-like two-row layout) */
        .grid-header { grid-column: 1 / -1; margin-bottom:12px }
        .header-box { border:1px solid #cfcfcf; padding:10px 12px; border-radius:6px; background:#fbfbfb }
        .header-row { display:flex; gap:12px; align-items:center }
        .header-row.small-gap { gap:8px; margin-top:8px }
        .header-box label { font-size:13px; color:#374151; display:block; margin-bottom:6px }
        /* Underline style inputs for paper look */
        .header-box input[type="text"], .header-box input[type="date"], .header-box input[type="time"] {
          width:100%; border:0; border-bottom:1px solid rgba(0,0,0,0.6); padding:6px 4px; background:transparent; border-radius:0;
        }

        /* Section card */
  .grid-section { border-radius:10px; background:#ffffff; padding:12px; border:1px solid #eef2f7; box-shadow:0 6px 20px rgba(15,23,42,0.04) }
  .section-title { font-weight:800; margin-bottom:8px; color:#071132; font-size:14px }

        /* Inputs / selects */
        .grid-header input, .grid-header select, .grid-section input, .grid-section select {
          width:100%; padding:8px 10px; border-radius:8px; border:1px solid #e6eef7; background:#fbfdff; box-shadow:inset 0 1px 0 rgba(255,255,255,0.6);
        }

        /* Ruled textarea with soft lines */
        textarea.ruled {
          width:100%; min-height:100px; padding:12px; border-radius:8px; border:1px solid #eef2f7; resize:vertical; background:linear-gradient(180deg,#fff,#fff);
          background-image: repeating-linear-gradient(to bottom, transparent 0, transparent 28px, rgba(15,23,42,0.03) 28px); background-size:100% 28px;
          box-shadow: inset 0 1px 0 rgba(255,255,255,0.5);
        }

        /* Checkbox group */
  /* Align checkbox labels vertically with inputs */
  .grid-section .checkbox-group { display:flex; gap:14px; align-items:center; flex-wrap:wrap }
  .grid-section .checkbox-group label { display:inline-flex; align-items:center; gap:8px; color:#0b1220; margin-right:8px }

        /* Signature inputs */
  .sign-row input { border:0; border-bottom:1px solid rgba(2,6,23,0.6); padding:8px 6px; background:transparent }

  /* Small label styles to line up section labels */
  .grid-header label, .grid-section .section-title { display:block }
  .grid-header label { color:#3b4450; font-size:12px; margin-bottom:6px }

        /* Buttons */
        #submitNote { background: linear-gradient(90deg,#2563eb,#4f46e5); color:white; border-radius:10px; padding:10px 14px; box-shadow:0 8px 16px rgba(37,99,235,0.12); border:0; cursor:pointer }
        #submitNote:hover { transform:translateY(-1px); filter:brightness(.98) }
        #saveDraft { background:#fde68a; color:#1f2937; border-radius:10px; padding:10px 14px; border:0; cursor:pointer }
        #saveDraft:hover { transform:translateY(-1px) }

        /* Close button */
        #closeModal { font-size:18px; background:transparent; border-radius:6px; padding:6px; }

        /* Responsive */
        @media (max-width:880px) { .grid-modal { grid-template-columns: 1fr } }

        /* Print rules: produce a clean, full-page print of the session report only */
        @media print {
          /* Hide all UI except the modal and its contents */
          body * { visibility: hidden !important; }
          #modal, #modal * { visibility: visible !important; }

          /* Position the modal at the page origin and make it full width for edge-to-edge look */
          #modal { position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; height: auto !important; margin: 0 !important; padding: 0 !important; background: white !important; }
          .modal-inner { box-shadow: none !important; background: white !important; color: #000 !important; }

          /* Remove any overlay/backdrop visual (overlay is hidden by visibility rules above but ensure no dark bg prints) */
          #modal { background: white !important; }

          /* Page size and zero margins to allow edge-to-edge PDF export where the printer supports it */
          @page { size: A4; margin: 0; }
        }
      </style>

      <div style="display:flex;justify-content:center;align-items:center;margin-bottom:8px;position:relative">
        <div style="flex:1;text-align:center;font-weight:800">SESSION REPORT</div>
        <button id="closeModal" style="position:absolute;right:6px;top:6px;background:transparent;border:0;color:#6b7280;cursor:pointer">✕</button>
      </div>

      <form id="noteForm">
        <div class="grid-modal">

          <!-- Header box: two-row, paper-like (preserve IDs) -->
          <div class="grid-header">
            <div class="header-box" style="display:flex;flex-direction:column;gap:8px">
              <!-- Row 1: Name (left) and Date (right) -->
              <div class="header-row" style="display:flex;gap:12px;align-items:center">
                <div style="flex:1">
                  <label for="studentName" style="font-size:12px;color:#374151;display:block;margin-bottom:6px">Name</label>
                  <input id="studentName" name="studentName" type="text" readonly value="" style="width:100%;border:0;border-bottom:1px solid rgba(0,0,0,0.6);padding:6px 4px;background:transparent;font-weight:600" />
                </div>
                <div style="width:180px">
                  <label for="noteDate" style="font-size:12px;color:#374151;display:block;margin-bottom:6px">Date</label>
                  <input id="noteDate" name="noteDate" type="date" style="width:100%;border:0;border-bottom:1px solid rgba(0,0,0,0.6);padding:6px 4px;background:transparent" />
                </div>
              </div>

              <!-- Row 2: Session No., Time Started, Time Ended -->
              <div class="header-row small-gap" style="display:flex;gap:18px;align-items:center">
                <div style="width:120px">
                  <label for="sessionNo" style="font-size:12px;color:#374151;display:block;margin-bottom:6px">Session No.</label>
                  <input id="sessionNo" name="sessionNo" type="text" style="width:100%;border:0;border-bottom:1px solid rgba(0,0,0,0.6);padding:6px 4px;background:transparent" />
                </div>
                <div style="width:160px">
                  <label for="timeStarted" style="font-size:12px;color:#374151;display:block;margin-bottom:6px">Time Started</label>
                  <input id="timeStarted" name="timeStarted" type="time" style="width:100%;border:0;border-bottom:1px solid rgba(0,0,0,0.6);padding:6px 4px;background:transparent" />
                </div>
                <div style="width:160px">
                  <label for="timeEnded" style="font-size:12px;color:#374151;display:block;margin-bottom:6px">Time Ended</label>
                  <input id="timeEnded" name="timeEnded" type="time" style="width:100%;border:0;border-bottom:1px solid rgba(0,0,0,0.6);padding:6px 4px;background:transparent" />
                </div>
              </div>
            </div>
          </div>

          <!-- Left column: I and II -->
          <div>
            <div class="grid-section">
              <div class="section-title">I. Presenting Problem</div>
              <textarea id="presentingProblem" name="presentingProblem" class="ruled" rows="8"></textarea>
            </div>

            <div class="grid-section" style="margin-top:10px">
              <div class="section-title">II. Session Summary</div>
              <textarea id="sessionSummary" name="sessionSummary" class="ruled" rows="10"></textarea>
            </div>
          </div>

          <!-- Right column: III, IV/V, VI -->
          <div>
            <div class="grid-section">
              <div class="section-title">III. Observation/s</div>
              <textarea id="observations" name="observations" class="ruled" rows="8"></textarea>
            </div>

            <div class="grid-section" style="margin-top:10px">
              <div class="section-title">IV. Action Taken</div>
              <div class="checkbox-group">
                <label><input type="checkbox" name="actionTaken" value="Consultation"> Consultation</label>
                <label><input type="checkbox" name="actionTaken" value="Coaching"> Coaching</label>
                <label><input type="checkbox" name="actionTaken" value="Counseling"> Counseling</label>
                <label style="display:flex;align-items:center;gap:6px">Others:<input id="actionOthers" name="actionOthers" type="text" placeholder="Specify" style="border:0;border-bottom:1px solid #cfcfcf;padding:4px;background:transparent"></label>
              </div>

              <div style="margin-top:8px">
                <div class="section-title">V. Intervention</div>
                <textarea id="intervention" name="intervention" class="ruled" rows="6"></textarea>
              </div>
            </div>

            <div class="grid-section" style="margin-top:10px">
              <div class="section-title">VI. Recommendation/s</div>
              <div class="checkbox-group" style="margin-bottom:8px">
                <label><input type="checkbox" name="recommendation" value="Follow-up"> Follow-up</label>
                <label><input type="checkbox" name="recommendation" value="Termination"> Termination</label>
                <label><input type="checkbox" name="recommendation" value="Referral"> Referral</label>
              </div>
              <div>
                <label style="display:block;margin-bottom:6px">Remarks</label>
                <textarea id="remarks" name="remarks" class="ruled" rows="4"></textarea>
              </div>
            </div>
          </div>

          <!-- Signatures row spanning two columns -->
          <div class="sign-row">
            <div style="flex:1">
              <label style="font-size:12px;color:#374151">Personnel's Signature over Printed Name</label>
              <input id="personnelName" name="personnelName" type="text" style="width:100%;border:0;border-bottom:1px solid #111;padding:6px;background:transparent" />
            </div>
            <div style="width:160px">
              <label style="font-size:12px;color:#374151">Date</label>
              <input id="personnelDate" name="personnelDate" type="date" style="width:100%;border:0;padding:6px;background:transparent" />
            </div>
            <div style="flex:1">
              <label style="font-size:12px;color:#374151">Noted by (Director)</label>
              <input id="notedBy" name="notedBy" type="text" placeholder="Director" style="width:100%;border:0;border-bottom:1px solid #111;padding:6px;background:transparent" />
            </div>
            <div style="width:160px">
              <label style="font-size:12px;color:#374151">Date</label>
              <input id="notedDate" name="notedDate" type="date" style="width:100%;border:0;padding:6px;background:transparent" />
            </div>
          </div>

          <!-- Actions (span) -->
          <div style="grid-column:1 / -1; display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <div id="modalHelpText" style="font-size:12px;color:#6b7280">You can Save Draft or Submit (final).</div>
            <div style="display:flex;gap:8px">
              <!-- Print button removed -->
              <button type="button" id="saveDraft" style="padding:8px 12px;border-radius:6px;background:#fde68a;border:0;cursor:pointer">Save draft</button>
              <button type="submit" id="submitNote" style="padding:8px 12px;border-radius:6px;background:#2563eb;color:#fff;border:0;cursor:pointer">Submit</button>
            </div>
          </div>

        </div>
      </form>
    </div>
  </div>

    <script>
        // The original script content for sidebar and mobile responsiveness is kept here.
        const menuIcon = document.getElementById('menuIcon');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const sidebarTop = document.getElementById('sidebarTop'); 
        
        // Create overlay for mobile
        const overlay = document.createElement('div');
        overlay.className = 'sidebar-overlay';
        document.body.appendChild(overlay);
        
        // Mobile detection
        function isMobile() {
            return window.innerWidth <= 768;
        }
        
        // Toggle sidebar with mobile responsiveness
        menuIcon.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (isMobile()) {
                // Mobile behavior - overlay sidebar
                const isOpen = sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active', isOpen);
                document.body.style.overflow = isOpen ? 'hidden' : '';
            } else {
                // Desktop behavior - collapse sidebar
                const isCollapsed = sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('shifted', isCollapsed);
                sidebarTop.classList.toggle('collapsed', isCollapsed);
            }
        });
        
        // Close mobile sidebar when clicking overlay
        overlay.addEventListener('click', () => {
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (!isMobile()) {
                // Reset mobile states when switching to desktop
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
                // Ensure desktop state is consistent
                const isCollapsed = sidebar.classList.contains('collapsed');
                mainContent.classList.toggle('shifted', isCollapsed);
                sidebarTop.classList.toggle('collapsed', isCollapsed);
            } else {
                // Reset desktop states when switching to mobile
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('shifted');
                sidebarTop.classList.remove('collapsed');
            }
        });
        
        // Close mobile sidebar when clicking a menu item
        document.querySelectorAll('.nav-item').forEach(link => { 
            link.addEventListener('click', () => {
                if (isMobile()) {
                    sidebar.classList.remove('mobile-open');
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            });
        });
        
        // Initialize state for desktop on load
        document.addEventListener('DOMContentLoaded', () => {
            if (!isMobile()) {
                // Default to uncollapsed on desktop 
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('shifted');
                sidebarTop.classList.remove('collapsed');
            }
        });
        
        // JAVASCRIPT FOR ACCORDION FUNCTIONALITY
        function toggleSection(id) {
            const section = document.getElementById(id);
            const icon = document.getElementById('icon-' + id);
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                section.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }
    </script>
    <script type="module">
        // Note: This module requires the Firebase helpers exported by `admin_main.js`.
        // Assumption: session report records are stored under the RTDB path `session_reports`.
        // If your DB uses a different path (e.g. `sessions`), change the PATH constant below.
        import { requireAdminAuth, setTheme, getTheme, get, ref, db, set, update, fmtTime, enableSearchFilter, auth, onAuthStateChanged, isAdminUid } from './admin_main.js';
        import { loadAdminProfileInto, startGreetingClock } from './admin_profile_loader.js';

        // Local activity helper - writes a short activity entry into localStorage
        function pushLocalActivity(text, icon) {
            try {
                const key = 'admin_recent_activity';
                const raw = localStorage.getItem(key);
                let arr = [];
                try { arr = raw ? JSON.parse(raw) : []; } catch(e){ arr = []; }
                const entry = { text: String(text || ''), ts: (new Date()).toISOString(), icon: icon || '' };
                arr.unshift(entry);
                // keep the list to a reasonable size
                if (arr.length > 80) arr = arr.slice(0,80);
                localStorage.setItem(key, JSON.stringify(arr));
                // expose for other modules/pages
                try { window.pushLocalActivity = pushLocalActivity; } catch(e){}
            } catch (e) { console.error('pushLocalActivity error', e); }
        }
        try { window.pushLocalActivity = pushLocalActivity; } catch(e){}

        // Loading overlay removed — keep no-op helpers so other code can call them safely
        function showLoading(message = '') {
            /* overlay removed; skeleton rows in table show loading state */
        }

        function hideLoading() {
            /* overlay removed; nothing to hide here */
        }

        requireAdminAuth();
        loadAdminProfileInto({ greetingSelector: '#topGreetingName', avatarSelector: '.main-top-bar .user-avatar', timeSelector: '#topGreetingTime' });
        startGreetingClock('#topGreetingName', '#topGreetingTime');

        // Wire theme radios (applies globally via admin_main.js)
        const radios = document.querySelectorAll('.theme-radio');
        if (radios && radios.length) {
            // initialize checked state from stored theme
            try {
                const current = getTheme ? getTheme() : (localStorage.getItem('safespace_theme') || 'system');
                radios.forEach(r => { r.checked = (r.value === (current || 'system')); });
            } catch (e) {
                radios.forEach(r => { r.checked = (r.value === 'system'); });
            }

            radios.forEach(r => r.addEventListener('change', (e) => {
                const val = e.target.value;
                try { if (typeof setTheme === 'function') setTheme(val); else window.setTheme && window.setTheme(val); } catch (err) { console.error('setTheme error', err); }
            }));
        }

                // -------------------------
                // Session Reports data loader
                // -------------------------
                const PATH = 'Session_report'; // <--- change this if your DB uses another path

        function guessField(obj, names) {
            for (const n of names) if (obj[n] !== undefined && obj[n] !== null) return obj[n];
            return '';
        }

        function createRow(rec) {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            const student = guessField(rec, ['student_name','studentName','student','student_fullname','name']);
            // prefer personnel_name/personel_name (counselor display) if present
            const counselor = guessField(rec, ['personel_name','personnel_name','personnelName','counselorName','counselor','counselor_name','counselor_fullname']);
            const rawDate = guessField(rec, ['date','ts','timestamp','created_at','noted_date']);
            const dateText = (typeof rawDate === 'number' || /^[0-9]+$/.test(String(rawDate))) ? fmtTime(Number(rawDate)) : (rawDate ? String(rawDate) : '');
            const sessionNo = guessField(rec, ['session_number','sessionNumber','session_no','session','number']);
            const status = guessField(rec, ['status','state','progress']) || 'Unknown';

            tr.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 h-10 w-10 bg-green-100 rounded-full flex items-center justify-center text-green-800 font-medium">${student ? student.charAt(0) : '?'}</div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">${escapeHtml(student)}</div>
                            <div class="text-sm text-gray-500">${guessField(rec, ['course', 'program', 'department']) || 'Student'}</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${escapeHtml(counselor)}</div>
                    <div class="text-sm text-gray-500">${guessField(rec, ['counselor_role', 'role', 'position']) || 'Counselor'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHtml(dateText)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${escapeHtml(String(sessionNo || ''))}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${status && status.toLowerCase().includes('ongo') ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">${escapeHtml(status)}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                    <button class="text-green-600 hover:text-green-900 mr-3 view-session-btn">View</button>
                    <button class="text-blue-600 hover:text-blue-900 download-session-btn">Download</button>
                </td>
            `;
            tr.dataset.status = (status || '').toLowerCase();
            // attach raw record object for later handlers (modal, saving)
            try { tr.__sessionRec = rec; } catch (e) { /* noop */ }

            // attach click to View button if modal function exists
            try {
                const btn = tr.querySelector('.view-session-btn');
                if (btn) btn.addEventListener('click', (ev) => {
                    ev.preventDefault(); ev.stopPropagation();
                    // prefer attached record
                    const recObj = tr.__sessionRec || rec;
                    if (typeof window.showSessionModal === 'function') { window.showSessionModal(recObj); }
                });
            } catch (e) { console.error(e); }

            // attach click to Download button
            try {
                const downloadBtn = tr.querySelector('.download-session-btn');
                if (downloadBtn) downloadBtn.addEventListener('click', (ev) => {
                    ev.preventDefault(); ev.stopPropagation();
                    const recObj = tr.__sessionRec || rec;
                    downloadSessionReport(recObj);
                });
            } catch (e) { console.error(e); }

            return tr;
        }

        function escapeHtml(s){ if (s === null || s === undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

        function downloadSessionReport(rec) {
            showLoading('Preparing download...');
            // Simulate download preparation
            setTimeout(() => {
                const dataStr = JSON.stringify(rec, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `session_report_${rec.student_name || 'unknown'}_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                try { if (typeof pushLocalActivity === 'function') pushLocalActivity(`Downloaded session report for ${rec.student_name || rec.student || rec.name || 'unknown'}`, '📥'); } catch(e){}
                hideLoading();
            }, 1000);
        }

        async function loadReports() {
            try {
                const tbody = document.querySelector('.main-content table tbody');
                const searchInput = document.querySelector('.main-content input[type="text"]');
                const statusSelect = document.querySelector('.main-content select');
                // summary cards container
                const cardsContainer = document.getElementById('summaryCards');
                if (!tbody) return;

                showLoading('Loading session reports from database...');

                const snap = await get(ref(db, PATH));
                const rows = [];
                if (snap && snap.exists && snap.exists()) {
                    const top = snap.val();
                    // Expected nested shape: studentUid -> recordId -> { meta, sessions: { session_1: {...}, session_2: {...} } }
                    if (top && typeof top === 'object') {
                        for (const studentUid of Object.keys(top)) {
                            const studentNode = top[studentUid];
                            if (!studentNode || typeof studentNode !== 'object') continue;
                            for (const recordId of Object.keys(studentNode)) {
                                const record = studentNode[recordId];
                                if (!record || typeof record !== 'object') continue;
                                // meta fields may be directly on record or under record.meta
                                const meta = (record.meta && typeof record.meta === 'object') ? record.meta : record;
                                const sessions = record.sessions && typeof record.sessions === 'object' ? record.sessions : (record.session && typeof record.session === 'object' ? record.session : {});
                                if (Object.keys(sessions).length === 0) {
                                    // if no sessions, still create single row from meta
                                    const flat = Object.assign({}, meta);
                                    flat._studentUid = studentUid;
                                    flat._recordId = recordId;
                                    flat._sessionKey = record.session_key || record.sessionKey || 'session_1';
                                    rows.push(flat);
                                } else {
                                    for (const sessionKey of Object.keys(sessions)) {
                                        const sess = sessions[sessionKey] || {};
                                        const flat = Object.assign({}, meta, sess);
                                        flat._studentUid = studentUid;
                                        flat._recordId = recordId;
                                        flat._sessionKey = sessionKey;
                                        // try to keep session number
                                        if (!flat.session_number && sess.session_number) flat.session_number = sess.session_number;
                                        rows.push(flat);
                                    }
                                }
                            }
                        }
                    }
                }

                // populate table
                tbody.innerHTML = '';
                let total = 0, ongoing = 0, completed = 0;
                for (const rec of rows) {
                    const status = (guessField(rec, ['status','state','progress']) || '').toString().toLowerCase();
                    total++;
                    if (status.includes('ongo')) ongoing++; else if (status.includes('complete') || status.includes('done')) completed++; else completed++;
                    const tr = createRow(rec);
                    // mark the row with its original sequence index so pagination can compute ranges reliably
                    try { tr.dataset.index = String(total); } catch (e) { /* noop */ }
                    tbody.appendChild(tr);
                }

                console.info('Session reports loaded:', rows.length, 'sessions');

                if (!tbody.children.length) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No session reports found.</td></tr>';
                }

                // Update summary cards if present
                try { 
                    if (cardsContainer) {
                        cardsContainer.innerHTML = `
                            <div class="bg-green-50 border-l-4 border-green-600 p-4 rounded-lg shadow-sm">
                                <h3 class="text-sm text-gray-600">Total Reports</h3>
                                <p class="text-2xl font-bold text-green-700">${total}</p>
                            </div>
                            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg shadow-sm">
                                <h3 class="text-sm text-gray-600">Ongoing</h3>
                                <p class="text-2xl font-bold text-yellow-600">${ongoing}</p>
                            </div>
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg shadow-sm">
                                <h3 class="text-sm text-gray-600">Completed</h3>
                                <p class="text-2xl font-bold text-blue-600">${completed}</p>
                            </div>
                        `;
                    }
                } catch(e){}

                // enable client-side search & status filtering
                try {
                    if (typeof enableSearchFilter === 'function' && searchInput) enableSearchFilter(searchInput, tbody, 5);
                    if (statusSelect) statusSelect.addEventListener('change', function(){ const s = (this.value||'').toLowerCase(); for (const r of Array.from(tbody.rows)) { const st = r.dataset.status||''; r.style.display = (!s || s==='all sessions' || s==='all' || st.includes(s)) ? '' : 'none'; } });
                } catch(e){ console.error('Search wiring error', e); }

                // Update pagination info
                try {
                    const pageInfoEl = document.querySelector('.main-content .bg-white.px-4.py-3 p.text-sm.text-gray-700');
                    if (pageInfoEl) {
                        pageInfoEl.innerHTML = `Showing <span class="font-medium">1</span> to <span class="font-medium">${Math.min(rows.length, 4)}</span> of <span class="font-medium">${rows.length}</span> results`;
                    }
                } catch (e) { console.error('pagination update error', e); }

                // Hide loading after everything is loaded
                setTimeout(hideLoading, 500);

            } catch (err) {
                console.error('loadReports error', err);
                const tbody = document.querySelector('.main-content table tbody'); 
                if (tbody) tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-600">Failed to load reports. Please check your internet connection and try again.</td></tr>';
                hideLoading();
            }
        }

        // Only load reports after auth state is known and the user is verified as admin.
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                try { window.location.href = 'login.html'; } catch(e){}
                return;
            }
            try {
                const ok = await isAdminUid(user.uid);
                if (!ok) {
                    try { await (window.signOutUser ? window.signOutUser() : Promise.resolve()); } catch(e){}
                    window.location.href = 'login.html';
                    return;
                }
                // authorized admin -> load reports
                loadReports();
            } catch (err) {
                console.error('auth check error', err);
                window.location.href = 'login.html';
            }
        });

        // Save session report into Realtime Database.
        window.saveSessionReport = async function(out) {
            if (!out) throw new Error('No data');
            showLoading('Saving session report...');
            
            try {
                const studentUid = out._studentUid || out.studentUid || out.student_id || out.studentUid;
                const recordId = out._recordId || out.recordId || out.record_id || out.recordId;
                let sessionKey = out._sessionKey || out.sessionKey || out.session_key;
                if (!studentUid || !recordId) throw new Error('Missing student or record identifier');
                if (!sessionKey) sessionKey = 'session_' + Date.now();
                const sessionPath = `${PATH}/${studentUid}/${recordId}/sessions/${sessionKey}`;
                const payload = Object.assign({}, out);
                // remove metadata keys from payload
                delete payload._studentUid; delete payload._recordId; delete payload._sessionKey;
                delete payload.studentUid; delete payload.recordId; delete payload.sessionKey;
                payload.updated_at = Date.now();
                // Remove empty values so we only update fields that have data (avoid creating many empty fields)
                for (const k of Object.keys(payload)) {
                    const v = payload[k];
                    if (v === '' || v === null || (Array.isArray(v) && v.length === 0)) {
                        delete payload[k];
                    }
                }
                // write to RTDB using update so existing session nodes are merged (only changed fields applied)
                await update(ref(db, sessionPath), payload);
                hideLoading();
                return { studentUid, recordId, sessionKey };
            } catch (error) {
                hideLoading();
                throw error;
            }
        };

        // Expose modal control functions for the detailed session report modal (#modal).
        (function(){
            const modal = document.getElementById('modal');
            const closeBtn = document.getElementById('closeModal');
            const printBtn = document.getElementById('printReport');
            const saveDraftBtn = document.getElementById('saveDraft');
            const submitBtn = document.getElementById('submitNote');
            let currentRec = null;

            function _close() {
                try { if (modal) modal.style.display = 'none'; document.body.style.overflow = ''; } catch(e){}
                currentRec = null;
                try { document.removeEventListener('keydown', onKey); } catch(e){}
            }
            function onKey(e){ if (e.key === 'Escape') _close(); }

            function toDateInput(val){
                if (!val && val !== 0) return '';
                try {
                    if (typeof val === 'number' || /^[0-9]+$/.test(String(val))) { const d = new Date(Number(val)); if (!isNaN(d)) return d.toISOString().slice(0,10); }
                    const d = new Date(String(val)); if (!isNaN(d)) return d.toISOString().slice(0,10);
                } catch(e){}
                return '';
            }

            function populate(rec){
                currentRec = rec || {};
                try {
                    // Basic header fields
                    const studentEl = document.getElementById('studentName'); if (studentEl) studentEl.value = rec.student_name || rec.student || rec.name || '';
                    const noteDateEl = document.getElementById('noteDate'); if (noteDateEl) noteDateEl.value = toDateInput(rec.date || rec.ts || rec.timestamp || rec.created_at || rec.noted_date || '');
                    const sessionNoEl = document.getElementById('sessionNo'); if (sessionNoEl) sessionNoEl.value = rec.session_number || rec.session_no || rec.session || '';
                    const timeStartedEl = document.getElementById('timeStarted'); if (timeStartedEl) timeStartedEl.value = rec.time_started || rec.start_time || rec.timeStart || '';
                    const timeEndedEl = document.getElementById('timeEnded'); if (timeEndedEl) timeEndedEl.value = rec.time_ended || rec.end_time || rec.timeEnd || '';

                    // Large text areas
                    const pp = document.getElementById('presentingProblem'); if (pp) pp.value = rec.presentingProblem || rec.presenting_problem || rec.presenting || rec.problem || rec.notes || '';
                    const ss = document.getElementById('sessionSummary'); if (ss) ss.value = rec.sessionSummary || rec.summary || rec.report || rec.session_notes || '';
                    const obs = document.getElementById('observations'); if (obs) obs.value = rec.observations || rec.observation || '';
                    const inter = document.getElementById('intervention'); if (inter) inter.value = rec.intervention || '';
                    const remarks = document.getElementById('remarks'); if (remarks) remarks.value = rec.remarks || rec.note || '';

                    // Action Taken (checkboxes)
                    const actionVals = Array.isArray(rec.actionTaken) ? rec.actionTaken : (typeof rec.actionTaken === 'string' ? [rec.actionTaken] : (Array.isArray(rec.action_taken) ? rec.action_taken : (rec.action_taken ? [rec.action_taken] : [])));
                    document.querySelectorAll('input[name="actionTaken"]').forEach(cb => { cb.checked = actionVals.includes(cb.value); });
                    const actionOthersEl = document.getElementById('actionOthers'); if (actionOthersEl) actionOthersEl.value = rec.actionOthers || rec.action_others || rec.action_other || '';

                    // Recommendations (checkboxes)
                    const recVals = Array.isArray(rec.recommendation) ? rec.recommendation : (typeof rec.recommendation === 'string' ? [rec.recommendation] : (Array.isArray(rec.recommendations) ? rec.recommendations : (rec.recommendations ? [rec.recommendations] : [])));
                    document.querySelectorAll('input[name="recommendation"]').forEach(cb => { cb.checked = recVals.includes(cb.value); });

                    // Signatures / personnel
                    const personnelNameEl = document.getElementById('personnelName'); if (personnelNameEl) personnelNameEl.value = rec.personel_name || rec.personnel_name || rec.personnel || '';
                    const personnelDateEl = document.getElementById('personnelDate'); if (personnelDateEl) personnelDateEl.value = toDateInput(rec.personnelDate || rec.personnel_date || rec.personnel_date || '');
                    const notedByEl = document.getElementById('notedBy'); if (notedByEl) notedByEl.value = rec.notedBy || rec.noted_by || rec.director || '';
                    const notedDateEl = document.getElementById('notedDate'); if (notedDateEl) notedDateEl.value = toDateInput(rec.notedDate || rec.noted_date || rec.noted_date || '');
                } catch (e) { console.error('populate modal error', e); }
            }

            // Show session modal. By default opens in view-only mode. Pass { editable: true } as second arg to enable editing.
            window.showSessionModal = function(rec, opts){
                try{
                    const editable = opts && opts.editable === true;
                    populate(rec || {});

                    // Toggle inputs to be readonly/disabled when not editable
                    try {
                        const form = document.getElementById('noteForm');
                        if (form) {
                            const controls = Array.from(form.querySelectorAll('input, textarea, select'));
                            controls.forEach(el => {
                                const tag = el.tagName.toLowerCase();
                                const type = (el.type || '').toLowerCase();
                                if (tag === 'input' && type === 'checkbox') {
                                    el.disabled = !editable;
                                } else if (tag === 'select') {
                                    el.disabled = !editable;
                                } else if (tag === 'input' || tag === 'textarea') {
                                    try { el.readOnly = !editable; } catch(e){}
                                    // also disable when not editable to prevent focus
                                    el.disabled = !editable;
                                }
                            });
                        }
                    } catch (e) { console.error('toggle editable error', e); }

                    // button visibility: show Print always in view; Save/Submit only when editable
                    if (printBtn) printBtn.style.display = 'inline-block';
                    if (saveDraftBtn) saveDraftBtn.style.display = editable ? 'inline-block' : 'none';
                    if (submitBtn) submitBtn.style.display = editable ? 'inline-block' : 'none';

                    if (modal) { modal.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
                    // Viewing a session report is read-only; do not record in Recent Activity to avoid noise.
                    try { document.addEventListener('keydown', onKey); } catch(e){}
                }catch(e){ console.error('showSessionModal error', e); }
            };

            window.closeSessionModal = _close;

            // wire UI handlers
            try {
                if (closeBtn) closeBtn.addEventListener('click', _close);
                if (modal) modal.addEventListener('click', function(e){ if (e.target === modal) _close(); });
                // Print handler removed — printing disabled from UI

                // helper to show messages inside the modal (non-blocking)
                function showModalMessage(msg, type = 'info', autoHide = true) {
                    try {
                        const el = document.getElementById('modalHelpText');
                        if (!el) { console.info(msg); return; }
                        el.textContent = msg;
                        el.style.color = (type === 'error') ? '#b91c1c' : (type === 'success' ? '#065f46' : '#6b7280');
                        if (autoHide) {
                            clearTimeout(window.__modalMsgTimer);
                            window.__modalMsgTimer = setTimeout(() => { try { el.textContent = 'You can Save Draft or Submit (final).'; el.style.color = '#6b7280'; } catch(e){} }, 3500);
                        }
                    } catch (e) { console.error('showModalMessage error', e); }
                }

                if (saveDraftBtn) saveDraftBtn.addEventListener('click', async function(e){
                    e.preventDefault();
                    try {
                        const form = document.getElementById('noteForm');
                        const fd = new FormData(form);
                        // collect into object
                        const out = {};
                        fd.forEach((v,k) => {
                            if (out[k] === undefined) out[k] = v; else if (Array.isArray(out[k])) out[k].push(v); else out[k] = [out[k], v];
                        });
                        // include checked groups explicitly
                        out.actionTaken = Array.from(document.querySelectorAll('input[name="actionTaken"]:checked')).map(i=>i.value);
                        out.recommendation = Array.from(document.querySelectorAll('input[name="recommendation"]:checked')).map(i=>i.value);
                        // include metadata if present
                        if (currentRec && currentRec._studentUid) { out._studentUid = currentRec._studentUid; out._recordId = currentRec._recordId; out._sessionKey = currentRec._sessionKey; }
                        // mark as ongoing (Save Draft should set status to Ongoing)
                        out.status = 'Ongoing';
                        if (typeof window.saveSessionReport === 'function') {
                            try {
                                await window.saveSessionReport(out);
                                showModalMessage('Draft saved to database', 'success');
                                // Saved draft is considered an intermediate/edit action; do not record in Recent Activity.
                            } catch (err) {
                                console.error('save draft db error', err);
                                showModalMessage('Failed to save draft to database: '+String(err), 'error');
                            }
                        } else {
                            // fallback to download if DB helper missing
                            const blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `session_draft_${Date.now()}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                            showModalMessage('Draft downloaded (offline)', 'info');
                        }
                    } catch (e) { console.error('save draft error', e); }
                });

                if (submitBtn) submitBtn.addEventListener('click', function(e){
                    e.preventDefault();
                    try {
                        const form = document.getElementById('noteForm');
                        const fd = new FormData(form);
                        const out = {};
                        fd.forEach((v,k) => {
                            if (out[k] === undefined) out[k] = v; else if (Array.isArray(out[k])) out[k].push(v); else out[k] = [out[k], v];
                        });
                        out.actionTaken = Array.from(document.querySelectorAll('input[name="actionTaken"]:checked')).map(i=>i.value);
                        out.recommendation = Array.from(document.querySelectorAll('input[name="recommendation"]:checked')).map(i=>i.value);
                        if (currentRec && currentRec._studentUid) { out._studentUid = currentRec._studentUid; out._recordId = currentRec._recordId; out._sessionKey = currentRec._sessionKey; }
                        // Try to save using a global helper (if available), otherwise download JSON as a fallback
                        if (typeof window.saveSessionReport === 'function') {
                            window.saveSessionReport(out).then(()=>{ try { showModalMessage('Session saved', 'success'); setTimeout(_close, 800); } catch(e){} }).catch(err=>{ showModalMessage('Failed to save: '+String(err), 'error'); });
                        } else {
                            const blob = new Blob([JSON.stringify(out, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `session_submit_${Date.now()}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
                            showModalMessage('Session downloaded (offline)', 'info');
                        }
                    } catch (e) { console.error('submit error', e); }
                });
            } catch (e) { console.error('session modal wiring error', e); }
        })();

    </script>
    <script src="./profile_dropdown.js"></script>
    <script>
        (function(){
            if (window.__sidebarLogoutHandlerAdded) return; window.__sidebarLogoutHandlerAdded = true;
            function attachLogout(){
                const sidebarLogout = document.getElementById('sidebarLogoutBtn');
                if (!sidebarLogout) return;
                sidebarLogout.addEventListener('click', () => {
                    const profileLogout = document.getElementById('accountLogout');
                    if (profileLogout) { profileLogout.click(); return; }
                    if (typeof window.signOutAndRedirect === 'function') { window.signOutAndRedirect(); return; }
                    try { localStorage.removeItem('authToken'); } catch(e){}
                    window.location.href = 'login.html';
                });
            }
            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attachLogout); else attachLogout();
        })();
    </script>
    <script>
    (function(){
        function attachLogout(){
            const sidebarLogout = document.getElementById('sidebarLogoutBtn');
            if (!sidebarLogout) return;
            if (sidebarLogout._logoutHandlerAttached) return;
            sidebarLogout._logoutHandlerAttached = true;
            const confirmModal = document.getElementById('confirmModalLogout');
            const confirmOk = document.getElementById('confirmModalLogoutOk');
            const confirmCancel = document.getElementById('confirmModalLogoutCancel');
            function doLogout(){
                const profileLogout = document.getElementById('accountLogout');
                if (profileLogout) { profileLogout.click(); return; }
                if (typeof window.signOutAndRedirect === 'function') { window.signOutAndRedirect(); return; }
                try { localStorage.removeItem('authToken'); } catch(e){}
                window.location.href = 'login.html';
            }
            sidebarLogout.addEventListener('click', () => {
                if (!confirmModal || !confirmOk || !confirmCancel) { if (confirm('Are you sure you want to sign out?')) doLogout(); return; }
                confirmModal.style.display = 'flex';
                function cleanup(){ confirmModal.style.display = 'none'; confirmOk.removeEventListener('click', onOk); confirmCancel.removeEventListener('click', onCancel); document.removeEventListener('keydown', onKeyDown); }
                function onOk(){ cleanup(); doLogout(); }
                function onCancel(){ cleanup(); }
                function onKeyDown(e){ if (e.key === 'Escape') cleanup(); }
                confirmOk.addEventListener('click', onOk);
                confirmCancel.addEventListener('click', onCancel);
                document.addEventListener('keydown', onKeyDown);
            });
        }
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attachLogout); else attachLogout();
    })();
    </script>
</body>
</html>