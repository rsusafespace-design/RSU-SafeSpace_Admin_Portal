<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - Appointment Monitoring</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
    <style>
        /* BASE STYLES */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #f4f7fa;
            color: #333;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* HEADER & TOP BAR STYLES */
        .header-and-sidebar-top {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1400;
            display: flex;
            background-color: #1e8e3e;
            color: white;
            height: 60px;
            transition: left 0.3s ease;
        }
        
        .sidebar-top {
            width: 250px;
            display: flex;
            align-items: center;
            padding: 10px 20px;
            box-sizing: border-box;
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            height: 60px;
            transition: width 0.3s ease;
        }
        
        .sidebar-top.collapsed {
            width: 80px;
            justify-content: center;
        }
        
        .sidebar-top.collapsed .sidebar-logo {
            opacity: 0;
            pointer-events: none;
            width: 0;
        }
        
        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            transition: opacity 0.3s ease, width 0.3s ease;
        }

        .sidebar-logo img {
            height: 40px;
        }
        
        .sidebar-logo span {
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
            white-space: nowrap;
        }
        
        .menu-icon {
            cursor: pointer;
            font-size: 24px;
            margin-left: auto;
            transition: all 0.3s ease;
            padding: 8px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            min-height: 40px;
        }
        
        .menu-icon:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        
        .menu-icon:active {
            transform: scale(0.95);
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .main-top-bar {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 30px; 
        }

        .main-top-bar .portal-title {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }

        .main-top-bar .user-info {
            display: flex;
            align-items: center;
            color: white;
        }

        .main-top-bar .user-info .material-icons {
            margin-right: 10px;
            font-size: 24px;
        }

        .main-top-bar .user-avatar {
            width: 40px;
            height: 40px;
            background-color: white;
            color: #1e8e3e; 
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            margin-left: 10px;
            font-size: 18px;
        }

        /* SIDEBAR STYLES */
        .sidebar {
            width: 250px;
            background: #f0f3f6;
            border-right: 1px solid rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 60px;
            left: 0;
            height: calc(100vh - 60px);
            z-index: 999;
            overflow: auto;
            transition: width 0.3s ease, transform 0.3s ease;
        }
        
        .nav-menu ul {
            list-style: none;
            padding: 12px;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .nav-item {
            color: #1f2937;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 10px;
            border-radius: 8px;
            border: 0;
            background: transparent;
            cursor: pointer;
            font-weight: 400;
            font-size: 15px;
            transition: background 0.2s, color 0.2s;
            text-align: left;
            width: 100%;
        }
    
        .nav-item:hover {
            background: rgba(15,122,52,0.08) !important;
            color: #0f7a34 !important;
            font-weight: 400 !important;
            border-radius: 8px !important;
        }
        
        .nav-item.active {
            background: rgba(15,122,52,0.12) !important;
            color: #0f7a34 !important;
            font-weight: 600 !important;
        }
        
        .nav-item:hover .icon,
        .nav-item.active .icon {
            color: #1f2937 !important;
        }

        .nav-item .icon {
            width: 28px;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            line-height: 1;
            color: #1f2937;
            transition: color 0.2s;
        }
        
        .nav-item .label {
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            opacity: 1;
            transition: opacity 0.2s, transform 0.2s;
        }

        .sidebar.collapsed {
            width: 80px;
        }
        
        .sidebar.collapsed .nav-item .label {
            display: none;
        }
        
        .sidebar.collapsed .nav-item .icon {
            width: 56px;
            font-size: 26px;
            justify-content: center;
        }
        
        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 12px 6px;
            gap: 0;
        }
        
        .sidebar-footer {
            margin-top: auto;
            padding: 12px;
        }
        
        .sidebar-footer .nav-item { 
            display:flex; 
            align-items:center; 
            gap:12px; 
            padding:10px; 
            border-radius:8px; 
        }
        
        .sidebar-footer .nav-item .label { 
            transition: opacity 0.15s ease; 
        }
        
        .sidebar.collapsed .sidebar-footer .nav-item .label { 
            display:none; 
        }

        .menu-icon { 
            z-index: 1500; 
            position: relative; 
            pointer-events: auto; 
        }
        
        /* Mobile sidebar overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 998;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
                box-shadow: 4px 0 15px rgba(0, 0, 0, 0.2);
                transition: transform 0.3s ease;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .sidebar.collapsed {
                width: 280px;
                transform: translateX(-100%);
            }
            
            .main-content {
                left: 0 !important;
                padding: 20px 15px;
            }
        }
        
        /* MAIN CONTENT STYLES */
        .main-content {
            position: fixed;
            top: 60px;
            left: 250px;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            overflow: auto;
            padding: 30px;
            transition: left 0.3s ease;
            min-height: auto;
            background: transparent;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.8s cubic-bezier(0.4,0,0.2,1), transform 0.8s cubic-bezier(0.4,0,0.2,1);
        }

        .main-content.fade-in {
            opacity: 1;
            transform: translateY(0);
        }

        .main-content.shifted {
            left: 80px;
        }
        
        .dashboard-content-wrapper {
            padding: 0;
            flex-grow: 1;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background-color: white;
            border-radius: 8px;
            padding: 18px 20px 18px 30px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: visible;
            transition: transform 0.22s cubic-bezier(0.4,0,0.2,1), box-shadow 0.22s cubic-bezier(0.4,0,0.2,1);
            will-change: transform, box-shadow;
            cursor: pointer;
        }
        
        .summary-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
            background: transparent;
        }
        
        .summary-cards .summary-card:nth-child(1)::before { background: #10b981; }
        .summary-cards .summary-card:nth-child(2)::before { background: #3b82f6; }
        .summary-cards .summary-card:nth-child(3)::before { background: #f59e0b; }
        .summary-cards .summary-card:nth-child(4)::before { background: #ef4444; }
        
        .summary-cards .summary-card:nth-child(1) .change { color: #10b981; }
        .summary-cards .summary-card:nth-child(2) .change { color: #3b82f6; }
        .summary-cards .summary-card:nth-child(3) .change { color: #b7791f; }
        .summary-cards .summary-card:nth-child(4) .change { color: #ef4444; }
        
        .summary-card h4 {
            font-size: 14px;
            color: #4a5568;
            margin: 0 0 5px 0;
        }
        
        .summary-card .number {
            font-size: 28px;
            font-weight: bold;
            color: #2d3748;
            margin: 0 0 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* inline spinner that appears where the number would be while loading */
        .summary-card .number .inline-spinner {
            width: 18px;
            height: 18px;
            display: inline-block;
            vertical-align: middle;
            opacity: 1;
        }
        .summary-card .number .inline-spinner svg { width:100%; height:100%; }

        /* per-card spinner removed - spinner markup and styles deleted */
        
        .summary-card .change {
            font-size: 12px;
            color: #718096;
        }
        
        .change.up {
            color: #48bb78;
        }
        
        .change.down {
            color: #f56565;
        }
        
        .summary-card .material-icons {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            color: #a0aec0;
        }
        
        .summary-card.completed .material-icons {
            color: #48bb78;
        }
        
        .summary-card.pending .material-icons {
            color: #f6ad55;
        }
        
        .summary-card.new-patients .material-icons {
            color: #9f7aea;
        }
        
        .summary-card.total .material-icons {
            color: #4299e1;
        }
        
        .summary-card.pop-forward {
            transform: translateY(-12px) scale(1.06);
            box-shadow: 0 8px 32px rgba(16, 185, 129, 0.13), 0 1.5px 6px rgba(0,0,0,0.07);
            z-index: 2;
        }

        /* College Breakdown Styles */
        .college-breakdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            margin-top: 10px;
            padding: 15px;
            z-index: 10;
            border: 1px solid #e2e8f0;
        }

        .summary-card.expanded .college-breakdown {
            display: block;
        }

        .college-breakdown h5 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #4a5568;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 8px;
        }

        .college-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .college-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f7fafc;
        }

        .college-item:last-child {
            border-bottom: none;
        }

        .college-name {
            font-size: 13px;
            color: #4a5568;
        }

        .college-count {
            font-size: 13px;
            font-weight: bold;
            color: #3b82f6;
            background: #eff6ff;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .view-more {
            text-align: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
        }

        .view-more-btn {
            background: none;
            border: none;
            color: #3b82f6;
            font-size: 12px;
            cursor: pointer;
            text-decoration: underline;
        }

        .view-more-btn:hover {
            color: #2563eb;
        }

        @media (max-width: 900px) {
            .summary-cards { 
                grid-template-columns: repeat(2, 1fr); 
            }
        }
        
        @media (max-width: 480px) {
            .summary-cards { 
                grid-template-columns: 1fr; 
            }
        }

        /* Chart Section - FIXED */
        .chart-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
            margin-bottom: 30px;
        }
        
        .monthly-trends,
        .weekly-trends {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.8s cubic-bezier(0.4,0,0.2,1), transform 0.8s cubic-bezier(0.4,0,0.2,1);
        }
        
        .monthly-trends.fade-in, 
        .weekly-trends.fade-in {
            opacity: 1;
            transform: translateY(0);
        }
        
        .monthly-trends h3,
        .weekly-trends h3 {
            font-size: 18px;
            margin-top: 0;
            color: #4a5568;
        }
        
        .small-icon {
            font-size: 16px;
            vertical-align: middle;
            margin-right: 8px;
            display: inline-block;
            transform: translateY(-1px);
        }
        
        /* CHART CONTAINER FIXES */
        .chart-container {
            height: 250px;
            padding-top: 10px;
            position: relative;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* Responsive chart fixes */
        @media (max-width: 768px) {
            .chart-section {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 220px;
            }
        }

        /* Bottom Section */
        .bottom-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        
        .todays-appointments,
        .recent-activity {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .todays-appointments h3,
        .recent-activity h3 {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            color: #4a5568;
            margin-top: 0;
        }
        
        .todays-appointments .view-all,
        .recent-activity .view-all {
            font-size: 14px;
            color: #fff;
            background: #4f46e5;
            border: none;
            border-radius: 6px;
            padding: 6px 16px;
            text-decoration: none;
            font-weight: 600;
            margin-left: 10px;
            transition: background 0.18s, color 0.18s;
            cursor: pointer;
            display: inline-block;
        }
        
        .recent-activity .view-all:hover,
        .recent-activity .view-all:focus {
            background: #3730a3;
            color: #fff;
            text-decoration: none;
        }
        
        .appointment-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .appointment-list li {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .activity-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* Limit Recent System Activity height and enable vertical scrolling
           Apply to both server-rendered and local-rendered lists so client
           entries also get a scrollbar and consistent height. */
        .recent-activity .activity-list,
        .recent-activity .local-activity-list,
        .recent-activity #activityList,
        .recent-activity #activityListLocal {
            max-height: 320px; /* increased height to show more items */
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 8px; /* avoid content being obscured by scrollbar */
        }

        /* Optional: subtle custom scrollbar for WebKit browsers (applies to both lists) */
        .recent-activity .activity-list::-webkit-scrollbar,
        .recent-activity .local-activity-list::-webkit-scrollbar,
        .recent-activity #activityList::-webkit-scrollbar,
        .recent-activity #activityListLocal::-webkit-scrollbar { width: 10px; }
        .recent-activity .activity-list::-webkit-scrollbar-track,
        .recent-activity .local-activity-list::-webkit-scrollbar-track,
        .recent-activity #activityList::-webkit-scrollbar-track,
        .recent-activity #activityListLocal::-webkit-scrollbar-track { background: transparent; }
        .recent-activity .activity-list::-webkit-scrollbar-thumb,
        .recent-activity .local-activity-list::-webkit-scrollbar-thumb,
        .recent-activity #activityList::-webkit-scrollbar-thumb,
        .recent-activity #activityListLocal::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.10); border-radius: 8px; }
        
        .activity-list li {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            background: #ffffff;
            box-shadow: 0 1px 2px rgba(0,0,0,0.06);
        }
        
        .activity-icon {
            font-size: 16px;
            width: 40px;
            height: 40px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: #f3f4f6;
            color: #374151;
            font-weight:700;
            flex: 0 0 40px;
        }

        .activity-icon.green { background:#10b981; color:#ffffff; }
        .activity-icon.blue { background:#0590ff; color:#ffffff; }
        .activity-subtitle { font-size:13px; color:#6b7280; font-weight:400; margin-top:4px; }
        
        .activity-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
        }
        
        .activity-text {
            color: #111827;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .activity-time {
            color: #6b7280;
            font-size: 13px;
            margin-top: 4px;
        }

        /* Recent System Activity - refined styles to match design */
        .recent-activity h3 { display:flex; align-items:center; justify-content:space-between; gap:12px; margin:0 0 12px 0; font-size:16px; color:#111827; }
        .recent-activity .view-all { background:#6d28d9; color:#fff; padding:6px 12px; border-radius:8px; font-size:13px; text-decoration:none; display:inline-block; }
        .recent-activity .view-all:hover { background:#5b21b6; }

        .recent-activity .activity-list,
        .recent-activity .local-activity-list,
        .recent-activity #activityList,
        .recent-activity #activityListLocal {
            list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:10px;
            max-height:320px; overflow-y:auto; overflow-x:hidden; padding-right:8px;
        }

        .recent-activity .activity-list li,
        .recent-activity .local-activity-list li,
        .recent-activity .recent-activity-item {
            display:flex; align-items:flex-start; gap:12px; padding:12px; border-radius:8px; background:#fff;
            box-shadow: 0 1px 2px rgba(2,6,23,0.04); border: 1px solid #f1f5f9;
        }

        .recent-activity .recent-activity-item > div:first-child,
        .recent-activity .activity-list li .activity-icon {
            width:40px; height:40px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:700; flex:0 0 40px;
        }

        .recent-activity .recent-activity-item > div:nth-child(2),
        .recent-activity .activity-content {
            flex:1; min-width:0; display:flex; flex-direction:column;
        }

        .recent-activity .activity-text,
        .recent-activity .recent-activity-item div[style*="font-weight:600"] {
            font-weight:700; color:#111827; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
        }

        .recent-activity .activity-subtitle,
        .recent-activity .recent-activity-item div[style*="color:var(--ss-muted)"] {
            color:#6b7280; font-size:13px; margin-top:4px; font-weight:400; white-space:normal;
        }

        .recent-activity .time-info { text-align:right; flex-shrink:0; display:flex; flex-direction:column; gap:4px; }
        .recent-activity .time { font-weight:600; color:#374151; font-size:13px; }
        .recent-activity .role { font-size:13px; color:#6b7280; }

        .recent-activity .activity-list li + li,
        .recent-activity .recent-activity-item + .recent-activity-item {
            border-top: 1px solid #eef2f7;
        }
        
        .name-info .name {
            font-weight: bold;
            color: #2d3748;
        }
        
        .name-info .topic {
            font-size: 14px;
            color: #718096;
        }
        
        .time-info {
            text-align: right;
        }
        
        .time-info .time {
            font-weight: bold;
            color: #2d3748;
        }
        
        .time-info .role {
            font-size: 14px;
            color: #4f46e5;
        }
        
        /* Quick Actions */
        .quick-actions {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .quick-actions h3 {
            font-size: 18px;
            color: #4a5568;
            margin-top: 0;
            margin-bottom: 20px;
        }
        
        .quick-actions .action-btn {
            padding: 12px;
            border: none;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            font-size: 16px;
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
            width: 100%;
            box-sizing: border-box;
            transition: transform 220ms cubic-bezier(.2,.9,.35,1), box-shadow 220ms ease, background-color 160ms ease, opacity 220ms ease;
            transform-origin: center;
            opacity: 0;
            animation: qaFadeIn 380ms ease forwards;
            padding-left: 48px;
        }
        
        .quick-actions .action-btn .material-icons {
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            line-height: 1;
        }

        @keyframes qaFadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .quick-actions .action-btn:nth-of-type(1) { 
            animation-delay: 0.06s; 
        }
        
        .quick-actions .action-btn:nth-of-type(2) { 
            animation-delay: 0.12s; 
        }
        
        .quick-actions .action-btn:nth-of-type(3) { 
            animation-delay: 0.18s; 
        }
        
        .quick-actions .action-btn:nth-of-type(4) { 
            animation-delay: 0.24s; 
        }

        .quick-actions .action-btn:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: 0 10px 22px rgba(2,6,23,0.10);
        }
        
        .quick-actions .action-btn:active {
            transform: translateY(-1px) scale(0.995);
            box-shadow: 0 6px 14px rgba(2,6,23,0.08);
        }
        
        .quick-actions .action-btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 4px rgba(79,70,229,0.12);
        }

        /* Quick Action Button Colors */
        .quick-actions .action-btn.add-counselor {
            background-color: #10b981;
        }
        
        .quick-actions .action-btn.manage-student {
            background-color: #4f46e5;
        }
        
        .quick-actions .action-btn.settings {
            background-color: #e83e8c;
        }
        
        .quick-actions .action-btn.view-profile {
            background-color: #616366;
        }
        
        .quick-actions .action-btn.add-counselor:hover,
        .quick-actions .action-btn.add-counselor:focus {
            background-color: #0ea56f;
            box-shadow: 0 18px 42px rgba(16,185,129,0.14);
            transform: translateY(-6px) scale(1.02);
        }

        .quick-actions .action-btn.manage-student:hover,
        .quick-actions .action-btn.manage-student:focus {
            background-color: #3730a3;
            box-shadow: 0 18px 42px rgba(79,70,229,0.12);
            transform: translateY(-6px) scale(1.02);
        }

        .quick-actions .action-btn.settings:hover,
        .quick-actions .action-btn.settings:focus {
            background-color: #c92b74;
            box-shadow: 0 18px 42px rgba(232,62,140,0.12);
            transform: translateY(-6px) scale(1.02);
        }

        .quick-actions .action-btn.view-profile:hover,
        .quick-actions .action-btn.view-profile:focus {
            background-color: #4a4a4d;
            box-shadow: 0 18px 42px rgba(0,0,0,0.12);
            transform: translateY(-6px) scale(1.02);
        }
        
        /* Arrow indicator */
        .quick-actions .qa-arrow {
            position: absolute;
            left: 18px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 12px solid #1e8e3e;
            transition: top 260ms cubic-bezier(.2,.9,.35,1), opacity 180ms ease, transform 180ms ease;
            opacity: 0;
            pointer-events: none;
            transform-origin: center;
        }
        
        .profile-greeting { 
            font-weight:700; 
            font-size:18px; 
            margin-top:4px; 
            color:#111827; 
        }
        
        .manage-btn { 
            display:inline-block; 
            width:100%; 
            padding:10px 12px; 
            border-radius:999px; 
            border:1px solid rgba(16,185,129,0.12); 
            background:#10b981; 
            color:#fff; 
            font-weight:700; 
            box-shadow:none; 
            cursor:pointer; 
        }
        
        .manage-btn:hover { 
            transform:none; 
            filter:brightness(.98); 
        }
        
        .profile-divider { 
            height:1px; 
            background:#f1f5f9; 
            margin:8px 0; 
        }
        
        .profile-actions { 
            display:flex; 
            justify-content:space-between; 
            gap:12px; 
            align-items:center; 
        }
        
        .profile-link { 
            flex:1; 
            text-align:left; 
            border:0; 
            background:transparent; 
            padding:8px; 
            color:#374151; 
            font-weight:600; 
            cursor:pointer; 
        }
        
        .signout-link { 
            flex:1; 
            text-align:right; 
            border:0; 
            background:transparent; 
            padding:8px; 
            color:#ef4444; 
            font-weight:700; 
            cursor:pointer; 
        }
        
        @media (max-width:420px) { 
            .profile-dropdown { 
                right:8px !important; 
                left:8px !important; 
                min-width:auto; 
            } 
        }
        
        .profile-dropdown[aria-hidden="false"] .profile-card { 
            transform: translateY(-6px); 
            box-shadow: 0 20px 54px rgba(2,6,23,0.16), 0 6px 18px rgba(2,6,23,0.06); 
        }

        .icon-btn { 
            background: transparent !important; 
            border: 0 !important; 
            outline: none !important; 
            box-shadow: none !important; 
            padding: 6px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            cursor: pointer; 
        }
        
        .icon-btn:focus { 
            outline: 2px solid rgba(255,255,255,0.18); 
        }

        /* popover / dropdown visibility */
        .popover { 
            display: none; 
        }
        
        .popover[data-open="true"] { 
            display: block; 
        }
        
        .dropdown { 
            display: none; 
        }
        
        .dropdown[aria-hidden="false"] { 
            display: block; 
        }

        @keyframes fadeIn { 
            from { 
                opacity: 0; 
                transform: translateY(-10px); 
            } 
            to { 
                opacity: 1; 
                transform: translateY(0); 
            } 
        }
        
        /* Logout button styling */
        #sidebarLogoutBtn { 
            cursor: pointer; 
        }
        
        #sidebarLogoutBtn .label, 
        #sidebarLogoutBtn .icon {
            color: inherit;
            transition: color 160ms ease-in-out, transform 120ms ease;
        }
        
        #sidebarLogoutBtn:hover .label,
        #sidebarLogoutBtn:hover .icon {
            color: #ef4444 !important;
        }
        
        #sidebarLogoutBtn:focus-visible .label,
        #sidebarLogoutBtn:focus-visible .icon {
            color: #ef4444 !important;
        }
        
        #profileDropdown { 
            display: none; 
        }
        
        #profileDropdown[aria-hidden="false"] { 
            display: block; 
        }

        /* Confirm Modal */
        #confirmModalLogout {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(2,6,23,0.45);
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        /* Dropdown large avatar: show whole image and zoom on hover */
        #profileAvatar {
            width: 80px;
            height: 80px;
            border-radius: 60px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            color: #111;
            font-weight: 700;
            font-size: 18px;
            transition: box-shadow 160ms ease, transform 180ms ease;
        }

        #profileAvatar img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* show the whole picture without cropping */
            display: block;
            transition: transform 260ms cubic-bezier(.2,.9,.35,1);
        }

        #profileAvatar:hover img,
        #profileAvatar:focus img {
            transform: scale(1.08);
        }

        #profileAvatar:focus {
            outline: 2px solid rgba(16,185,129,0.08);
        }
        /* Notification card (matches provided screenshot) */
        .notif-card {
            min-width: 280px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 12px 30px rgba(2,6,23,0.08);
            font-family: Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            background: #fff;
        }

        .notif-card .notif-header {
            background: #10b981; /* green header */
            color: #fff;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .notif-card .notif-title { font-weight: 700; font-size: 15px; }

        .notif-card .notif-timestamp { font-size: 12px; opacity: 0.95; }

        .notif-card .notif-body { padding: 14px 16px; color: #111827; }

        .notif-card .notif-status { font-weight: 700; color: #111827; margin-bottom: 6px; }

        .notif-card .notif-sub { font-size: 13px; color: #6b7280; margin-bottom: 6px; }

        .notif-card .notif-footer { padding: 10px 0 14px 0; text-align: center; background: #fff; }

        .notif-card .mark-all { color: #10b981; font-weight: 700; cursor: pointer; text-decoration: none; }
    </style>
</head>
<body>
    <div class="header-and-sidebar-top">
        <aside class="sidebar-top" id="sidebarTop">
            <div class="sidebar-logo">
                <img src="safespace.png" alt="SafeSpace Logo">
                <span>SafeSpace</span>
            </div>
            <i class="material-icons menu-icon" id="menuIcon">menu</i>
        </aside>
        <header class="main-top-bar">
            <h1 class="portal-title">Admin Portal</h1>
            <div class="user-info">
                <div class="top-greeting" aria-live="polite" style="margin-right:12px; text-align:right; color:#fff; margin-left:8px;">
                    <div id="topGreetingName" style="font-weight:700; font-size:14px;">Good Morning, Admin</div>
                    <div id="topGreetingTime" style="font-size:12px; opacity:0.95; margin-top:2px;">Tuesday, Oct 14, 2025 â€” 02:51 AM</div>
                </div>
                <div style="position:relative;display:inline-block;">
                    <button id="notifBtn" class="icon-btn" aria-expanded="false" title="Notifications" style="color:white;padding:8px;border:none;border:0;display:inline-flex;align-items:center;justify-content:center;box-shadow:none;">
                        <i class="material-icons" style="color:white;font-size:20px;border:none;outline:none;background:transparent;">notifications</i>
                    </button>
                    <!-- demoNotifBtn removed -->
                    <div id="notifPanel" class="popover" data-open="false" style="position:fixed;right:20px;top:62px;min-width:280px;z-index:4500;display:none;">
                        <div class="notif-card" role="dialog" aria-label="Notifications" aria-hidden="true">
                            <div class="notif-header" style="background:#10b981;color:#fff;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;border-radius:6px 6px 0 0;">
                                <div style="font-weight:700;font-size:15px;">Notifications</div>
                                <div class="notif-controls" style="display:inline-flex;gap:8px;align-items:center;">
                                    <button id="dashboardMarkAll" type="button" style="background:transparent;border:0;color:#2563eb;cursor:pointer;font-size:13px;padding:4px 6px;border-radius:6px">Mark all read</button>
                                    <button id="dashboardClearAll" type="button" style="background:transparent;border:0;color:#ef4444;cursor:pointer;font-size:13px;padding:4px 6px;border-radius:6px">Clear</button>
                                </div>
                            </div>
                            <div id="notifList" class="popover-body" style="color:#111827; padding:8px 12px;">
                                <div class="popover-empty">No new notifications.</div>
                            </div>
                        </div>
                    </div>
                        </div>
                <div style="position:relative;display:inline-block;margin-left:-8px;">
                    <button id="profileBtn" class="user-avatar" aria-haspopup="true" aria-expanded="false" title="Profile" style="border:0;cursor:pointer;padding:0;position:relative;overflow:hidden;">
                        <div id="profileBtnSpinner" style="position:absolute;inset:0;display:none;align-items:center;justify-content:center;pointer-events:none">
                            <svg width="28" height="28" viewBox="0 0 50 50" aria-hidden="true">
                                <circle cx="25" cy="25" r="18" fill="#ffffff" opacity="0.2"></circle>
                                <path fill="#10B981" d="M25 5a20 20 0 0 1 0 6a14 14 0 1 0 0 28 14 14 0 0 1 0-34">
                                    <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite" />
                                </path>
                            </svg>
                        </div>
                        <div id="profileBtnDefaultIcon" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none">
                            <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 12c2.761 0 5-2.239 5-5s-2.239-5-5-5-5 2.239-5 5 2.239 5 5 5z" fill="#9CA3AF"></path>
                                <path d="M3 20c0-2.761 4.477-5 9-5s9 2.239 9 5v1H3v-1z" fill="#9CA3AF"></path>
                            </svg>
                        </div>
                    </button>
                    <div id="profileDropdown" class="dropdown profile-dropdown" aria-hidden="true" style="position:fixed;right:20px;top:62px;min-width:320px;z-index:3000;">
                        <div style="background:#fff;border-radius:12px;padding:10px;min-width:320px;box-shadow:0 12px 30px rgba(2,6,23,0.12);font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111;">
                            <div style="display:flex;gap:12px;align-items:center;padding:10px;border-bottom:1px solid rgba(0,0,0,0.06)">
                                <div class="avatar-large" id="profileAvatar" style="width:80px;height:80px;border-radius:60px;overflow:hidden;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-weight:700;color:#111;font-size:18px">
                                    <!-- profile image or initial inserted by script -->
                                </div>
                                <div style="flex:1;min-width:0">
                                    <div id="profileGreeting" style="font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">Hi, Admin</div>
                                    <div id="profileEmail" style="font-size:13px;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">you@example.com</div>
                                </div>
                            </div>
                            <div style="padding:8px 6px;display:flex;flex-direction:column;gap:6px">
                                <button id="accountEdit" class="profile-item" style="text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;cursor:pointer;display:flex;align-items:center;gap:10px">
                                    <i class="material-icons icon" style="font-size:18px;line-height:1;">person</i>
                                    <span style="flex:1;text-align:left">Manage your profile</span>
                                </button>
                                <button id="accountSettings" class="profile-item" style="text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;cursor:pointer;display:flex;align-items:center;gap:10px">
                                    <i class="material-icons icon" style="font-size:18px;line-height:1;">settings</i>
                                    <span style="flex:1;text-align:left">Settings & privacy</span>
                                    <i class="material-icons icon" style="font-size:16px;opacity:0.7;">chevron_right</i>
                                </button>
                                <button id="accountLogout" class="profile-item" style="text-align:left;padding:10px;border-radius:8px;border:0;background:transparent;cursor:pointer;display:flex;align-items:center;gap:10px;color:#111;font-weight:600">
                                    <i class="material-icons icon" style="font-size:18px;line-height:1;color:#ef4444">logout</i>
                                    <span style="flex:1;text-align:left">Log Out</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </div>

    <!-- notificationDropdown removed: using structured #notifPanel popover instead -->
    
    <div class="container">
        <aside class="sidebar" id="sidebar">
            <nav class="nav-menu">
                <nav class="nav" id="nav" style="display:flex;flex-direction:column;gap:8px;padding:12px;">
                    <button class="nav-item active" onclick="location.href='admin_dashboard.html'" data-name="Dashboard">
                        <span class="material-icons icon" style="font-size:26px;">dashboard</span>
                        <span class="label" style="font-size:15px;">Home</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_user_management.html'" data-name="User Management">
                        <span class="material-icons icon" style="font-size:26px;">groups</span>
                        <span class="label" style="font-size:15px;">Student Management</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_counselor_management.html'" data-name="Counselor Management">
                        <span class="material-icons icon" style="font-size:26px;">psychology</span>
                        <span class="label" style="font-size:15px;">Counselor Management</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_content_management.html'" data-name="Content Management">
                        <span class="material-icons icon" style="font-size:26px;">description</span>
                        <span class="label" style="font-size:15px;">Content Management</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_report_management.html'" data-name="Reports Management">
                        <span class="material-icons icon" style="font-size:26px;">warning</span>
                        <span class="label">Reports Management</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_session_report.html'" data-name="Session Reports">
                        <span class="material-icons icon" style="font-size:26px;">fact_check</span>
                        <span class="label">Session Reports</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_psych_test.html'" data-name="Session Reports">
                        <span class="material-icons icon" style="font-size:26px;">assessment</span>
                        <span class="label">Psychological Test</span>
                    </button>
                    <button class="nav-item" onclick="location.href='admin_settings.html'" data-name="System Settings">
                        <span class="material-icons icon" style="font-size:26px;">settings</span>
                        <span class="label" style="font-size:15px;">System Settings</span>
                    </button>
                </nav>
            </nav>
            <div class="sidebar-footer">
                <button class="nav-item" id="sidebarLogoutBtn" type="button" title="Sign out">
                    <i class="material-icons icon" style="font-size:26px;">logout</i>
                    <span class="label" style="font-size:15px;">Logout</span>
                </button>
            </div>
        </aside>

        <script>
        // Wire dashboard notification header controls to global helpers
        (function(){
            function onReady(fn){ if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn); else fn(); }
            onReady(function(){
                const markBtn = document.getElementById('dashboardMarkAll');
                const clearBtn = document.getElementById('dashboardClearAll');
                if (markBtn) markBtn.addEventListener('click', async function(e){ e.preventDefault(); try { if (typeof window.markAllNotificationsRead === 'function') { await window.markAllNotificationsRead(); if (typeof window.showToast === 'function') window.showToast('All notifications marked read'); } } catch(err){ console.debug('mark all read failed', err); if (typeof window.showToast === 'function') window.showToast('Unable to mark read'); } });
                if (clearBtn) clearBtn.addEventListener('click', async function(e){ e.preventDefault(); if (!confirm('Clear all notifications?')) return; try { if (typeof window.clearAllNotifications === 'function') { await window.clearAllNotifications(); if (typeof window.showToast === 'function') window.showToast('Notifications cleared'); } } catch(err){ console.debug('clear all failed', err); if (typeof window.showToast === 'function') window.showToast('Unable to clear'); } });
            });
        })();
        </script>
        
        <main class="main-content" id="mainContent">
            <div class="dashboard-content-wrapper">
                <div class="summary-cards">
                    <div class="summary-card completed">
                        <h4><span class="material-icons" style="vertical-align:middle; margin-right:6px; font-size:18px; color:#10b981;">supervisor_account</span>Active Counselors</h4>
                        <p class="number"><span class="num-val"></span><span class="inline-spinner" aria-hidden="true"><svg viewBox="0 0 50 50" aria-hidden="true"><circle cx="25" cy="25" r="18" fill="#ffffff" opacity="0.25"></circle><path fill="#10B981" d="M25 5a20 20 0 0 1 0 6a14 14 0 1 0 0 28 14 14 0 0 1 0-34"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite"/></path></svg></span></p>
                    </div>
                    <div class="summary-card new-patients" id="registeredStudentsCard">
                        <h4><span class="material-icons" style="vertical-align:middle; margin-right:6px; font-size:18px; color:#3b82f6;">school</span>Registered Students</h4>
                        <p class="number"><span class="num-val"></span><span class="inline-spinner" aria-hidden="true"><svg viewBox="0 0 50 50" aria-hidden="true"><circle cx="25" cy="25" r="18" fill="#ffffff" opacity="0.25"></circle><path fill="#3B82F6" d="M25 5a20 20 0 0 1 0 6a14 14 0 1 0 0 28 14 14 0 0 1 0-34"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite"/></path></svg></span></p>
                        <div class="college-breakdown" id="collegeBreakdown">
                            <h5>Students by College</h5>
                            <ul class="college-list" id="collegeList">
                                <!-- College data will be populated by JavaScript -->
                            </ul>
                            <div class="view-more">
                                <button class="view-more-btn" onclick="location.href='admin_user_management.html'">View Full Report</button>
                            </div>
                        </div>
                    </div>
                    <div class="summary-card total">
                        <h4><span class="material-icons" style="vertical-align:middle; margin-right:6px; font-size:18px; color:#f59e0b;">event_note</span>Total Appointments</h4>
                        <p class="number"><span class="num-val"></span><span class="inline-spinner" aria-hidden="true"><svg viewBox="0 0 50 50" aria-hidden="true"><circle cx="25" cy="25" r="18" fill="#ffffff" opacity="0.25"></circle><path fill="#F59E0B" d="M25 5a20 20 0 0 1 0 6a14 14 0 1 0 0 28 14 14 0 0 1 0-34"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite"/></path></svg></span></p>
                    </div>
                    <div class="summary-card pending">
                        <h4><span class="material-icons" style="vertical-align:middle; margin-right:6px; font-size:18px; color:#ef4444;">check_circle</span>Completed Appointments</h4>
                        <p class="number"><span class="num-val"></span><span class="inline-spinner" aria-hidden="true"><svg viewBox="0 0 50 50" aria-hidden="true"><circle cx="25" cy="25" r="18" fill="#ffffff" opacity="0.25"></circle><path fill="#EF4444" d="M25 5a20 20 0 0 1 0 6a14 14 0 1 0 0 28 14 14 0 0 1 0-34"><animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="1s" repeatCount="indefinite"/></path></svg></span></p>
                    </div>
                    
                </div>
                <div class="chart-section">
                    <div class="monthly-trends">
                        <h3><span class="material-icons small-icon" style="color:#10b981;">calendar_month</span>Monthly Appointment Trends</h3>
                        <div class="chart-container">
                            <canvas id="monthlyChart">0</canvas>
                        </div>
                    </div>
                    <div class="weekly-trends">
                        <h3><span class="material-icons small-icon" style="color:#f59e0b;">trending_up</span>Weekly Appointment Trends</h3>
                        <div class="chart-container">
                            <canvas id="weeklyChart">0</canvas>
                        </div>
                    </div>
                </div>
                    <div class="counselor-breakdown" id="counselorBreakdownContainer" style="margin-top:18px;">
                        <h3 style="margin:0 0 10px 0;color:#4a5568;font-size:16px;">Appointments by Counselor</h3>
                        <div style="background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:12px;"> 
                            <ul id="counselorList" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;max-height:220px;overflow:auto">
                                <li style="color:#718096;padding:8px;text-align:center">Loading...</li>
                            </ul>
                        </div>
                    </div>

                    <div class="bottom-section">
                    <div class="recent-activity">
                        <h3>Recent System Activity <a href="#" class="view-all" id="recentViewAll">View All</a></h3>
                        <ul class="activity-list" id="activityList">
                            <li style="display:flex;gap:12px;align-items:center;padding:12px;border-radius:8px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,0.06);">
                                <span style="width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:8px;background:#f3f4f6;flex:0 0 40px;">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="2" fill="#90caf9"/><circle cx="8" cy="8" r="2" fill="#fff"/><path d="M21 21L15 13L9 21H21Z" fill="#fff"/></svg>
                                </span>
                                <div style="flex:1;display:flex;flex-direction:column;">
                                    <span style="font-weight:600;">Uploaded file Evaluation_Fradejas.png (Featured Resources)</span>
                                    <span style="font-size:12px;color:#888;">Dec 8, 2025, 05:55 PM</span>
                                </div>
                            </li>
                        </ul>
                        <!-- Local persistent activity list (used by client-side logger). This is rendered
                             separately so server-side updates that replace #activityList won't remove local entries. -->
                        <ul class="local-activity-list" id="activityListLocal">
                            <!-- local items will be rendered by client-side logger -->
                        </ul>
                        <ul class="appointment-list" id="appointmentList" style="display:none"></ul>
                    </div>
                    <div class="quick-actions" id="quickActionsContainer">
                        <h3>Quick Admin Actions</h3>
                        <div class="qa-arrow" id="qaArrow" aria-hidden="true"></div>
                        <button class="action-btn add-counselor" id="addCounselorBtn">
                            <span class="material-icons">person_add</span>
                            Add Counselor
                        </button>
                        <button class="action-btn manage-student" id="manageStudentBtn">
                            <span class="material-icons">groups</span>
                            Manage Student
                        </button>
                        <button class="action-btn settings" id="settingsBtn">
                            <span class="material-icons">settings</span>
                            Settings
                        </button>
                        <button class="action-btn view-profile" id="viewProfileBtn">
                            <span class="material-icons">account_circle</span>
                            View Profile
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Confirm modal for logout -->
    <div id="confirmModalLogout" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;z-index:3000">
        <div style="background:#fff;border-radius:12px;padding:18px;max-width:420px;width:92%;box-shadow:0 12px 40px rgba(2,6,23,0.2)">
            <h3 id="confirmModalLogoutTitle" style="margin:0 0 8px 0;font-size:16px;font-weight:700">Confirm</h3>
            <div id="confirmModalLogoutMessage" style="font-size:15px;margin-bottom:12px;color:#111">Are you sure you want to sign out?</div>
            <div style="display:flex;gap:8px;justify-content:flex-end">
                <button id="confirmModalLogoutCancel" style="background:#6c757d;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer">Cancel</button>
                <button id="confirmModalLogoutOk" style="background:#00723f;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Recent Activity Modal -->
    <div id="recentActivityModal" style="display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;z-index:3050"> 
        <div style="background:#fff;border-radius:12px;padding:16px;max-width:820px;width:94%;max-height:80vh;overflow:auto;box-shadow:0 20px 60px rgba(2,6,23,0.3);">
            <div style="display:flex;align-items:center;margin-bottom:8px;">
                <h3 style="margin:0;font-size:16px;font-weight:700">Recent System Activity</h3>
            </div>
            <div id="recentActivityModalList" style="display:flex;flex-direction:column;gap:10px;">
                <div style="color:#718096;padding:8px;text-align:center">Loading...</div>
            </div>
            <div style="margin-top:12px;text-align:right">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <button id="recentActivityModalDeleteBtn" style="background:#ef4444;color:#fff;border:0;padding:8px 16px;border-radius:8px;cursor:pointer;margin-right:8px;">Delete</button>
                        <button id="recentActivityModalOkBtn" style="background:#22c55e;color:#fff;border:0;padding:8px 16px;border-radius:8px;cursor:pointer;display:none;">OK</button>
                    </div>
                    <button id="recentActivityModalCloseBtn" style="background:#ef4444;color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { requireAdminAuth, fetchCounselors, db, ref, get, set, getDatabase } from './admin_main.js';
        import { loadAdminProfileInto, startGreetingClock } from './admin_profile_loader.js';
        
        // Ensure only authenticated admins can access this page
        requireAdminAuth();

        // Centralized loader: populate greeting & avatar (use consistent selector)
        loadAdminProfileInto({ greetingSelector: '#topGreetingName', avatarSelector: '#profileBtn', timeSelector: '#topGreetingTime' });
        startGreetingClock('#topGreetingName', '#topGreetingTime');

        

        // Global variables for appointment data
        let appointments = [];
        let totalAppointments = 0;
        let completedAppointments = 0;
        let pendingAppointments = 0;
        let newPatients = 0;
        let activeCounselors = 0;

        // Initialize charts with proper data and responsive settings
        function initializeCharts() {
            // Monthly Chart
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            const monthlyChart = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Appointments',
                        data: new Array(12).fill(0), // Initialize with zeros
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16,185,129,0.12)',
                        borderWidth: 3,
                        pointBackgroundColor: '#10b981',
                        pointBorderColor: '#ffffff',
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointHoverBorderColor: '#10b981',
                        pointHoverBorderWidth: 3,
                        fill: true,
                        tension: 0.35
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Monthly Appointments',
                            color: '#111827',
                            font: {
                                size: 16,
                                weight: '600'
                            },
                            padding: {
                                top: 6,
                                bottom: 8
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                boxWidth: 20,
                                usePointStyle: true,
                                color: '#374151',
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1f2937',
                            bodyColor: '#374151',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            padding: 12,
                            boxPadding: 6,
                            usePointStyle: true
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Month',
                                color: '#374151',
                                font: { size: 12, weight: '600' }
                            },
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: 12
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Appointments',
                                color: '#374151',
                                font: { size: 12, weight: '600' }
                            },
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(229, 231, 235, 0.8)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: {
                                    size: 11
                                },
                                padding: 8
                            }
                        }
                      }
                    }
                });
            // Weekly Chart
            const weeklyCtx = document.getElementById('weeklyChart').getContext('2d');
            const weeklyChart = new Chart(weeklyCtx, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
                    datasets: [{
                        label: 'Appointments',
                        data: new Array(5).fill(0), // Initialize with zeros
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.8)', // Mon
                            'rgba(245, 158, 11, 0.8)',  // Tue
                            'rgba(16, 185, 129, 0.8)', // Wed
                            'rgba(245, 158, 11, 0.8)', // Thu
                            'rgba(16, 185, 129, 0.8)'  // Fri
                        ],
                        borderColor: [
                            '#10b981',
                            '#f59e0b',
                            '#10b981',
                            '#f59e0b',
                            '#10b981'
                        ],
                        borderWidth: 1,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Weekly Appointments',
                            color: '#111827',
                            font: {
                                size: 16,
                                weight: '600'
                            },
                            padding: {
                                top: 6,
                                bottom: 8
                            }
                        },
                        legend: { 
                            display: false 
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1f2937',
                            bodyColor: '#374151',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return `Appointments: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Day of Week',
                                color: '#374151',
                                font: { size: 12, weight: '600' }
                            },
                            grid: { 
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: '#374151',
                                font: { 
                                    weight: 'bold', 
                                    size: 13 
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Appointments',
                                color: '#374151',
                                font: { size: 12, weight: '600' }
                            },
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(229, 231, 235, 0.8)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#6b7280',
                                font: { 
                                    size: 12 
                                },
                                padding: 8,
                                stepSize: 2
                            }
                        }
                    }
                }
            });

            // Store charts globally for updates
            window.monthlyChart = monthlyChart;
            window.weeklyChart = weeklyChart;

            return { monthlyChart, weeklyChart };
        }

        // Function to process appointment data and update charts
        // Process appointment data and update charts
        // Now accepts an optional `year` parameter and will only count appointments whose
        // parsed date falls within that year. Defaults to the current year to avoid
        // mixing older data (different years) into the same monthly series.
        function processAppointmentDataForCharts(appointments, year = (new Date()).getFullYear()) {
            const monthlyCounts = new Array(12).fill(0);
            const weeklyCounts = new Array(5).fill(0); // Monday to Friday

            // Defensive counters for debugging
            let skippedInvalidDates = 0;
            let skippedDifferentYear = 0;

            appointments.forEach(appointment => {
                try {
                    // Parse date from appointment data. Accept numbers (timestamps) or strings.
                    const dateStr = appointment && (appointment.date || appointment.Date || appointment.datetime || appointment.timestamp);
                    if (!dateStr && (typeof appointment === 'number' || appointment instanceof Number)) {
                        // direct numeric timestamp
                    }

                    let date = null;
                    if (typeof dateStr === 'number') {
                        date = new Date(dateStr);
                    } else if (typeof dateStr === 'string') {
                        // Prefer ISO-like YYYY-MM-DD(THH:MM:SS) parsing; try to normalize
                        const isoLike = dateStr.trim();
                        // If it's YYYY-MM or YYYY-MM-DD etc, new Date should handle it; still check
                        date = new Date(isoLike);
                    } else if (dateStr instanceof Date) {
                        date = dateStr;
                    }

                    if (!date || isNaN(date.getTime())) {
                        skippedInvalidDates++;
                        return; // skip invalid dates
                    }

                    // Only include appointments that match the requested year
                    if (date.getFullYear() !== Number(year)) {
                        skippedDifferentYear++;
                        return;
                    }

                    // Update monthly counts (0 = January, 11 = December)
                    const month = date.getMonth();
                    monthlyCounts[month] = (monthlyCounts[month] || 0) + 1;

                    // Update weekly counts (0 = Monday, 4 = Friday)
                    const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Monday to Friday
                        weeklyCounts[dayOfWeek - 1] = (weeklyCounts[dayOfWeek - 1] || 0) + 1;
                    }
                } catch (error) {
                    console.warn('Error processing appointment date:', error);
                }
            });

            // Update charts if they exist
            if (window.monthlyChart) {
                window.monthlyChart.data.datasets[0].data = monthlyCounts;
                window.monthlyChart.options.plugins.title.text = `Monthly Appointments (${year})`;
                window.monthlyChart.update();
            }

            if (window.weeklyChart) {
                window.weeklyChart.data.datasets[0].data = weeklyCounts;
                window.weeklyChart.update();
            }

            // Small debug log so you can see why months might be empty
            if (skippedInvalidDates || skippedDifferentYear) {
                console.debug('processAppointmentDataForCharts skipped', { skippedInvalidDates, skippedDifferentYear, year });
            }

            return { monthlyCounts, weeklyCounts };
        }

        // Small helper to show the data source (live/demo) on the page when fetches fail
        function setDataSourceIndicator(text, title) {
                    // Disabled: do not show data source indicator in the top bar.
                    // Calls remain in place but this function intentionally does nothing.
                    return;
        }

        // Load live summary counts from Firebase Realtime Database and update cards
        async function loadDashboardStats() {
            // per-card spinner logic removed: no loading class or aria-busy will be added
            try {
                // Active counselors
                let counselorsCount = 0;
                try {
                    const c = await fetchCounselors();
                    if (c && typeof c === 'object') counselorsCount = Object.keys(c).length;
                } catch (e) {
                    console.warn('fetchCounselors failed', e);
                }

                // Registered students - with college breakdown
                let studentsCount = 0;
                let collegeData = {};
                try {
                    const dbRef = typeof ref === 'function' ? ref(db, 'students') : null;
                    if (dbRef && typeof get === 'function') {
                        const snap = await get(dbRef);
                        if (snap && snap.exists && snap.exists()) {
                            const val = snap.val() || {};
                            studentsCount = Object.keys(val).length;
                            
                            // Count students by college
                            collegeData = {};
                            Object.values(val).forEach(student => {
                                const college = student.college || student.department || student.faculty || 'Undefined';
                                collegeData[college] = (collegeData[college] || 0) + 1;
                            });
                        }
                    }
                } catch (e) {
                    console.warn('students fetch failed', e);
                }

                // Appointments data - only use live DB data (no demo fallback)
                let totalAppts = 0;
                let completedAppts = 0;
                let items = [];
                let usedLiveData = false; // set true when we successfully read live appointments
                
                try {
                    // Try multiple possible DB paths in sequence. Collect per-path errors but continue.
                    const pathsToTry = ['appointments_by_counselor', 'appointments_by_student', 'appointments'];
                    const pathErrors = {};

                    for (const path of pathsToTry) {
                        try {
                            const pRef = typeof ref === 'function' ? ref(db, path) : null;
                            if (!pRef || typeof get !== 'function') {
                                pathErrors[path] = 'ref/get not available';
                                continue;
                            }

                            const snap = await get(pRef);
                            if (snap && snap.exists && snap.exists()) {
                                const val = snap.val() || {};
                                console.log(`Found data at ${path}`);

                                // Normalize nested structure into a flat array of appointment objects
                                const collected = [];
                                Object.values(val).forEach(group => {
                                    if (!group) return;
                                    if (Array.isArray(group)) {
                                        group.forEach(a => { if (a && (a.date || a.created_at || a.booking_timestamp)) collected.push(a); });
                                    } else if (typeof group === 'object') {
                                        Object.values(group).forEach(a => { if (a && (a.date || a.created_at || a.booking_timestamp)) collected.push(a); });
                                    }
                                });

                                if (collected.length > 0) {
                                    items = collected;
                                    totalAppts = items.length;
                                    // Count completed
                                    completedAppts = 0;
                                    items.forEach(a => { try { const s = (a && (a.status || '') || '').toString().toLowerCase(); if (s === 'completed' || s.indexOf('complete') !== -1) completedAppts++; } catch(e){} });
                                    usedLiveData = true;
                                    // annotate which path we used
                                    try { setDataSourceIndicator(`Live (current) â€” ${path}`, 'Data'); } catch(e){}
                                    console.log(`Using appointments from ${path}, count=${items.length}`);
                                    break; // stop trying other paths
                                } else {
                                    // found node but nothing inside
                                    pathErrors[path] = 'empty';
                                }
                            } else {
                                pathErrors[path] = 'no-node-or-empty';
                            }
                        } catch (perr) {
                            console.warn(`Error reading ${path}:`, perr);
                            pathErrors[path] = perr && perr.message ? perr.message : String(perr);
                        }
                    }

                    if (!usedLiveData) {
                        console.log('No live appointment data found. Path errors:', pathErrors);
                        // Do not use demo data; leave items empty and set indicator
                        items = [];
                        totalAppts = 0;
                        completedAppts = 0;
                        // If any path error looks like permission denied, prefer that message
                        const allErrStr = Object.values(pathErrors).join(' | ');
                        if (/permission/i.test(allErrStr)) setDataSourceIndicator('No live data (permission denied)', 'Data');
                        else setDataSourceIndicator('No live data', 'Data');
                    }
                } catch (e) {
                    console.error('appointments fetch top-level error', e);
                    items = [];
                    totalAppts = 0;
                    completedAppts = 0;
                    usedLiveData = false;
                    try {
                        const reason = (e && e.message) ? e.message : String(e);
                        if (/permission/i.test(reason)) setDataSourceIndicator('No live data (permission denied)', 'Data');
                        else setDataSourceIndicator('No live data (error)', 'Data');
                    } catch (err) { console.debug(err); }
                }

                // Process appointment data for charts
                if (items && Array.isArray(items)) {
                    processAppointmentDataForCharts(items);
                    
                    // Update counselor breakdown with actual data
                    const counselorCounts = {};
                    items.forEach(appt => {
                        const counselorName = appt.counselor_name || appt.counselorName || 'Unknown Counselor';
                        counselorCounts[counselorName] = (counselorCounts[counselorName] || 0) + 1;
                    });
                    updateAppointmentsByCounselor(counselorCounts);
                }

                // Update globals
                totalAppointments = totalAppts || 0;
                completedAppointments = completedAppts || 0;
                pendingAppointments = Math.max(0, totalAppointments - completedAppointments);
                newPatients = studentsCount || 0;
                activeCounselors = counselorsCount || 0;

                updateSummaryCards();
                // mark stats loaded so subsequent calls don't show spinners unnecessarily
                try { window._dashboardStatsLoaded = true; } catch(e) { /* ignore */ }
                updateCollegeBreakdown(collegeData);
                
                console.log('Dashboard stats loaded:', {
                    totalAppointments,
                    completedAppointments,
                    pendingAppointments,
                    newPatients,
                    activeCounselors
                });
                // Indicate live data and year used (or no live data)
                try {
                   
                } catch(e){}
                
            } catch (err) {
                console.error('loadDashboardStats error', err);
                // If permission denied or other DB error, show a small indicator and use demo data
               // Do not load demo data. Clear charts and counts instead.
                try {
                    processAppointmentDataForCharts([]);
                    updateAppointmentsByCounselor({});
                    totalAppointments = 0;
                    completedAppointments = 0;
                    pendingAppointments = 0;
                    newPatients = 0;
                    activeCounselors = 0;
                    updateSummaryCards();
                } catch(e) { console.debug('Failed to clear UI after load error', e); }
            } finally {
                try { document.querySelectorAll('.summary-card').forEach(c => { c.classList.remove('loading'); c.removeAttribute('aria-busy'); }); } catch(e) { console.debug('final hide card spinners failed', e); }
            }
        }

        // Demo data generator for development
        function generateDemoAppointments() {
            const demoAppointments = [];
            const statuses = ['Completed', 'Pending', 'Missed'];
            const counselors = ['Mary Joy Ermino', 'John Smith', 'Sarah Johnson'];
            const months = ['2025-01', '2025-02', '2025-03', '2025-04', '2025-05', '2025-06', '2025-07', '2025-08', '2025-09', '2025-10', '2025-11'];
            
            // Generate appointments for different months
            for (let i = 0; i < 60; i++) {
                const monthIndex = Math.floor(Math.random() * months.length);
                const day = Math.floor(Math.random() * 28) + 1;
                const dateStr = `${months[monthIndex]}-${day.toString().padStart(2, '0')}`;
                
                demoAppointments.push({
                    date: dateStr,
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    counselor_name: counselors[Math.floor(Math.random() * counselors.length)],
                    student_name: `Student ${i + 1}`,
                    concern: `Consultation ${i + 1}`
                });
            }
            
            return demoAppointments;
        }

        

        // Function to update college breakdown
        function updateCollegeBreakdown(collegeData) {
            const collegeList = document.getElementById('collegeList');
            if (!collegeList) return;

            collegeList.innerHTML = '';

            if (Object.keys(collegeData).length === 0) {
                collegeList.innerHTML = '<li style="text-align:center; color:#718096; padding:10px;">No college data available</li>';
                return;
            }

            // Sort colleges by count (descending)
            const sortedColleges = Object.entries(collegeData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5); // Show top 5 colleges

            sortedColleges.forEach(([college, count]) => {
                const listItem = document.createElement('li');
                listItem.className = 'college-item';
                listItem.innerHTML = `
                    <span class="college-name">${college}</span>
                    <span class="college-count">${count}</span>
                `;
                collegeList.appendChild(listItem);
            });

            // Show total count of other colleges if there are more than 5
            const totalColleges = Object.keys(collegeData).length;
            if (totalColleges > 5) {
                const otherCount = totalColleges - 5;
                const otherItem = document.createElement('li');
                otherItem.className = 'college-item';
                otherItem.innerHTML = `
                    <span class="college-name">Other colleges</span>
                    <span class="college-count">${otherCount}</span>
                `;
                collegeList.appendChild(otherItem);
            }
        }

        // Function to update appointments by counselor
        function updateAppointmentsByCounselor(counselorData) {
            const list = document.getElementById('counselorList');
            if (!list) return;
            list.innerHTML = '';

            const entries = Object.entries(counselorData || {});
            if (entries.length === 0) {
                list.innerHTML = '<li style="text-align:center; color:#718096; padding:10px;">No appointment data available</li>';
                return;
            }

            // Sort descending and show top 6 (others collapsed)
            const sorted = entries.sort((a,b) => b[1] - a[1]);
            const top = sorted.slice(0,6);

            top.forEach(([counselor, count]) => {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                li.style.padding = '6px 8px';
                li.style.borderBottom = '1px solid #f3f4f6';
                li.innerHTML = `<span style="color:#374151;font-weight:600">${counselor}</span><span style="background:#eef2ff;color:#1e3a8a;padding:4px 8px;border-radius:12px;font-weight:700">${count}</span>`;
                list.appendChild(li);
            });

            if (sorted.length > 6) {
                const others = sorted.slice(6).reduce((s, [_k,v]) => s + v, 0);
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                li.style.padding = '6px 8px';
                li.innerHTML = `<span style="color:#6b7280">Other counselors</span><span style="background:#f3f4f6;color:#374151;padding:4px 8px;border-radius:12px;font-weight:700">${others}</span>`;
                list.appendChild(li);
            }
        }

        // Toggle college breakdown visibility
        function setupCollegeBreakdownToggle() {
            const studentsCard = document.getElementById('registeredStudentsCard');
            const breakdown = document.getElementById('collegeBreakdown');

            if (studentsCard && breakdown) {
                studentsCard.addEventListener('click', function(e) {
                    // Don't toggle if clicking on the view more button
                    if (e.target.closest('.view-more-btn')) return;
                    
                    this.classList.toggle('expanded');
                });

                // Close breakdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!studentsCard.contains(e.target)) {
                        studentsCard.classList.remove('expanded');
                    }
                });
            }
        }

        function updateSummaryCards() {
            // Helper to find element by trying multiple possible class variants
            function findCardNumber(selectors) {
                for (const sel of selectors) {
                    const el = document.querySelector(sel + ' .number');
                    if (el) return el;
                }
                return null;
            }

            const totalEl = findCardNumber(['.summary-card.total', '.summary-card.total-appointments', '.summary-card:nth-child(3)']);
            const completedEl = findCardNumber(['.summary-card.completed', '.summary-card:nth-child(4)']);
            const pendingEl = findCardNumber(['.summary-card.pending', '.summary-card:nth-child(3)']);
            const newPatientsEl = findCardNumber(['.summary-card.new-patients', '.summary-card.registered', '.summary-card:nth-child(2)']);

            // helper to set a number and immediately clear the loading state for that card
            // writes into .num-val and removes the inline spinner when a value is set
            function setNumberAndClear(el, value) {
                if (!el) return;
                try {
                    const numVal = el.querySelector('.num-val') || el;
                    const spinner = el.querySelector('.inline-spinner');
                    if (value === null || value === undefined) {
                        // leave numVal empty so spinner remains
                        try { numVal.textContent = ''; } catch(e){}
                    } else {
                        let text;
                        try {
                            if (typeof value === 'number' && isFinite(value)) text = value.toLocaleString();
                            else text = String(value);
                        } catch(e) { text = String(value); }
                        try { numVal.textContent = text; } catch(e) {}
                        if (spinner && spinner.parentNode) spinner.parentNode.removeChild(spinner);
                    }
                } catch(e) { /* ignore DOM errors */ }
                try { const card = el.closest('.summary-card'); if (card) { card.classList.remove('loading'); card.removeAttribute('aria-busy'); } } catch(e) {}
            }

            if (totalEl) setNumberAndClear(totalEl, totalAppointments);
            if (completedEl) setNumberAndClear(completedEl, completedAppointments);
            if (pendingEl) setNumberAndClear(pendingEl, pendingAppointments);
            if (newPatientsEl) setNumberAndClear(newPatientsEl, newPatients);

            // Update Active Counselors card
            try {
                const allNumberEls = Array.from(document.querySelectorAll('.summary-card .number'));
                for (const el of allNumberEls) {
                    const card = el.closest('.summary-card');
                    if (!card) continue;
                    const h = card.querySelector('h4');
                    if (h && /active\s+counselors/i.test(h.textContent || '')) {
                        setNumberAndClear(el, (typeof activeCounselors === 'number' ? activeCounselors : 0));
                        break;
                    }
                }
            } catch (e) { /* ignore DOM update errors */ }
            // ensure any loading state is cleared after numbers are updated
            try { document.querySelectorAll('.summary-card').forEach(c => c.classList.remove('loading')); } catch(e) { /* ignore */ }
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize charts first
            initializeCharts();
            
            // Then load data and setup other functionality
            loadDashboardStats();
            setupCollegeBreakdownToggle();
        });

        // Add event listener for 'Manage your profile' button
        const accountEditBtn = document.getElementById('accountEdit');
        if (accountEditBtn) accountEditBtn.addEventListener('click', () => { location.href = 'admin_profile.html'; });
        
        // Activity modal removed per request. The 'View All' buttons no longer open a modal.
        document.querySelectorAll('.view-all').forEach(el => el.addEventListener('click', function(e){
            e.preventDefault();
            // No modal to open. Update this behavior if you want View All to navigate
            // to a dedicated page (e.g. location.href = 'recent_activity.html') or
            // expand the inline activity list.
        }));
        
        // Wire quick action buttons to appropriate pages
        const viewProfileBtn = document.getElementById('viewProfileBtn');
        if (viewProfileBtn) viewProfileBtn.addEventListener('click', () => { location.href = 'admin_profile.html'; });
        
        const addCounselorQuickBtn = document.querySelector('.action-btn.add-counselor');
        if (addCounselorQuickBtn) addCounselorQuickBtn.addEventListener('click', () => { location.href = 'admin_counselor_management.html'; });
        
        const manageStudentBtn = document.getElementById('manageStudentBtn');
        if (manageStudentBtn) manageStudentBtn.addEventListener('click', () => { location.href = 'admin_user_management.html'; });
        
        const settingsBtn = document.getElementById('settingsBtn');
        if (settingsBtn) settingsBtn.addEventListener('click', () => { location.href = 'admin_settings.html'; });

        // Pop-forward effect for summary cards on hover
        document.querySelectorAll('.summary-card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                card.classList.add('pop-forward');
            });
            card.addEventListener('mouseleave', function() {
                card.classList.remove('pop-forward');
            });
        });
        
        // **SIDEBAR LOGIC**
        const menuIcon = document.getElementById('menuIcon');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const sidebarTop = document.getElementById('sidebarTop');
        
        // Create overlay for mobile
        const overlay = document.createElement('div');
        overlay.className = 'sidebar-overlay';
        document.body.appendChild(overlay);
        
        // Mobile detection
        function isMobile() {
            return window.innerWidth <= 768;
        }
        
        // Toggle sidebar with mobile responsiveness
        menuIcon.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            if (isMobile()) {
                // Mobile behavior - overlay sidebar
                const isOpen = sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active', isOpen);
                document.body.style.overflow = isOpen ? 'hidden' : '';
            } else {
                // Desktop behavior - collapse sidebar
                const isCollapsed = sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('shifted', isCollapsed);
                sidebarTop.classList.toggle('collapsed', isCollapsed);
            }
        });
        
        // Close mobile sidebar when clicking overlay
        overlay.addEventListener('click', () => {
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        });
        
        // Handle window resize
        window.addEventListener('resize', () => {
            if (!isMobile()) {
                // Reset mobile states when switching to desktop
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
                // Ensure desktop state is consistent
                const isCollapsed = sidebar.classList.contains('collapsed');
                mainContent.classList.toggle('shifted', isCollapsed);
                sidebarTop.classList.toggle('collapsed', isCollapsed);
            } else {
                // Reset desktop states when switching to mobile
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('shifted');
                sidebarTop.classList.remove('collapsed');
            }
        });
        
        // Close mobile sidebar when clicking a menu item
        document.querySelectorAll('.nav-item').forEach(link => {
            link.addEventListener('click', () => {
                if (isMobile()) {
                    // Check if the link is not the current page (to prevent double-click issues)
                    if (!link.classList.contains('active')) {
                        sidebar.classList.remove('mobile-open');
                        overlay.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                }
            });
        });

        // Initialize state for desktop on load
        document.addEventListener('DOMContentLoaded', () => {
            if (!isMobile()) {
                // Default to uncollapsed on desktop 
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('shifted');
                sidebarTop.classList.remove('collapsed');
            }
        });

        // Notification toggling handled by `profile_dropdown.js` via `#notifPanel`.
    </script>
    
    <script>
        // Enhanced fade-in effect for main content and charts
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.classList.add('fade-in');
                }
                
                // Add fade-in to graph containers with staggered timing
                const monthly = document.querySelector('.monthly-trends');
                const weekly = document.querySelector('.weekly-trends');
                
                if (monthly) {
                    setTimeout(function(){ 
                        monthly.classList.add('fade-in'); 
                    }, 300);
                }
                
                if (weekly) {
                    setTimeout(function(){ 
                        weekly.classList.add('fade-in'); 
                    }, 500);
                }
            }, 100);
        });
    </script>
    
    <!-- removed duplicate profile loader import/call to avoid conflicts; initialization is done earlier -->

    <script src="./profile_dropdown.js"></script>

    <script>
        // Populate the dropdown large avatar when profile data is loaded
        function setDropdownProfileAvatar(profile) {
            try {
                const avatarDiv = document.getElementById('profileAvatar');
                if (!avatarDiv) return;
                const photoUrl = (profile && (profile.profileImage || profile.photo_url || profile.photoURL || profile.photo)) || (window.adminProfile && window.adminProfile.profileImage) || '';
                if (photoUrl) {
                    let img = avatarDiv.querySelector('img');
                    if (!img) {
                        img = document.createElement('img');
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'contain';
                        img.style.display = 'block';
                        img.style.transition = 'transform 260ms cubic-bezier(.2,.9,.35,1)';
                        avatarDiv.textContent = '';
                        avatarDiv.appendChild(img);
                    }
                    img.src = photoUrl;
                    img.style.display = 'block';
                } else {
                    const img = avatarDiv.querySelector('img');
                    if (img) { img.src = ''; img.style.display = 'none'; }
                    const initial = (window.adminDisplayName || (profile && (profile.username || profile.fullname)) || 'A').trim().charAt(0).toUpperCase();
                    avatarDiv.textContent = initial;
                }
            } catch (e) { console.debug('setDropdownProfileAvatar error', e); }
        }

        window.addEventListener('adminProfileLoaded', function(e){ setDropdownProfileAvatar(e && e.detail ? e.detail : {}); });
        // In case profile was already loaded earlier
        if (window.adminProfile) setDropdownProfileAvatar(window.adminProfile);
        // Small helper: populate notification timestamp and bind mark-all action
        (function(){
            function formatNow() {
                // Hide timestamp in notification header
                return '';
            }

            function setTimestamp() {
                const el = document.getElementById('notifTimestamp');
                if (!el) return;
                el.textContent = formatNow();
            }

            setTimestamp();
            // refresh timestamp whenever the notif button is clicked (short delay to allow panel open)
            const nb = document.getElementById('notifBtn');
            if (nb) nb.addEventListener('click', function(){ setTimeout(setTimestamp, 50); });

            const mark = document.getElementById('markAllRead');
            if (mark) mark.addEventListener('click', function(e){
                e.preventDefault();
                const status = document.querySelector('.notif-body .notif-status');
                const sub = document.querySelector('.notif-body .notif-sub');
                if (status) status.textContent = 'All notifications are marked as read';
                if (sub) sub.textContent = '';
                const panel = document.getElementById('notifPanel');
                if (panel) {
                    panel.setAttribute('data-open','false');
                    panel.style.display = 'none';
                    panel.style.visibility = 'hidden';
                    panel.style.opacity = '0';
                }
                if (nb) nb.setAttribute('aria-expanded','false');
            });
        })();
    </script>
    <script>
        // Recent Activity modal logic: fetch audit logs and render into modal
        (function(){
            function escapeHtml(s) {
                if (!s) return '';
                return String(s).replace(/[&<>"']/g, function (c) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]; });
            }

            function iconForType(type) {
                if (!type) return 'ðŸ””';
                if (type === 'login') return 'ðŸ”’';
                if (type === 'profile_update') return 'âœï¸';
                if (type === 'password_change') return 'ðŸ”‘';
                if (type === 'password_reset') return 'âœ‰ï¸';
                return 'ðŸ””';
            }

            async function fetchAuditCategory(uid, category) {
                try {
                    const snap = await get(ref(db, `admin_audit_logs/${category}/${uid}`));
                    if (!snap.exists()) return [];
                    const val = snap.val();
                    return Object.keys(val).map(k => Object.assign({ _key: k }, val[k]));
                } catch (err) {
                    console.error('fetchAuditCategory error', category, err);
                    return [];
                }
            }

            function renderModalActivityItems(items) {
                // This function is now unused, but kept for fallback. The modal now clones the actual DOM nodes for perfect match.
            }

            async function loadAllRecentActivity(limit = 200) {
                try {
                    const localListEl = document.getElementById('activityListLocal');
                    const serverListEl = document.getElementById('activityList');
                    const modalList = document.getElementById('recentActivityModalList');
                    if (!modalList) return;
                    modalList.innerHTML = '';
                    // Copy the full HTML of both lists for perfect style match
                    if (serverListEl && serverListEl.innerHTML.trim()) {
                        const serverListClone = document.createElement('ul');
                        serverListClone.className = serverListEl.className;
                        serverListClone.style.cssText = serverListEl.style.cssText;
                        serverListClone.innerHTML = serverListEl.innerHTML;
                        modalList.appendChild(serverListClone);
                    }
                    if (localListEl && localListEl.innerHTML.trim()) {
                        const localListClone = document.createElement('ul');
                        localListClone.className = localListEl.className;
                        localListClone.style.cssText = localListEl.style.cssText;
                        localListClone.innerHTML = localListEl.innerHTML;
                        modalList.appendChild(localListClone);
                    }
                    if (!modalList.hasChildNodes()) {
                        modalList.innerHTML = '<div style="color:#718096;padding:8px;text-align:center">No recent activity</div>';
                    }
                } catch (err) {
                    console.error('loadAllRecentActivity error', err);
                    renderModalActivityItems([]);
                }
            }

            function openModal() {
                const modal = document.getElementById('recentActivityModal');
                if (!modal) return;
                modal.style.display = 'flex';
                try { document.body.style.overflow = 'hidden'; } catch(e){}
            }
            function closeModal() {
                const modal = document.getElementById('recentActivityModal');
                if (!modal) return;
                modal.style.display = 'none';
                try { document.body.style.overflow = ''; } catch(e){}
            }

            document.addEventListener('DOMContentLoaded', function(){
                const viewAll = document.getElementById('recentViewAll');
                if (viewAll) {
                    viewAll.addEventListener('click', function(e){
                        e.preventDefault();
                        openModal();
                        loadAllRecentActivity();
                    });
                }
                const closeBtn = document.getElementById('recentActivityModalClose');
                const closeBtn2 = document.getElementById('recentActivityModalCloseBtn');
                if (closeBtn) closeBtn.addEventListener('click', closeModal);
                if (closeBtn2) closeBtn2.addEventListener('click', closeModal);
                const modal = document.getElementById('recentActivityModal');
                if (modal) {
                    modal.addEventListener('click', function(e){ if (e.target === modal) closeModal(); });
                }
                document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeModal(); });
            });
        })();
    </script>
    <script>
        (function(){
            function attachLogout(){
                const sidebarLogout = document.getElementById('sidebarLogoutBtn');
                if (!sidebarLogout) return;
                if (sidebarLogout._logoutHandlerAttached) return;
                sidebarLogout._logoutHandlerAttached = true;
                const confirmModal = document.getElementById('confirmModalLogout');
                const confirmOk = document.getElementById('confirmModalLogoutOk');
                const confirmCancel = document.getElementById('confirmModalLogoutCancel');
                function doLogout(){
                    const profileLogout = document.getElementById('accountLogout');
                    if (profileLogout) { profileLogout.click(); return; }
                    if (typeof window.signOutAndRedirect === 'function') { window.signOutAndRedirect(); return; }
                    try { localStorage.removeItem('authToken'); } catch(e){}
                    window.location.href = 'login.html';
                }
                sidebarLogout.addEventListener('click', () => {
                    if (!confirmModal || !confirmOk || !confirmCancel) { if (confirm('Are you sure you want to sign out?')) doLogout(); return; }
                    confirmModal.style.display = 'flex';
                    function cleanup(){ confirmModal.style.display = 'none'; confirmOk.removeEventListener('click', onOk); confirmCancel.removeEventListener('click', onCancel); document.removeEventListener('keydown', onKeyDown); }
                    function onOk(){ cleanup(); doLogout(); }
                    function onCancel(){ cleanup(); }
                    function onKeyDown(e){ if (e.key === 'Escape') cleanup(); }
                    confirmOk.addEventListener('click', onOk);
                    confirmCancel.addEventListener('click', onCancel);
                    document.addEventListener('keydown', onKeyDown);
                });
            }
            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attachLogout); else attachLogout();
        })();
    </script>
    <script>
        // Activity logger: appends actions to Recent System Activity card and persists in localStorage
        (function(){
            const STORAGE_KEY = 'admin_recent_activity';
            const MAX_ITEMS = 20;
            function nowISOString(){ return new Date().toISOString(); }
            function formatTimeISO(ts){
                try {
                    const d = new Date(ts);
                    return d.toLocaleString(undefined, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                } catch(e){ return ts; }
            }
            function loadActivities(){
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    if (!raw) return [];
                    const arr = JSON.parse(raw);
                    if (!Array.isArray(arr)) return [];
                    return arr;
                } catch(e){ return []; }
            }
            function saveActivities(arr){
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr.slice(0,MAX_ITEMS)));
                } catch(e){}
            }
            // Helper: detect counselor-related activities
            function isCounselorActivity(text){
                try{ if (!text) return false; return /\bcounselor\b/i.test(String(text)); } catch(e){ return false; }
            }

            // One-time purge: remove counselor entries from persisted activity arrays
            (function purgeCounselorFromStorage(){
                try{
                    const keys = ['admin_recent_activity','recentActivities'];
                    for (const k of keys){
                        try{
                            const raw = localStorage.getItem(k); if (!raw) continue;
                            const arr = JSON.parse(raw); if (!Array.isArray(arr)) continue;
                            const filtered = arr.filter(it => { const txt = (it && it.text) ? it.text : String(it||''); return !isCounselorActivity(txt); });
                            if (filtered.length !== arr.length) localStorage.setItem(k, JSON.stringify(filtered));
                        }catch(e){}
                    }
                }catch(e){}
            })();
            function renderActivities(){
                // Prefer to render local persistent list (`activityListLocal`) when available.
                // Only show the "No recent activity." placeholder if neither localStorage nor
                // server-rendered lists contain items.
                const localListEl = document.getElementById('activityListLocal');
                const serverListEl = document.getElementById('activityList');
                // Filter out only duplicate 'Counselor added' and 'Counselor updated' (not all activities)
                let items = loadActivities();
                // Remove all counselor-related activities from the list entirely
                items = items.filter(it => { const txt = (it && it.text) ? it.text : String(it||''); return !isCounselorActivity(txt); });
                // Only remove duplicates for other activity types; keep latest per text
                const seen = new Set();
                items = items.filter(it => {
                    const txt = it && it.text ? it.text : '';
                    if (txt && seen.has(txt)) return false;
                    seen.add(txt);
                    return true;
                });
                saveActivities(items);

                // Helper to create the empty placeholder
                function appendEmptyPlaceholder(targetEl) {
                    const li = document.createElement('li');
                    li.style.justifyContent = 'center';
                    li.style.color = '#718096';
                    li.style.padding = '14px';
                    targetEl.appendChild(li);
                }

                // Render into local list if present
                if (localListEl) {
                    localListEl.innerHTML = '';
                    if (items && items.length > 0) {
                        // Remove duplicate activities by text and timestamp
                        const seen = new Set();
                        items.forEach(it => {
                            // Skip any counselor-related activities
                            if (it && it.text && isCounselorActivity(it.text)) return;
                            const key = `${it.text}|${formatTimeISO(it.ts || it.t)}`;
                            if (seen.has(key)) return;
                            seen.add(key);
                            const li = document.createElement('li');
                            li.style.display = 'flex';
                            li.style.alignItems = 'flex-start';
                            li.style.gap = '8px';
                            const icon = document.createElement('span');
                            icon.className = 'activity-icon';
                            icon.style.display = 'inline-flex';
                            icon.style.alignItems = 'center';
                            icon.style.marginTop = '2px';
                            if (it.text && (/added|created/i).test(it.text)) {
                                // Plus sign icon for added/created
                                icon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="20" height="20" rx="6" fill="#22c55e"/><path d="M12 7v10M7 12h10" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg>';
                            } else if (it.text && (/download|export/i).test(it.text)) {
                                icon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="20" height="20" rx="6" fill="#22c55e"/><path d="M12 7v6m0 0l-3-3m3 3l3-3" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><rect x="7" y="17" width="10" height="2" rx="1" fill="#fff"/></svg>';
                            } else if (it.text && /uploaded/i.test(it.text)) {
                                icon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="2" fill="#90caf9"/><circle cx="8" cy="8" r="2" fill="#fff"/><path d="M21 21L15 13L9 21H21Z" fill="#fff"/></svg>';
                            } else if (it.text && /updated/i.test(it.text)) {
                                icon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 17.25V21h3.75l11.06-11.06a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0L3 17.25z" fill="#10b981"/><path d="M14.06 7.94l2.34 2.34" stroke="#fff" stroke-width="2"/></svg>';
                            } else if (it.text && (/delete|deleted|removed|trash|garbage/i).test(it.text)) {
                                icon.innerHTML = '<span style="display:inline-flex;align-items:center;justify-content:center;width:40px;height:40px;background:#f7f8fa;border-radius:10px;"><svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="8" y="12" width="16" height="12" rx="3" fill="#ef4444"/><rect x="13" y="6" width="6" height="4" rx="2" fill="#ef4444"/><rect x="6" y="12" width="20" height="3" fill="#b91c1c"/><rect x="12" y="16" width="2" height="6" rx="1" fill="#fff"/><rect x="18" y="16" width="2" height="6" rx="1" fill="#fff"/></svg></span>';
                            } else if (it.text && /interact|interacted/i.test(it.text)) {
                                // Interacted icon
                                icon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="20" height="20" rx="6" fill="#fbbf24"/><path d="M12 8v4l3 3" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="7" stroke="#fff" stroke-width="2"/></svg>';
                            } else {
                                icon.textContent = it.icon || 'ðŸ””';
                            }
                            const content = document.createElement('div');
                            content.className = 'activity-content';
                            content.style.flex = '1';
                            const text = document.createElement('div');
                            text.className = 'activity-text';
                            text.title = it.text;
                            text.textContent = it.text;
                            const t = document.createElement('div');
                            t.className = 'activity-time';
                            t.textContent = formatTimeISO(it.ts || it.t);
                            content.appendChild(text);
                            content.appendChild(t);
                            li.appendChild(icon);
                            li.appendChild(content);
                            localListEl.appendChild(li);
                        });
                        // If server list contains a redundant placeholder, remove it
                        if (serverListEl && serverListEl.children.length > 0) {
                            Array.from(serverListEl.children).forEach(ch => {
                                try { if (ch.textContent && /no recent activity/i.test(ch.textContent)) ch.remove(); } catch(e){ }
                            });
                        }
                        return;
                    }

                    // No local items: only show placeholder if server list is empty too
                    if (serverListEl && serverListEl.children && serverListEl.children.length > 0) {
                        // leave local list empty so server items remain visible below
                        return;
                    }
                    // neither local nor server have items -> show placeholder in local list
                    appendEmptyPlaceholder(localListEl);
                    return;
                }

                // Fallback: no local container, render into server list if available
                const list = serverListEl || document.querySelector('.recent-activity .activity-list');
                if (!list) return;
                list.innerHTML = '';
                if (!items || items.length === 0) {
                    appendEmptyPlaceholder(list);
                    return;
                }
                items.forEach(it => {
                    const li = document.createElement('li');
                    const icon = document.createElement('div');
                    icon.className = 'activity-icon';
                    // Use pencil/edit icon for any 'updated' activity
                    if (it.text && /updated/i.test(it.text)) {
                        icon.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 17.25V21h3.75l11.06-11.06a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0L3 17.25z" fill="#10b981"/><path d="M14.06 7.94l2.34 2.34" stroke="#fff" stroke-width="2"/></svg>';
                    } else if (it.text && it.text.match(/\.png/i) && (/delete|deleted|removed|trash|garbage/i).test(it.text)) {
                        icon.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="7" width="14" height="12" rx="2" fill="#ef4444"/><rect x="9" y="3" width="6" height="3" rx="1.5" fill="#ef4444"/><rect x="3" y="7" width="18" height="2" fill="#b91c1c"/><rect x="8" y="10" width="2" height="6" rx="1" fill="#fff"/><rect x="14" y="10" width="2" height="6" rx="1" fill="#fff"/></svg>';
                    } else if (it.text && it.text.match(/\.png/i)) {
                        icon.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="2" fill="#90caf9"/><circle cx="8" cy="8" r="2" fill="#fff"/><path d="M21 21L15 13L9 21H21Z" fill="#fff"/></svg>';
                    } else if (it.text && (/delete|deleted|removed|trash|garbage/i).test(it.text)) {
                        icon.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="5" y="7" width="14" height="12" rx="2" fill="#ef4444"/><rect x="9" y="3" width="6" height="3" rx="1.5" fill="#ef4444"/><rect x="3" y="7" width="18" height="2" fill="#b91c1c"/><rect x="8" y="10" width="2" height="6" rx="1" fill="#fff"/><rect x="14" y="10" width="2" height="6" rx="1" fill="#fff"/></svg>';
                    } else {
                        icon.textContent = it.icon || 'ðŸ””';
                    }
                    const content = document.createElement('div');
                    content.className = 'activity-content';
                    const text = document.createElement('div');
                    text.className = 'activity-text';
                    text.title = it.text;
                    text.textContent = it.text;
                    const t = document.createElement('div');
                    t.className = 'activity-time';
                    t.textContent = formatTimeISO(it.ts || it.t);
                    content.appendChild(text);
                    content.appendChild(t);
                    li.appendChild(icon);
                    li.appendChild(content);
                    list.appendChild(li);
                });
            }
            function pushActivity(text, opts){
                if (!text) return;
                const items = loadActivities();
                const entry = {
                    text: String(text).trim(),
                    ts: nowISOString(),
                    icon: (opts && opts.icon) || 'ðŸ””'
                };
                // Do not persist counselor-related activities to avoid noise
                if (isCounselorActivity(entry.text)) return;
                items.unshift(entry);
                saveActivities(items);
                renderActivities();
                // flash highlight on recent-activity card
                const card = document.querySelector('.recent-activity');
                if (card) {
                    card.style.boxShadow = '0 12px 36px rgba(16,185,129,0.12)';
                    setTimeout(()=>{ card.style.boxShadow = ''; }, 800);
                }
            }
            // Expose globally so other modules can call
            window.logActivity = pushActivity;

            // Wire common buttons and interactions
            function initWiring(){
                // Quick action buttons
                const btnMap = [
                    ['#addCounselorBtn', 'Added a counselor (quick action)', 'âž•'],
                    ['#manageStudentBtn', 'Opened Student Management', 'ðŸ‘¥'],
                    ['#settingsBtn', 'Opened Settings', 'âš™ï¸'],
                    ['#viewProfileBtn', 'Viewed Profile', 'ðŸ‘¤'],
                    ['#accountEdit', 'Opened profile editor', 'âœï¸'],
                    ['#sidebarLogoutBtn', 'Clicked sign out', 'ðŸšª']
                ];
                btnMap.forEach(([sel, label, icon])=>{
                    const el = document.querySelector(sel);
                    if (!el) return;
                    // Only log quick-action clicks when the element explicitly opts-in via
                    // a `data-activity` attribute. This avoids noisy automatic logging.
                    const activityAttr = el.getAttribute && el.getAttribute('data-activity');
                    if (!activityAttr) return;
                    el.addEventListener('click', function(e){
                        try { pushActivity(activityAttr || label, { icon: el.getAttribute('data-activity-icon') || icon }); } catch(err){ console.debug('logActivity error', err); }
                    });
                });

                // Nav items
                // Do not log simple navigation clicks (these create a lot of noise).
                // Only log navigation actions when an explicit `data-activity` attribute is provided.
                document.querySelectorAll('.nav-item').forEach(nav=>{
                    const activity = nav.getAttribute('data-activity');
                    if (!activity) return; // skip normal nav clicks
                    nav.addEventListener('click', function(e){
                        try { pushActivity(activity, { icon: nav.getAttribute('data-activity-icon') || 'ðŸ“' }); } catch(err) { console.debug('pushActivity nav error', err); }
                    });
                });

                // Summary cards
                document.querySelectorAll('.summary-card').forEach(card=>{
                    card.addEventListener('click', function(e){
                        const titleEl = card.querySelector('h4');
                        const title = titleEl ? titleEl.textContent.trim() : 'Summary card clicked';
                        pushActivity('Interacted with: ' + title, { icon: 'ðŸ“Š' });
                    });
                });

                // View All links: skip logging for the Recent Activity "View All"
                document.querySelectorAll('.view-all').forEach(v=>{
                    // Do not record clicks on the Recent System Activity "View All" link
                    if (v.id === 'recentViewAll') return;
                    v.addEventListener('click', function(e){
                        pushActivity('Clicked View All', { icon: 'ðŸ”Ž' });
                    });
                });

                // Generic delegation for buttons with data-activity attribute (future-proof)
                document.addEventListener('click', function(e){
                    const btn = e.target.closest('[data-activity]');
                    if (!btn) return;
                    const text = btn.getAttribute('data-activity');
                    if (text) pushActivity(text, { icon: btn.getAttribute('data-activity-icon') || 'ðŸ””' });
                }, true);
            }

            // init on DOM ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function(){ renderActivities(); initWiring(); });
            } else {
                renderActivities(); initWiring();
            }

            // allow clearing activities from console for debugging
            window.clearRecentActivities = function(){ try { localStorage.removeItem(STORAGE_KEY); renderActivities(); } catch(e){} };
            // Update the UI when other tabs/windows change the activity storage
            window.addEventListener('storage', function(e){
                try {
                    if (!e || !e.key) return;
                    if (e.key === STORAGE_KEY) renderActivities();
                } catch (err) { console.debug('storage event handler failed', err); }
            });
        })();
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
    const deleteBtn = document.getElementById('recentActivityModalDeleteBtn');
    const okBtn = document.getElementById('recentActivityModalOkBtn');
    if (deleteBtn && okBtn) {
        deleteBtn.onclick = function() {
            // Show checkboxes for all notifications in the modal, including the top two
            const notifList = document.querySelectorAll('#recentActivityModalList li');
            notifList.forEach(li => {
                if (!li.querySelector('.modal-notif-checkbox')) {
                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.className = 'modal-notif-checkbox';
                    cb.style.marginRight = '12px';
                    li.insertBefore(cb, li.firstChild);
                }
            });
            okBtn.style.display = '';
            deleteBtn.style.display = 'none';
        };
        okBtn.onclick = function() {
            // Confirmation dialog (centered, always in front)
            const confirmDiv = document.createElement('div');
            confirmDiv.style.position = 'fixed';
            confirmDiv.style.left = '0';
            confirmDiv.style.top = '0';
            confirmDiv.style.width = '100vw';
            confirmDiv.style.height = '100vh';
            confirmDiv.style.background = 'rgba(0,0,0,0.35)';
            confirmDiv.style.display = 'flex';
            confirmDiv.style.alignItems = 'center';
            confirmDiv.style.justifyContent = 'center';
            confirmDiv.style.zIndex = '9999';
            confirmDiv.innerHTML = `<div style="background:#fff;padding:36px 54px;border-radius:16px;box-shadow:0 4px 32px #0004;text-align:center;max-width:340px;">
                <div style="font-size:20px;font-weight:600;margin-bottom:22px;color:#ef4444;">Confirm Deletion</div>
                <div style="font-size:16px;margin-bottom:22px;color:#222;">Are you sure you want to delete selected notifications?</div>
                <button id="modalConfirmDeleteBtn" style="background:#ef4444;color:#fff;border:none;border-radius:8px;padding:10px 28px;font-size:16px;cursor:pointer;margin-right:14px;">Yes, Delete</button>
                <button id="modalCancelDeleteBtn" style="background:#e5e7eb;color:#333;border:none;border-radius:8px;padding:10px 28px;font-size:16px;cursor:pointer;">Cancel</button>
            </div>`;
            document.body.appendChild(confirmDiv);
            confirmDiv.querySelector('#modalConfirmDeleteBtn').onclick = () => {
                // Delete selected notifications
                const notifList = Array.from(document.querySelectorAll('#recentActivityModalList li'));
                const checkedIdxs = notifList.map((li, idx) => li.querySelector('.modal-notif-checkbox')?.checked ? idx : -1).filter(idx => idx !== -1);
                if (checkedIdxs.length > 0) {
                    // Remove from both keys
                    let activities = JSON.parse(localStorage.getItem('recentActivities') || '[]');
                    let adminActivities = JSON.parse(localStorage.getItem('admin_recent_activity') || '[]');
                    activities = activities.filter((_, idx) => !checkedIdxs.includes(idx));
                    adminActivities = adminActivities.filter((_, idx) => !checkedIdxs.includes(idx));
                    localStorage.setItem('recentActivities', JSON.stringify(activities));
                    localStorage.setItem('admin_recent_activity', JSON.stringify(adminActivities));
                    notifList.forEach((li, idx) => {
                        if (checkedIdxs.includes(idx)) li.remove();
                    });
                    // Update dashboard list
                    if (typeof renderActivities === 'function') renderActivities();
                    // Trigger storage event for other tabs/pages (admin_profile.html)
                    window.dispatchEvent(new StorageEvent('storage', { key: 'recentActivities' }));
                    window.dispatchEvent(new StorageEvent('storage', { key: 'admin_recent_activity' }));
                }
                document.querySelectorAll('.modal-notif-checkbox').forEach(cb => cb.remove());
                okBtn.style.display = 'none';
                deleteBtn.style.display = '';
                confirmDiv.remove();
            };
            confirmDiv.querySelector('#modalCancelDeleteBtn').onclick = () => {
                confirmDiv.remove();
            };
        };
    }
});
    </script>
</body>
</html>